function InCHlib(b){var a=$("#"+b.target).width();this.settings={target:"YourOwnDivId",heatmap:true,dendrogram:true,metadata:false,max_height:800,width:a,heatmap_colors:"Greens",heatmap_font_color:"black",heatmap_part_width:0.7,column_dendrogram:false,independent_columns:true,metadata_colors:"Oranges",highlight_colors:"Reds",highlighted_rows:[],label_color:"#9E9E9E",count_column:false,count_column_colors:"Reds",min_row_height:false,max_row_height:25,max_column_width:100,font:"Arial",values_center:"median",draw_row_ids:false,header_as_heatmap_row:false,header_row_colors:"YlOrB"};this.events={row_onclick:function(d,c){return},row_onmouseover:function(d,c){return},row_onmouseout:function(c){return},dendrogram_node_onclick:function(d,e,c){return},dendrogram_node_highlight:function(c,d){return},dendrogram_node_unhighlight:function(c){return},heatmap_onmouseout:function(c){return},on_zoom:function(c){return},on_unzoom:function(c){return},on_refresh:function(){return},empty_space_onclick:function(c){return}};this.colors={YlGn:{start:{r:255,g:255,b:204},end:{r:35,g:132,b:67}},GnBu:{start:{r:240,g:249,b:232},end:{r:43,g:140,b:190}},BuGn:{start:{r:237,g:248,b:251},end:{r:35,g:139,b:69}},PuBu:{start:{r:241,g:238,b:246},end:{r:5,g:112,b:176}},BuPu:{start:{r:237,g:248,b:251},end:{r:136,g:65,b:157}},RdPu:{start:{r:254,g:235,b:226},end:{r:174,g:1,b:126}},PuRd:{start:{r:241,g:238,b:246},end:{r:206,g:18,b:86}},OrRd:{start:{r:254,g:240,b:217},end:{r:215,g:48,b:31}},Purples2:{start:{r:242,g:240,b:247},end:{r:106,g:81,b:163}},Blues:{start:{r:239,g:243,b:255},end:{r:33,g:113,b:181}},Greens:{start:{r:237,g:248,b:233},end:{r:35,g:139,b:69}},Oranges:{start:{r:254,g:237,b:222},end:{r:217,g:71,b:1}},Reds:{start:{r:254,g:229,b:217},end:{r:203,g:24,b:29}},Greys:{start:{r:247,g:247,b:247},end:{r:82,g:82,b:82}},PuOr:{start:{r:230,g:97,b:1},end:{r:94,g:60,b:153}},BrBG:{start:{r:166,g:97,b:26},end:{r:1,g:133,b:113}},RdBu:{start:{r:202,g:0,b:32},end:{r:5,g:113,b:176}},RdGy:{start:{r:202,g:0,b:32},end:{r:64,g:64,b:64}},BuYl:{start:{r:5,g:113,b:176},end:{r:250,g:233,b:42}},YlOrR:{start:{r:255,g:255,b:178},end:{r:227,g:26,b:28},middle:{r:204,g:76,b:2}},YlOrB:{start:{r:255,g:255,b:212},end:{r:5,g:112,b:176},middle:{r:204,g:76,b:2}},PRGn2:{start:{r:123,g:50,b:148},end:{r:0,g:136,b:55},middle:{r:202,g:0,b:32}},PiYG2:{start:{r:208,g:28,b:139},end:{r:77,g:172,b:38},middle:{r:255,g:255,b:178}},YlGnBu:{start:{r:255,g:255,b:204},end:{r:34,g:94,b:168},middle:{r:35,g:132,b:67}},RdYlBu:{start:{r:215,g:25,b:28},end:{r:44,g:123,b:182},middle:{r:255,g:255,b:178}},RdYlGn:{start:{r:215,g:25,b:28},end:{r:26,g:150,b:65},middle:{r:255,g:255,b:178}},BuWhRd:{start:{r:33,g:113,b:181},middle:{r:255,g:255,b:255},end:{r:215,g:25,b:28}},RdLrBu:{start:{r:215,g:25,b:28},middle:{r:254,g:229,b:217},end:{r:44,g:123,b:182}},RdBkGr:{start:{r:215,g:25,b:28},middle:{r:0,g:0,b:0},end:{r:35,g:139,b:69}},RdLrGr:{start:{r:215,g:25,b:28},middle:{r:254,g:229,b:217},end:{r:35,g:139,b:69}}};this.objects_ref={tooltip_label:new Kinetic.Label({opacity:1,listening:false}),tooltip_tag:new Kinetic.Tag({fill:this.settings.label_color,pointerWidth:10,pointerHeight:10,lineJoin:"round",listening:false}),tooltip_text:new Kinetic.Text({fontFamily:this.settings.font,fontSize:12,padding:8,fill:"white",fontStyle:"bold",listening:false,align:"center",lineHeight:1.2}),row_border:new Kinetic.Line({stroke:"black",strokeWidth:0.5,lineCap:"round",shadowOffset:1,dash:[4,2],listening:false}),row_borders:new Kinetic.Group(),row_node:new Kinetic.Line({stroke:"grey",strokeWidth:"2",lineCap:"sqare",lineJoin:"round",listening:false}),column_node:new Kinetic.Line({stroke:"grey",strokeWidth:"2",lineCap:"sqare",lineJoin:"round",listening:false}),row_node_rect:new Kinetic.Rect({fill:"white",opacity:0}),icon_overlay:new Kinetic.Rect({width:32,height:32,opacity:0}),heatmap_value:new Kinetic.Text({fontFamily:this.settings.font,fill:this.settings.heatmap_font_color,listening:false}),heatmap_line:new Kinetic.Line({lineCap:"butt",value:false}),column_header:new Kinetic.Text({fontFamily:this.settings.font,fontStyle:"bold",fill:"black"}),row_count:new Kinetic.Text({fontSize:14,fontFamily:this.settings.font,fontStyle:"bold",fill:"grey",listening:false}),cluster_border:new Kinetic.Line({stroke:"black",strokeWidth:2,lineJoin:"round",dash:[10,5],listening:false}),cluster_overlay:new Kinetic.Rect({fill:"white",opacity:0.6}),icon:new Kinetic.Path({fill:"grey",scale:1})};$.extend(this.settings,b);this.settings.width=(b.max_width&&b.max_width<a)?b.max_width:this.settings.width;this.settings.heatmap_part_width=(this.settings.heatmap_part_width>0.9)?0.9:this.settings.heatmap_part_width;this.header_height=150;this.footer_height=70;this.dendrogram_heatmap_distance=5;this.heatmap_width=0;this.highlighted_row=null;this.leaves_y_coordinates={};this.rows={}}InCHlib.prototype.read_data=function(a){this.data=a;this.data.header=this.data.data.header;this.data.nodes=this.data.data.nodes};InCHlib.prototype.read_data_from_file=function(b){var a=this;$.ajax({type:"GET",url:b,dataType:"json",success:function(c){a.data=c;a.data.header=a.data.data.feature_names;a.data.nodes=a.data.data.nodes},async:false})};InCHlib.prototype._add_prefix=function(){var a,b;for(a in this.data.nodes){b=[this.settings.target,a].join("#");this.data.nodes[b]=this.data.nodes[a];delete this.data.nodes[a];if("parent" in this.data.nodes[b]){this.data.nodes[b].parent=[this.settings.target,this.data.nodes[b].parent].join("#")}if(this.data.nodes[b]["count"]!=1){this.data.nodes[b].left_child=[this.settings.target,this.data.nodes[b].left_child].join("#");this.data.nodes[b].right_child=[this.settings.target,this.data.nodes[b].right_child].join("#")}}if(this.settings.metadata){for(a in this.data.metadata.nodes){b=[this.settings.target,a].join("#");this.data.metadata.nodes[b]=this.data.metadata.nodes[a];delete this.data.metadata.nodes[a]}}return};InCHlib.prototype._get_root_id=function(a){var b,c;for(b in a){if(!("parent" in a[b])){c=b;break}}return c};InCHlib.prototype._get_dimensions=function(a){var c,b;for(b in a){if(a[b].count==1){c=a[b].features.length;break}else{if(Object.prototype.toString.call(a[b])=="[object Array]"){c=a[b].length;break}}}return c};InCHlib.prototype._get_min_max_middle=function(d){var b;var a=[];var c=[];for(b=0;b<d.length;b++){c=c.concat(d[b])}a.push(Math.min.apply(null,c));a.push(Math.max.apply(null,c));a.push(this._middle2fnc(c));return a};InCHlib.prototype._get_columns_min_max_middle=function(e){var m=this;var b=[];var f,d,k;var a=e[0].length;for(f=0;f<a;f++){b.push([])}for(f=0;f<e.length;f++){for(d=0;d<a;d++){k=e[f][d];if(typeof k!="undefined"){b[d].push(k)}}}var l=[],c,h,n;for(f=0;f<b.length;f++){if(this._is_number(b[f][0])){b[f]=b[f].map(parseFloat);c=Math.min.apply(null,b[f]);h=Math.max.apply(null,b[f]);n=this._middle2fnc(b[f])}else{var g=this._get_hash_object(b[f]);c=0;h=this._hack_size(g)-1;n=h/2;this.categories2numbers[f]=g}l.push([c,h,n])}return l};InCHlib.prototype._get_hash_object=function(d){var a,b=0,c={};for(a=0;a<d.length;a++){if(typeof(c[d[a]])=="undefined"){c[d[a]]=b;b++}}return c};InCHlib.prototype._get_max_length=function(b){var c=b.map(function(d){return(""+d).length});var a=Math.max.apply(Math,c);return a};InCHlib.prototype._get_max_value_length=function(){var a=this.data.nodes;var e=0;var c,b,d;for(c in a){if(a[c].count==1){d=a[c].features;for(b=0;b<d.length;b++){if((""+d[b]).length>e){e=(""+d[b]).length}}}}if(this.settings.metadata){var a=this.data.metadata.nodes;for(c in a){d=a[c];for(b=0;b<d.length;b++){if((""+d[b]).length>e){e=(""+d[b]).length}}}}return e};InCHlib.prototype._preprocess_heatmap_data=function(){var c=[],b,a=0,e,d;for(b in this.data.nodes){d=this.data.nodes[b];if(d.count==1){e=d.features;c.push([b]);c[a].push.apply(c[a],e);if(this.settings.metadata){c[a].push.apply(c[a],this.data.metadata.nodes[b])}a++}}return c};InCHlib.prototype._reorder_heatmap=function(c){var b;this.leaves_y_coordinates={};if(this.ordered_by_index==c){this.heatmap_array.reverse()}else{if(typeof(this.heatmap_array[0][c])=="string"){this.heatmap_array.sort(function(f,e){return(f[c]==null)?-1:(e[c]==null)?1:(f[c]>e[c])?1:(f[c]<e[c])?-1:0})}else{this.heatmap_array.sort(function(f,e){return(f[c]==null)?-1:(e[c]==null)?1:f[c]-e[c]})}}var a=this.pixels_for_leaf;var d=a/2+this.header_height;for(b=0;b<this.heatmap_array.length;b++){this.leaves_y_coordinates[this.heatmap_array[b][0]]=d;d+=a}this.ordered_by_index=c;return};InCHlib.prototype.draw=function(){this._add_prefix();this.dimensions=this._get_dimensions(this.data.nodes);this.zoomed_clusters=[];this.heatmap_array=this._preprocess_heatmap_data();this.data_dimensions=this.dimensions;if(this.settings.metadata){this.metadata_dimensions=this._get_dimensions(this.data.metadata.nodes);this.dimensions=this.data_dimensions+this.metadata_dimensions}else{this.metadata_dimensions=0}if(this.settings.heatmap){this._set_heatmap_settings()}else{this.dimensions=0}if(this.settings.column_dendrogram&&this.heatmap_header){this.footer_height=150}this.stage=new Kinetic.Stage({container:this.settings.target});this.pixels_for_leaf=(this.settings.max_height-this.header_height-this.footer_height)/this.heatmap_array.length;if(this.pixels_for_leaf>this.settings.max_row_height){this.pixels_for_leaf=this.settings.max_row_height}if(this.settings.min_row_height>this.pixels_for_leaf){this.pixels_for_leaf=this.settings.min_row_height}this.settings.height=this.heatmap_array.length*this.pixels_for_leaf+this.header_height+this.footer_height;this.stage.setWidth(this.settings.width);this.stage.setHeight(this.settings.height);this._draw_stage_layer();this._draw_navigation();if(this.settings.dendrogram){this.root_id=this._get_root_id(this.data.nodes);this.distance=this.settings.width-this.heatmap_width-100;this._draw_row_dendrogram(this.root_id);this._draw_heatmap_header();this._draw_heatmap();if(this.settings.column_dendrogram){this.column_root_id=this._get_root_id(this.data.column_dendrogram.nodes);this._draw_column_dendrogram(this.column_root_id)}}else{this.settings.heatmap_part_width=1;this.settings.column_dendrogram=false;this.distance=this._hack_round((this.settings.width-this.heatmap_width)/2);this._reorder_heatmap(0);this.ordered_by_index=0;this._draw_heatmap_header();this._draw_heatmap()}this.highlight_rows(this.settings.highlighted_rows)};InCHlib.prototype._draw_row_dendrogram=function(e){this.dendrogram_layer=new Kinetic.Layer();var d=this.data.nodes[e];var c=d.count;this.distance_step=this.distance/d.distance;this.last_highlighted_cluster=null;this.nodes_y_coordinates={};this.leaves_y_coordinates={};this.objects2leaves={};this.pixels_for_leaf=(this.settings.max_height-this.header_height-this.footer_height)/c;if(this.pixels_for_leaf>this.settings.max_row_height){this.pixels_for_leaf=this.settings.max_row_height}if(this.settings.min_row_height>this.pixels_for_leaf){this.pixels_for_leaf=this.settings.min_row_height}this.settings.height=c*this.pixels_for_leaf+this.header_height+this.footer_height;this.stage.setWidth(this.settings.width);this.stage.setHeight(this.settings.height);var f=0;var a=0;var g=this.header_height+this.pixels_for_leaf/2;if(d.count>1){f=this.data.nodes[d.left_child].count;a=this.data.nodes[d.right_child].count}this._draw_row_dendrogram_node(e,d,f,a,0,g);this.middle_item_count=(this.min_item_count+this.max_item_count)/2;this._draw_distance_scale(d.distance);this.stage.add(this.dendrogram_layer);this.dendrogram_overlay_layer=new Kinetic.Layer();this.stage.add(this.dendrogram_overlay_layer);this.dendrogram_hover_layer=new Kinetic.Layer();this.stage.add(this.dendrogram_hover_layer);var b=this;this.dendrogram_layer.on("mouseover",function(h){b._dendrogram_layers_mouseover(h)});this.dendrogram_overlay_layer.on("mouseover",function(h){b._dendrogram_layers_mouseover(h)});this.dendrogram_layer.on("mouseout",function(h){b._dendrogram_layers_mouseout(h)});this.dendrogram_overlay_layer.on("mouseout",function(h){b._dendrogram_layers_mouseout(h)});this.dendrogram_layer.on("click",function(h){b._dendrogram_layers_click(h,this)});this.dendrogram_overlay_layer.on("click",function(h){b._dendrogram_layers_click(h,this)});this.dendrogram_layer.on("dblclick",function(h){if(h.targetNode.attrs.path_id!=b.root_id){b._zoom_cluster(h.targetNode.attrs.path_id)}})};InCHlib.prototype._draw_row_dendrogram_node=function(s,o,f,j,m,k){if(o.count!=1){this.nodes_y_coordinates[s]=k;var g=this._get_node_neighbourhood(o,this.data.nodes);var e=this.data.nodes[o.right_child];var n=this.data.nodes[o.left_child];var d=this._get_y1(g,f,j);var c=this._get_y2(g,f,j);var r=this._hack_round(this.distance-this.distance_step*o.distance);r=(r==0)?2:r;var q=r;var b=this.distance-this.distance_step*this.data.nodes[o.left_child].distance;var l=this.distance-this.distance_step*this.data.nodes[o.right_child].distance;if(e.count==1){c=c+this.pixels_for_leaf/2}this.dendrogram_layer.add(this._draw_horizontal_path(s,r,d,q,c,b,l));this._draw_row_dendrogram_node(o.left_child,n,f-g.left_node.right_count,j+g.left_node.right_count,b,d);this._draw_row_dendrogram_node(o.right_child,e,f+g.right_node.left_count,j-g.right_node.left_count,l,c)}else{var p;var a=o.objects;this.leaves_y_coordinates[s]=k;for(p=0;p<a.length;p++){this.objects2leaves[a[p]]=s}var h=o.objects.length;if(h<this.min_item_count){this.min_item_count=h}if(h>this.max_item_count){this.max_item_count=h}}};InCHlib.prototype._draw_stage_layer=function(){this.stage_layer=new Kinetic.Layer();var b=new Kinetic.Rect({x:0,y:0,width:this.settings.width,height:this.settings.height,opacity:0});this.stage_layer.add(b);b.moveToBottom();this.stage.add(this.stage_layer);var a=this;this.stage_layer.on("click",function(c){a.unhighlight_cluster();a.events.empty_space_onclick(c)})};InCHlib.prototype._draw_column_dendrogram=function(c){this.column_dendrogram_layer=new Kinetic.Layer();var b=this.data.column_dendrogram.nodes[c];this.vertical_distance=(this.settings.header_as_heatmap_row)?this.header_height-18:this.header_height-5;this.vertical_distance_step=this.vertical_distance/b.distance;var d=this.data.column_dendrogram.nodes[b.left_child].count;var a=this.data.column_dendrogram.nodes[b.right_child].count;this._draw_column_dendrogram_node(c,b,d,a,0,0);this.stage.add(this.column_dendrogram_layer)};InCHlib.prototype._delete_all_layers=function(){this.stage.destroyChildren()};InCHlib.prototype._set_heatmap_settings=function(){var g,e,a,c;this.header=[];for(g=0;g<this.dimensions;g++){this.header.push("")}this.heatmap_header=false;this.metadata_header=false;this.current_label=null;this.categories2numbers={};if(this.data.header&&this.data.header.length>0){this.heatmap_header=this.data.header;for(g=0;g<this.data_dimensions;g++){this.header[g]=this.heatmap_header[g]}if(this.heatmap_header.length>0&&this.settings.header_as_heatmap_row){var b=[];for(g=0;g<this.heatmap_header.length;g++){b.push([this.heatmap_header[g]])}this.header_min_max=this._get_columns_min_max_middle(b)[0];if(this.categories2numbers[0]){this.categories2numbers.header=this.categories2numbers[0]}var h=[];for(var g=0;g<this.heatmap_header.length;g++){h.push("")}this.data.nodes.header_row={features:h}}}else{this.settings.header_as_heatmap_row=false}var f=[];for(g in this.data.nodes){c=this.data.nodes[g];if(c.count==1){f.push(c.features)}}if(this.settings.independent_columns){this.columns_min_max=this._get_columns_min_max_middle(f)}else{var d=this._get_min_max_middle(f);this.max_value=d[1];this.min_value=d[0];this.middle_value=d[2]}if(this.settings.metadata){if(this.data.metadata.feature_names){this.metadata_header=this.data.metadata.feature_names;for(g=0;g<this.metadata_dimensions;g++){this.header[this.data_dimensions+g]=this.metadata_header[g]}}var k=[];for(g in this.data.metadata.nodes){k.push(this.data.metadata.nodes[g])}this.metadata_columns_min_max=this._get_columns_min_max_middle(k)}if(this.settings.count_column){this.max_item_count=1;this.min_item_count=1;this.dimensions++;this.header.push("Count")}if(!(this.heatmap_header||this.metadata_header)&&!(this.settings.count_column)){this.header=false}this.settings.heatmap_part_width=this.dimensions?this.settings.heatmap_part_width:0;this.heatmap_width=this.dimensions?this._hack_round(this.settings.heatmap_part_width*(this.settings.width-100)):0;this.pixels_for_dimension=this.dimensions?this.heatmap_width/this.dimensions:0;if(this.settings.max_column_width&&this.settings.max_column_width<this.pixels_for_dimension){this.pixels_for_dimension=this.settings.max_column_width;this.heatmap_width=this.dimensions*this.pixels_for_dimension}this.features={};for(g=0;g<this.dimensions;g++){this.features[g]=1}};InCHlib.prototype._set_on_features=function(){this.on_features=[];this.on_metadata_features=[];for(var a in this.features){if(this.features[a]==1){if(a<this.data_dimensions){this.on_features.push(parseInt(a))}else{if(!this.settings.count_column||parseInt(a)<this.dimensions-1){this.on_metadata_features.push(parseInt(a)-this.data_dimensions)}}}}};InCHlib.prototype._draw_heatmap=function(){if(!this.settings.heatmap||this.dimensions==0){return}var f,h,a,b,d,e,k;this.heatmap_layer=new Kinetic.Layer();this.heatmap_overlay=new Kinetic.Layer();this.current_draw_values=true;this.max_value_length=this._get_max_value_length();this.value_font_size=this._get_font_size(this.max_value_length,this.pixels_for_dimension,this.pixels_for_leaf,12);if(this.value_font_size<4){this.current_draw_values=false}this._set_on_features();var c=this._hack_round(this.distance+this.dendrogram_heatmap_distance);var j=[];var l=this;for(f in this.leaves_y_coordinates){var g=this.leaves_y_coordinates[f];h=this._draw_heatmap_row(f,c,g);this.rows[f]=h;this.heatmap_layer.add(h);j.push([f,g]);this._bind_row_events(h)}if(this.settings.header_as_heatmap_row){h=this._draw_header_row(c);this.rows.header_row=h;this.heatmap_layer.add(h);this._bind_row_events(h)}if(this.settings.draw_row_ids){this._draw_row_ids(j)}this.stage.add(this.heatmap_layer);this.stage.add(this.heatmap_overlay);this.highlighted_rows_layer=new Kinetic.Layer();this.stage.add(this.highlighted_rows_layer);this.highlighted_rows_layer.moveToTop();this.row_borders=this.objects_ref.row_borders.clone();var l=this;this.heatmap_layer.on("mouseleave",function(m){l.heatmap_overlay.destroyChildren();l.heatmap_overlay.draw();l.events.heatmap_onmouseout(m)})};InCHlib.prototype._draw_heatmap_row=function(v,u,b){var q=this.data.nodes[v];var e=new Kinetic.Group({id:v});var h,g,t,a,r,j,s,m,f,p,n,c,o,k;for(s=0;s<this.on_features.length;s++){k=this.on_features[s];p=q.features[k];if(this.settings.independent_columns){this.min_value=this.columns_min_max[k][0];this.max_value=this.columns_min_max[k][1];this.middle_value=this.columns_min_max[k][2]}r=this._get_color_for_value(p,this.min_value,this.max_value,this.middle_value,this.settings.heatmap_colors);t=u+this.pixels_for_dimension;a=b;j=this.objects_ref.heatmap_line.clone({stroke:r,points:[u,b,t,a],value:p,column:["d",k].join("_"),strokeWidth:this.pixels_for_leaf});e.add(j);if(this.current_draw_values){n=this.objects_ref.heatmap_value.clone({x:this._hack_round((u+t)/2-(""+p).length*(this.value_font_size/4)),y:this._hack_round(b-this.value_font_size/2),fontSize:this.value_font_size,text:p});e.add(n)}u=t}if(this.settings.metadata){var l=this.data.metadata.nodes[v];for(s=0;s<this.on_metadata_features.length;s++){k=this.on_metadata_features[s];p=l[k];c=p;this.metadata_min_value=this.metadata_columns_min_max[k][0];this.metadata_max_value=this.metadata_columns_min_max[k][1];this.metadata_middle_value=this.metadata_columns_min_max[k][2];if(!this._is_number(c)){p=this.categories2numbers[k][p]}r=this._get_color_for_value(p,this.metadata_min_value,this.metadata_max_value,this.metadata_middle_value,this.settings.metadata_colors);t=u+this.pixels_for_dimension;a=b;j=this.objects_ref.heatmap_line.clone({stroke:r,points:[u,b,t,a],value:p,column:["m",k].join("_"),strokeWidth:this.pixels_for_leaf});e.add(j);if(this.current_draw_values){n=this.objects_ref.heatmap_value.clone({text:c,fontSize:this.value_font_size});o=n.getWidth();h=this._hack_round((u+t)/2-o/2);g=this._hack_round(b-this.value_font_size/2);n.position({x:h,y:g});e.add(n)}u=t}}if(this.settings.count_column&&this.features[this.dimensions-1]==1){t=u+this.pixels_for_dimension;var d=q.objects.length;r=this._get_color_for_value(d,this.min_item_count,this.max_item_count,this.middle_item_count,this.settings.count_column_colors);j=this.objects_ref.heatmap_line.clone({stroke:r,points:[u,b,t,a],value:d,column:"Count",strokeWidth:this.pixels_for_leaf});e.add(j);if(this.current_draw_values){n=this.objects_ref.heatmap_value.clone({text:d});o=n.getWidth();h=this._hack_round((u+t)/2-o/2);g=this._hack_round(b-this.value_font_size/2);n.position({x:h,y:g});e.add(n)}u=t}return e};InCHlib.prototype._bind_row_events=function(b){var a=this;b.on("mouseenter",function(c){a._row_mouseenter(c)});b.on("mouseleave",function(c){a._row_mouseleave(c)});b.on("mouseover",function(c){a._draw_col_label(c)});b.on("mouseout",function(c){a.heatmap_overlay.find("#col_label")[0].destroy()});b.on("click",function(c){var f=c.targetNode.parent.attrs.id;if(f!="header_row"){var e=a.data.nodes[f].objects;var d=[];for(i=0;i<e.length;i++){d.push(e[i])}a.events.row_onclick(d,c)}})};InCHlib.prototype._draw_row_ids=function(a){if(this.pixels_for_leaf<6){return}var d,k,b=[],e,g=[],j;for(d=0;d<a.length;d++){e=a[d];k=this.data.nodes[e[0]].objects;if(k.length>1){return}g.push(k[0]);b.push([k[0],e[1]])}var h=this._get_max_length(g);var c=this._get_font_size(h,85,this.pixels_for_leaf,12);var f=this.distance+(this.on_features.length+this.on_metadata_features.length)*this.pixels_for_dimension+15;f=(this.settings.count_column)?f+this.pixels_for_dimension:f;if(c>4){for(d=0;d<b.length;d++){j=this.objects_ref.heatmap_value.clone({x:f,y:this._hack_round(b[d][1]-c/2),fontSize:c,text:b[d][0],fontStyle:"italic",fill:"gray"});this.heatmap_layer.add(j)}}return};InCHlib.prototype._draw_header_row=function(d){var q=new Kinetic.Group({id:"header_row"});var o=14;var j=this.header_height-0.5*o-2;var k,g,a,h,e,p,f,m,n,l,c,b;for(f=0;f<this.on_features.length;f++){b=this.on_features[f];m=this.heatmap_header[b];l=m;if(!this._is_number(l)){m=this.categories2numbers.header[m]}e=this._get_color_for_value(m,this.header_min_max[0],this.header_min_max[1],this.header_min_max[2],this.settings.header_row_colors);a=d+this.pixels_for_dimension;h=j;p=this.objects_ref.heatmap_line.clone({strokeWidth:o,stroke:e,points:[d,j,a,h],column:["d",b].join("_")});q.add(p);d=a}return q};InCHlib.prototype._draw_heatmap_header=function(){this.header_layer=new Kinetic.Layer();var e=this._hack_size(this.leaves_y_coordinates);var g=(this.settings.column_dendrogram&&this.heatmap_header)?this.header_height+(this.pixels_for_leaf*e)+10:this.header_height-20;var k=(this.settings.column_dendrogram&&this.heatmap_header)?45:-45;g=(k==-45&&this.settings.header_as_heatmap_row)?g-10:g;var a=0;var h,d,c;var f=[];for(d=0;d<this.header.length;d++){f[d]=this.header[d]}var l=this._get_max_length(f);var b=this._hack_round(this.header_height*1.5/l);b=(b>16)?16:b;b=(b>this.pixels_for_dimension)?this.pixels_for_dimension-3:b;if(b<8){return}for(d=0;d<this.header.length;d++){if(this.features[d]==1||d>this.dimensions-1){h=this.distance+a*this.pixels_for_dimension+this.pixels_for_dimension/2;c=this.objects_ref.column_header.clone({x:h,y:g,text:this.header[d],position_index:d+1,fontSize:b,rotationDeg:k});this.header_layer.add(c);a++}}this.stage.add(this.header_layer);if(!(this.settings.dendrogram)){var j=this;this.header_layer.on("click",function(n){var p=n.targetNode;var m=p.attrs.order;var o=p.attrs.position_index;for(d=0;d<j.header_layer.getChildren().length;d++){j.header_layer.getChildren()[d].setFill("black")}n.targetNode.setAttrs({order:m,fill:"red"});j.heatmap_layer.destroyChildren();j.heatmap_layer.draw();j._reorder_heatmap(o,m);j._draw_heatmap()});this.header_layer.on("mouseover",function(m){var n=m.targetNode;n.setOpacity(0.7);this.draw()});this.header_layer.on("mouseout",function(m){var n=m.targetNode;n.setOpacity(1);this.draw()})}};InCHlib.prototype._draw_distance_scale=function(a){this.distance_scale_layer=new Kinetic.Layer();var n=this.header_height-15;var m=n;var d=0;var c=this.distance;var o=new Kinetic.Line({points:[d,n,c,m],stroke:"black",listening:false});this.distance_scale_layer.add(o);var b=new Kinetic.Circle({x:c,y:m,radius:3,fill:"black",listening:false});this.distance_scale_layer.add(b);var h=0;var l=3;var k=c;var j=this._hack_round(30/this.distance_step*10)/10;var a=Math.round(100*this.distance/this.distance_step)/100;var f=this._hack_round(this.distance_step*j);var e=0;var g=new Kinetic.Text({x:0,y:n-20,text:a,fontSize:14,fontFamily:this.settings.font,fontStyle:"bold",fill:"black",align:"right",listening:false});this.distance_scale_layer.add(g);if(f==0){f=0.5}var o;if(j>0.1){while(k>0){o=new Kinetic.Line({points:[k,(n-l),k,(m+l)],stroke:"black",listening:false});this.distance_scale_layer.add(o);h=this._hack_round((h+j)*10)/10;if(h>10){h=this._hack_round(h)}k=k-f;e++}}this.stage.add(this.distance_scale_layer)};InCHlib.prototype._draw_navigation=function(){this.navigation_layer=new Kinetic.Layer();var d=this;if(d.zoomed_clusters.length>0){var e=this.objects_ref.icon.clone({data:"M24.083,15.5c-0.009,4.739-3.844,8.574-8.583,8.583c-4.741-0.009-8.577-3.844-8.585-8.583c0.008-4.741,3.844-8.577,8.585-8.585c1.913,0,3.665,0.629,5.09,1.686l-1.782,1.783l8.429,2.256l-2.26-8.427l-1.89,1.89c-2.072-1.677-4.717-2.688-7.587-2.688C8.826,3.418,3.418,8.826,3.416,15.5C3.418,22.175,8.826,27.583,15.5,27.583S27.583,22.175,27.583,15.5H24.083z",x:50,y:10,id:"refresh_icon",label:"Refresh"});d.navigation_layer.add(e);var c=this.objects_ref.icon.clone({data:"M22.646,19.307c0.96-1.583,1.523-3.435,1.524-5.421C24.169,8.093,19.478,3.401,13.688,3.399C7.897,3.401,3.204,8.093,3.204,13.885c0,5.789,4.693,10.481,10.484,10.481c1.987,0,3.839-0.563,5.422-1.523l7.128,7.127l3.535-3.537L22.646,19.307zM13.688,20.369c-3.582-0.008-6.478-2.904-6.484-6.484c0.006-3.582,2.903-6.478,6.484-6.486c3.579,0.008,6.478,2.904,6.484,6.486C20.165,17.465,17.267,20.361,13.688,20.369zM8.854,11.884v4.001l9.665-0.001v-3.999L8.854,11.884z",x:90,y:10,label:"Zoom out"});var b=d._draw_icon_overlay(50,10);var g=d._draw_icon_overlay(90,10);d.navigation_layer.add(c);d.navigation_layer.add(b);d.navigation_layer.add(g);g.on("click",function(){d.events.on_unzoom(d._unprefix(d.zoomed_clusters[d.zoomed_clusters.length-1]));d._unzoom_icon_click(this)});g.on("mouseover",function(){d._icon_mouseover(c,g,d.navigation_layer)});g.on("mouseout",function(){d._icon_mouseout(c,g,d.navigation_layer)});b.on("click",function(){d._refresh_icon_click();d.events.on_refresh()});b.on("mouseover",function(){d._icon_mouseover(e,b,d.navigation_layer)});b.on("mouseout",function(){d._icon_mouseout(e,b,d.navigation_layer)})}if(d.header){var a=this.objects_ref.icon.clone({data:"M26.834,6.958c0-2.094-4.852-3.791-10.834-3.791c-5.983,0-10.833,1.697-10.833,3.791c0,0.429,0.213,0.84,0.588,1.224l8.662,15.002v4.899c0,0.414,0.709,0.75,1.583,0.75c0.875,0,1.584-0.336,1.584-0.75v-4.816l8.715-15.093h-0.045C26.625,7.792,26.834,7.384,26.834,6.958zM16,9.75c-6.363,0-9.833-1.845-9.833-2.792S9.637,4.167,16,4.167c6.363,0,9.834,1.844,9.834,2.791S22.363,9.75,16,9.75z",x:10,y:10,label:"Filter\ncolumns"});d.navigation_layer.add(a);var f=d._draw_icon_overlay(10,10);d.navigation_layer.add(f);f.on("click",function(){d._filter_icon_click(this)});f.on("mouseover",function(){d._icon_mouseover(a,f,d.navigation_layer)});f.on("mouseout",function(){d._icon_mouseout(a,f,d.navigation_layer)})}d.stage.add(d.navigation_layer)};InCHlib.prototype._draw_icon_overlay=function(a,c){var b=this.objects_ref.icon_overlay.clone({x:a,y:c});return b};InCHlib.prototype._highlight_path=function(a){var c=this.data.nodes[a];if(c.count!=1){var d=this._clone_path(this.dendrogram_layer.get("#"+a)[0]);if(d){d.setStroke("#F5273C");var b=this._clone_rect(this.dendrogram_layer.get("#"+a+"_rect")[0],d);b.setAttrs({path:d,path_id:a});this.dendrogram_overlay_layer.add(d);this.dendrogram_overlay_layer.add(b);this._highlight_path(c.left_child);this._highlight_path(c.right_child)}}else{if(this.settings.heatmap){var e=this.leaves_y_coordinates[a];this.row_y_coordinates.push(e)}}};InCHlib.prototype.unhighlight_rows=function(){this.highlight_rows([]);return};InCHlib.prototype.highlight_rows=function(g){var e,j,b;this.settings.highlighted_rows=g;this.highlighted_rows_layer.destroyChildren();var d=this.settings.heatmap_colors;var c=this.settings.metadata_colors;this.settings.heatmap_colors=this.settings.highlight_colors;this.settings.metadata_colors=this.settings.highlight_colors;var f={};var a=[];for(e=0;e<g.length;e++){if(g[e] in this.objects2leaves){b=this.objects2leaves[g[e]];if(!(b in f)){a.push(b);f[b]=null}}}for(e=0;e<a.length;e++){j=this._draw_heatmap_row(a[e],this.distance+this.dendrogram_heatmap_distance,this.leaves_y_coordinates[a[e]]);this.highlighted_rows_layer.add(j);j.setAttr("listening",false)}this.highlighted_rows_layer.draw();this.heatmap_overlay.moveToTop();this.settings.heatmap_colors=d;this.settings.metadata_colors=c;var h=this;this.highlighted_rows_layer.on("click",function(k){h.heatmap_layer.fire("click")})};InCHlib.prototype._highlight_cluster=function(a){var b=[];if(this.last_highlighted_cluster){this.cluster_layer.removeChildren();this.cluster_layer.draw();this.dendrogram_overlay_layer.removeChildren()}this.row_y_coordinates=[];this.last_highlighted_cluster=a;this._highlight_path(a);this.dendrogram_overlay_layer.draw();b=this._draw_cluster_layer(a);this.events.dendrogram_node_highlight(b,a);return b};InCHlib.prototype.highlight_cluster=function(a){return this._highlight_cluster(this._prefix(a))};InCHlib.prototype.unhighlight_cluster=function(){if(this.last_highlighted_cluster){this.cluster_layer.removeChildren();this.cluster_layer.draw();this.dendrogram_overlay_layer.removeChildren();this.dendrogram_overlay_layer.draw();this.events.dendrogram_node_unhighlight(this.last_highlighted_cluster);this.last_highlighted_cluster=null}return[]};InCHlib.prototype._neutralize_path=function(a){var b=this.data.nodes[a];if(b.count!=1){var c=this.dendrogram_layer.get("#"+a)[0];if(c){c.setStroke("grey");this._neutralize_path(b.right_child);this._neutralize_path(b.left_child)}}};InCHlib.prototype._draw_cluster_layer=function(){this.cluster_layer=new Kinetic.Layer();var d=this.on_features.length+this.on_metadata_features.length;if(this.settings.count_column){d++}var l=this.data.nodes[this.last_highlighted_cluster].count;var p=this.distance+d*this.pixels_for_dimension+100;var j=this._hack_round(this.distance+d*this.pixels_for_dimension+20);if(this.settings.heatmap){var b=this._hack_round(this.row_y_coordinates[0]-this.pixels_for_leaf/2);var a=this._hack_round(this.row_y_coordinates[this.row_y_coordinates.length-1]+0.5*this.pixels_for_leaf)}else{var g=this._hack_round(this.nodes_y_coordinates[this.last_highlighted_cluster]-this.pixels_for_leaf/2-20)}var c=this.objects_ref.row_count.clone({x:j,y:b-20,text:l+" rows"});this.cluster_layer.add(c);var q=this.objects_ref.icon.clone({data:"M22.646,19.307c0.96-1.583,1.523-3.435,1.524-5.421C24.169,8.093,19.478,3.401,13.688,3.399C7.897,3.401,3.204,8.093,3.204,13.885c0,5.789,4.693,10.481,10.484,10.481c1.987,0,3.839-0.563,5.422-1.523l7.128,7.127l3.535-3.537L22.646,19.307zM13.688,20.369c-3.582-0.008-6.478-2.904-6.484-6.484c0.006-3.582,2.903-6.478,6.484-6.486c3.579,0.008,6.478,2.904,6.484,6.486C20.165,17.465,17.267,20.361,13.688,20.369zM15.687,9.051h-4v2.833H8.854v4.001h2.833v2.833h4v-2.834h2.832v-3.999h-2.833V9.051z",x:j-5,y:a+8,label:"Zoom in"});var k=this.objects_ref.cluster_border.clone({points:[0,b,p,b]});this.cluster_layer.add(k);k=this.objects_ref.cluster_border.clone({points:[0,a,p,a]});this.cluster_layer.add(k);var t=this._collect_object_ids(b,a);var r=this.distance+this.dendrogram_heatmap_distance;var s=this.header_height;var p=d*this.pixels_for_dimension+90;var o=this.settings.height-this.header_height;var e=this.row_y_coordinates[0]-this.pixels_for_leaf/2;var h=this.row_y_coordinates[this.row_y_coordinates.length-1]+this.pixels_for_leaf/2;var m=this.objects_ref.cluster_overlay.clone({x:r,y:s,width:p,height:e-s-1});this.cluster_layer.add(m);m=this.objects_ref.cluster_overlay.clone({x:r,y:h+1,width:p,height:this.settings.height-h-this.footer_height});this.cluster_layer.add(m);var f=this._draw_icon_overlay(j-5,a);this.cluster_layer.add(q);this.cluster_layer.add(f);this.stage.add(this.cluster_layer);c.moveToTop();this.cluster_layer.draw();var n=this;f.on("mouseover",function(){n._icon_mouseover(q,f,n.cluster_layer)});f.on("mouseout",function(){n._icon_mouseout(q,f,n.cluster_layer)});f.on("click",function(){n._zoom_cluster(n.last_highlighted_cluster)});this.cluster_layer.on("click",function(u){n.unhighlight_cluster();n.events.empty_space_onclick(u)});return t};InCHlib.prototype._zoom_cluster=function(a){if(a!=this.zoomed_clusters[this.zoomed_clusters.length-1]&&a!=this.root_id){this.zoomed_clusters.push(a);this._delete_all_layers();this._draw_stage_layer();this._draw_row_dendrogram(a);if(this.settings.column_dendrogram&&this._visible_features_equal_column_dendrogram_count()){this._draw_column_dendrogram(this.column_root_id)}this._draw_navigation();this._draw_heatmap();this._draw_heatmap_header();this.highlight_rows(this.settings.highlighted_rows);this.events.on_zoom(this._unprefix(a))}else{return false}};InCHlib.prototype._get_node_neighbourhood=function(c,b){var k=this;var j={left_node:{left_node:{left_count:0,right_count:0},right_node:{left_count:0,right_count:0},left_count:0.5,right_count:0.5},right_node:{left_node:{left_count:0,right_count:0},right_node:{left_count:0,right_count:0},left_count:0.5,right_count:0.5},left_count:b[c.left_child].count,right_count:b[c.right_child].count};var a=b[c.left_child];var e=b[c.right_child];var d=b[a.left_child];var g=b[a.right_child];var f=b[e.left_child];var h=b[e.right_child];if(a.count!=1){j.left_node.left_count=b[a.left_child].count;j.left_node.right_count=b[a.right_child].count;if(d.count!=1){j.left_node.left_node.left_count=b[d.left_child].count;j.left_node.left_node.right_count=b[d.right_child].count}else{j.left_node.left_node.left_count=0.5;j.left_node.left_node.right_count=0.5}if(g.count!=1){j.left_node.right_node.left_count=b[g.left_child].count;j.left_node.right_node.right_count=b[g.right_child].count}else{j.left_node.right_node.left_count=0.5;j.left_node.right_node.right_count=0.5}}if(e.count!=1){j.right_node.left_count=b[e.left_child].count;j.right_node.right_count=b[e.right_child].count;if(f.count!=1){j.right_node.left_node.left_count=b[f.left_child].count;j.right_node.left_node.right_count=b[f.right_child].count}else{j.right_node.left_node.left_count=0.5;j.right_node.left_node.right_count=0.5}if(h.count!=1){j.right_node.right_node.left_count=b[h.left_child].count;j.right_node.right_node.right_count=b[h.right_child].count}else{j.right_node.right_node.left_count=0.5;j.right_node.right_node.right_count=0.5}}return j};InCHlib.prototype._draw_column_dendrogram_node=function(g,e,j,p,o,m){if(e.count!=1){var k=this._get_node_neighbourhood(e,this.data.column_dendrogram.nodes);var f=this.data.column_dendrogram.nodes[e.right_child];var b=this.data.column_dendrogram.nodes[e.left_child];var c=this._get_x1(k,j,p);var a=this._get_x2(k,j,p);var n=this._hack_round(this.vertical_distance-this.vertical_distance_step*e.distance);n=(n==0)?2:n;var l=n;if(f.count==1){a=a-this.pixels_for_dimension/2}var d=this.vertical_distance-this.vertical_distance_step*this.data.column_dendrogram.nodes[e.left_child].distance;var h=this.vertical_distance-this.vertical_distance_step*this.data.column_dendrogram.nodes[e.right_child].distance;this.column_dendrogram_layer.add(this._draw_vertical_path(g,c,n,a,l,d,h));this._draw_column_dendrogram_node(e.left_child,b,j-k.left_node.right_count,p+k.left_node.right_count,d,n);this._draw_column_dendrogram_node(e.right_child,f,j+k.right_node.left_count,p-k.right_node.left_count,h,l)}};InCHlib.prototype._get_y1=function(c,b,a){b=b-c.left_node.right_count-c.left_node.left_node.right_count;var d=(b+(c.left_node.left_node.right_count+c.left_node.right_node.left_count)/2)*this.pixels_for_leaf;return d+this.header_height};InCHlib.prototype._get_y2=function(c,b,a){b=b+c.right_node.left_node.left_count;var d=(b+(c.right_node.left_node.right_count+c.right_node.right_node.left_count)/2)*this.pixels_for_leaf;return d+this.header_height};InCHlib.prototype._get_x1=function(e,d,b){var c=this.data.column_dendrogram.nodes[this.column_root_id].count;d=d-e.left_node.right_count-e.left_node.left_node.right_count;var a=(d+(e.left_node.left_node.right_count+e.left_node.right_node.left_count)/2)*this.pixels_for_dimension;return(this.distance+this.dendrogram_heatmap_distance+c*this.pixels_for_dimension)-a};InCHlib.prototype._get_x2=function(e,d,b){var c=this.data.column_dendrogram.nodes[this.column_root_id].count;d=d+e.right_node.left_node.left_count;var a=(d+(e.right_node.left_node.right_count+e.right_node.right_node.left_count)/2)*this.pixels_for_dimension;return(this.distance+this.dendrogram_heatmap_distance+c*this.pixels_for_dimension)-a};InCHlib.prototype._draw_vertical_path=function(e,c,f,a,d,b,h){var g=this.objects_ref.column_node.clone({points:[c,b,c,f,a,d,a,h]});return g};InCHlib.prototype._draw_horizontal_path=function(a,c,j,b,h,e,f){var g=new Kinetic.Group({});var k=this.objects_ref.row_node.clone({points:[e,j,c,j,b,h,f,h],id:a});var d=this.objects_ref.row_node_rect.clone({x:c-1,y:j-1,width:this.distance-c,height:h-j,id:[a,"rect"].join("_"),path:k,path_id:a});g.add(k);g.add(d);return g};InCHlib.prototype._filter_icon_click=function(g){var c=$("#dendrogram_filter_features").text();var a="✖";var j=this;if(c.length>0){$("#dendrogram_filter_features").fadeIn("slow");var e=$("#"+j.settings.target);$("#dendrogram_overlay").css({width:e.outerWidth(true),height:e.outerHeight(true)});$("#dendrogram_overlay").fadeIn("slow")}else{c="";for(var f in j.header){if(j.features[f]==1){a="✔"}if(f<this.dimensions){var h=j.header[f];if(h==""){h=parseInt(f)+1+". column"}c=c+"<li class='feature_switch' data-num='"+f+"'><span class='symbol'>"+a+"</span>  "+h+"</li>"}}$("#"+j.settings.target).append("<div id='dendrogram_filter_features'><ul>"+c+"</ul><hr /><div><span id='cancel_filter_list'>Cancel</span>&nbsp;&nbsp;&nbsp;<span id='update_filter_list'>Update</span></div></div>");var b=$("#dendrogram_filter_features");b.css({display:"none",top:20,left:50,"border-radius":"5px","text-align":"center",position:"absolute","background-color":"#ffffff",border:"solid 3px #DEDEDE","padding-top":"5px","padding-left":"15px","padding-bottom":"10px","padding-right":"15px","font-weight":"bold","z-index":1000,"font-family":j.settings.font});b.find("ul").css({"list-style-type":"none","margin-left":"0","padding-left":"0","text-align":"left"});b.find("li").css({color:"green","margin-top":"5px"});b.find("div").css({cursor:"pointer",opacity:"0.7"});d();b.toTo;b.fadeIn("slow");function d(){var l=$("#"+j.settings.target);var k=$("<div id='dendrogram_overlay'></div>");k.css({"background-color":"white",position:"absolute",top:0,left:0,right:0,bottom:0,opacity:0.5});l.css({position:"relative"});l.append(k)}$(".feature_switch").click(function(){var l=parseInt($(this).attr("data-num"));var k=$(this).find("span");j.features[l]=-j.features[l];if(j.features[l]==1){k.text("✔");$(this).css("color","green")}else{k.text("✖");$(this).css("color","red")}j._set_on_features()});$(function(){$("#dendrogram_filter_features").click(function(){return false});$("#dendrogram_filter_features ul li, #dendrogram_filter_features div span").hover(function(){$(this).css({cursor:"pointer",opacity:"0.7"})},function(){$(this).css({cursor:"default",opacity:"1"})})});$("#cancel_filter_list").click(function(){$("#dendrogram_filter_features").fadeOut("slow");$("#dendrogram_overlay").fadeOut("slow")});$("#dendrogram_overlay").click(function(){$("#dendrogram_filter_features").fadeOut("slow");$("#dendrogram_overlay").fadeOut("slow")});$("#update_filter_list").click(function(){$("#dendrogram_filter_features").fadeOut("slow");$("#dendrogram_overlay").fadeOut("slow");var l=(j.zoomed_clusters.length>0)?j.zoomed_clusters[j.zoomed_clusters.length-1]:j.root_id;var k=j.last_highlighted_cluster;j.last_highlighted_cluster=null;j._delete_all_layers();if(j.settings.dendrogram){j._draw_row_dendrogram(l)}if(j._visible_features_equal_column_dendrogram_count()&&j.settings.column_dendrogram){j._draw_column_dendrogram(j.column_root_id)}j._draw_navigation();j._draw_heatmap();j._draw_heatmap_header();if(k!=null){j._highlight_cluster(k)}})}};InCHlib.prototype._refresh_icon_click=function(){var a=this.root_id;this.zoomed_clusters=[];this._delete_all_layers();this._draw_stage_layer();this._draw_row_dendrogram(a);if(this.settings.column_dendrogram&&this._visible_features_equal_column_dendrogram_count()){this._draw_column_dendrogram(this.column_root_id)}this._draw_navigation();this._draw_heatmap();this._draw_heatmap_header();this.highlight_rows(this.settings.highlighted_rows)};InCHlib.prototype._unzoom_icon_click=function(){var a=this.zoomed_clusters[this.zoomed_clusters.length-1];this.zoomed_clusters.pop();if(this.zoomed_clusters.length>=1){var b=this.zoomed_clusters[this.zoomed_clusters.length-1];this.zoomed_clusters.pop();this._zoom_cluster(b)}else{this._refresh_icon_click()}this._highlight_cluster(a)};InCHlib.prototype._icon_mouseover=function(f,g,d){var c=f.getAttr("label");var b=g.getAttr("x");var h=g.getAttr("y");var e=g.getWidth();var a=g.getHeight();this.icon_tooltip=this.objects_ref.tooltip_label.clone({x:b,y:h+1.2*a});this.icon_tooltip.add(this.objects_ref.tooltip_tag.clone());this.icon_tooltip.add(this.objects_ref.tooltip_text.clone({text:c}));d.add(this.icon_tooltip);f.setFill("black");d.draw()};InCHlib.prototype._icon_mouseout=function(b,c,a){this.icon_tooltip.destroy();b.setFill("grey");a.draw()};InCHlib.prototype._dendrogram_layers_click=function(a,c){var d=[];var b=a.targetNode.attrs.path_id;c.fire("mouseout",a);if(b!=this.last_highlighted_cluster){d=this._highlight_cluster(b)}else{this.unhighlight_cluster()}c.draw();this.events.dendrogram_node_onclick(d,b,a)};InCHlib.prototype._dendrogram_layers_mouseout=function(a){var c=a.targetNode.className;if(c=="Rect"){var b=this.dendrogram_hover_layer.get("#"+[this.settings.target,"path_hover"].join("_"))[0];if(b){this.dendrogram_hover_layer.get("#"+[this.settings.target,"path_hover"].join("_"))[0].destroy();this.dendrogram_hover_layer.draw()}}};InCHlib.prototype._dendrogram_layers_mouseover=function(a){var d=a.targetNode.className;if(d=="Rect"){var c=a.targetNode.attrs.path;var b=this._clone_path(c);b.setStrokeWidth(4);b.setId([this.settings.target,"path_hover"].join("_"));this.dendrogram_hover_layer.add(b);this.dendrogram_hover_layer.draw()}};InCHlib.prototype._visible_features_equal_column_dendrogram_count=function(){var a;if((this.on_features.length+this.on_metadata_features.length)==(this.data_dimensions+this.metadata_dimensions)){return true}return false};InCHlib.prototype._clone_path=function(b){var a=new Kinetic.Line({points:b.attrs.points,stroke:b.attrs.stroke,strokeWidth:b.attrs.strokeWidth,lineCap:b.attrs.lineCap,lineJoin:b.attrs.lineJoin,listening:b.attrs.listening});return a};InCHlib.prototype._clone_rect=function(b){var a=new Kinetic.Rect({x:b.attrs.x,y:b.attrs.y,width:b.attrs.width,height:b.attrs.height,opacity:b.attrs.opacity,listening:b.attrs.listening});return a};InCHlib.prototype._get_color_for_value=function(o,d,n,p,m){var c=this.colors[m];var f=c.start;var e=c.end;if(d==n){return"rgb("+f.r+","+f.g+","+f.b+")"}if("middle" in c){if(o>=p){d=p;f=c.middle;e=c.end}else{n=p;f=c.start;e=c.middle}}var h=(o-d)/(n-d);var a=this._hack_round(f.r+(h*(e.r-f.r)));var k=this._hack_round(f.g+(h*(e.g-f.g)));var l=this._hack_round(f.b+(h*(e.b-f.b)));var j="rgb("+a+","+k+","+l+")";return j};InCHlib.prototype._get_font_size=function(c,e,b,d){var f=b-2;var a=f;if(a/2*c>e-10){a=a/(a/2*c/(e-10))}a=(a>f)?f:a;a=(a>d)?d:a;return a};InCHlib.prototype._collect_object_ids=function(e,c){var g=[];var d=[];var f,b,a;for(b in this.leaves_y_coordinates){if(this.leaves_y_coordinates[b]>e&&this.leaves_y_coordinates[b]<c){g.push(b)}}for(b=0;b<g.length;b++){f=this.data.nodes[g[b]];for(a=0;a<f.objects.length;a++){d.push(f.objects[a])}}return d};InCHlib.prototype._hack_size=function(c){var b=0,a;for(a in c){if(c.hasOwnProperty(a)){b++}}return b};InCHlib.prototype._hack_round=function(a){return(0.5+a)>>0};InCHlib.prototype._middle2fnc=function(b){var a=this;var c={zero:function(d){return 0},median:function(d){d.sort(function(g,f){return g-f});var e=a._hack_round(d.length/2);return d[e]},mean:function(d){var e=d.reduce(function(g,f){return parseFloat(g)+f});return e/d.length}};return c[this.settings.values_center](b)};InCHlib.prototype._is_number=function(a){return !isNaN(parseFloat(a))&&isFinite(a)};InCHlib.prototype._row_mouseenter=function(b){var d=b.targetNode.parent.getAttr("id");var e=this.on_features.length+this.on_metadata_features.length;if(this.settings.count_column){e++}if(d!="header_row"){this.highlighted_row=d;var f=this.leaves_y_coordinates[d]-0.5*this.pixels_for_leaf;var a=this.distance+this.dendrogram_heatmap_distance;this.row_borders=this.objects_ref.row_borders.clone();var c=this.objects_ref.row_border.clone({points:[a,f,a+e*this.pixels_for_dimension,f]});this.row_borders.add(c);f=f+this.pixels_for_leaf;this.row_borders.add(this.objects_ref.row_border.clone({points:[a,f,a+e*this.pixels_for_dimension,f]}));this.heatmap_overlay.add(this.row_borders);this.heatmap_overlay.draw();this.events.row_onmouseover(this.data.nodes[d].objects,b)}};InCHlib.prototype._row_mouseleave=function(a){this.row_borders.destroy();this.events.row_onmouseout(a)};InCHlib.prototype._draw_col_label=function(k){var b,m;var j=k.targetNode.attrs;var h=j.points;var f=this._hack_round((h[0]+h[2])/2);var d=h[1]-0.5*this.pixels_for_leaf;var a=j.column.split("_");var e={d:this.heatmap_header[a[1]],m:this.metadata_header[a[1]],Count:"Count"};var g=j.value;var c=e[a[0]];if(g){g=[c,g].join("\n")}else{g=c}var l=this.objects_ref.tooltip_label.clone({x:f,y:d,id:"col_label"});l.add(this.objects_ref.tooltip_tag.clone({pointerDirection:"down"}));l.add(this.objects_ref.tooltip_text.clone({text:g}));this.heatmap_overlay.add(l);this.heatmap_overlay.moveToTop();this.heatmap_overlay.draw();return};InCHlib.prototype._unprefix=function(a){return a.split(this.settings.target+"#")[1]};InCHlib.prototype._prefix=function(a){return this.settings.target+"#"+a};