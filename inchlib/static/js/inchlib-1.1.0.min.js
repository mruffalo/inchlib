var InCHlib;(function(e){InCHlib=function(t){var n=this;this.user_settings=t;this.target_element=e("#"+t.target);var r=this.target_element.width();this.target_element.css({position:"relative"});this.settings={target:"YourOwnDivId",heatmap:true,heatmap_header:true,dendrogram:true,metadata:false,column_metadata:false,column_metadata_row_height:8,column_metadata_colors:"RdLrBu",max_height:800,width:r,heatmap_colors:"Greens",heatmap_font_color:"black",heatmap_part_width:.7,column_dendrogram:false,independent_columns:true,metadata_colors:"Reds",highlight_colors:"Oranges",highlighted_rows:[],label_color:"#9E9E9E",count_column:false,count_column_colors:"Reds",min_row_height:false,max_row_height:25,max_column_width:150,font:"Helvetica",draw_row_ids:false,show_export_button:true,max_percentile:100,min_percentile:0,middle_percentile:50};e.extend(this.settings,t);this.settings.width=t.max_width&&t.max_width<r?t.max_width:this.settings.width;this.settings.heatmap_part_width=this.settings.heatmap_part_width>.9?.9:this.settings.heatmap_part_width;this.header_height=150;this.footer_height=70;this.dendrogram_heatmap_distance=5;this.heatmap_width=0;this.highlighted_row=null;this.leaves_y_coordinates={};this.events={row_onclick:function(e,t){return},row_onmouseover:function(e,t){return},row_onmouseout:function(e){return},dendrogram_node_onclick:function(e,t,n){return},column_dendrogram_node_onclick:function(e,t,n){return},dendrogram_node_highlight:function(e,t){return},column_dendrogram_node_highlight:function(e,t){return},dendrogram_node_unhighlight:function(e){return},column_dendrogram_node_unhighlight:function(e){return},heatmap_onmouseout:function(e){return},on_zoom:function(e,t){return},on_unzoom:function(e){return},on_columns_zoom:function(e,t){return},on_columns_unzoom:function(e){return},on_refresh:function(){return},empty_space_onclick:function(e){return}};this.colors={YlGn:{start:{r:255,g:255,b:204},end:{r:35,g:132,b:67}},GnBu:{start:{r:240,g:249,b:232},end:{r:43,g:140,b:190}},BuGn:{start:{r:237,g:248,b:251},end:{r:35,g:139,b:69}},PuBu:{start:{r:241,g:238,b:246},end:{r:5,g:112,b:176}},BuPu:{start:{r:237,g:248,b:251},end:{r:136,g:65,b:157}},RdPu:{start:{r:254,g:235,b:226},end:{r:174,g:1,b:126}},PuRd:{start:{r:241,g:238,b:246},end:{r:206,g:18,b:86}},OrRd:{start:{r:254,g:240,b:217},end:{r:215,g:48,b:31}},Purples2:{start:{r:242,g:240,b:247},end:{r:106,g:81,b:163}},Blues:{start:{r:239,g:243,b:255},end:{r:33,g:113,b:181}},Greens:{start:{r:237,g:248,b:233},end:{r:35,g:139,b:69}},Oranges:{start:{r:254,g:237,b:222},end:{r:217,g:71,b:1}},Reds:{start:{r:254,g:229,b:217},end:{r:203,g:24,b:29}},Greys:{start:{r:247,g:247,b:247},end:{r:82,g:82,b:82}},PuOr:{start:{r:230,g:97,b:1},end:{r:94,g:60,b:153}},BrBG:{start:{r:166,g:97,b:26},end:{r:1,g:133,b:113}},RdBu:{start:{r:202,g:0,b:32},end:{r:5,g:113,b:176}},RdGy:{start:{r:202,g:0,b:32},end:{r:64,g:64,b:64}},BuYl:{start:{r:5,g:113,b:176},end:{r:250,g:233,b:42}},YlOrR:{start:{r:255,g:255,b:178},end:{r:227,g:26,b:28},middle:{r:204,g:76,b:2}},YlOrB:{start:{r:255,g:255,b:212},end:{r:5,g:112,b:176},middle:{r:204,g:76,b:2}},PRGn2:{start:{r:123,g:50,b:148},end:{r:0,g:136,b:55},middle:{r:202,g:0,b:32}},PiYG2:{start:{r:208,g:28,b:139},end:{r:77,g:172,b:38},middle:{r:255,g:255,b:178}},YlGnBu:{start:{r:255,g:255,b:204},end:{r:34,g:94,b:168},middle:{r:35,g:132,b:67}},RdYlBu:{start:{r:215,g:25,b:28},end:{r:44,g:123,b:182},middle:{r:255,g:255,b:178}},RdYlGn:{start:{r:215,g:25,b:28},end:{r:26,g:150,b:65},middle:{r:255,g:255,b:178}},BuWhRd:{start:{r:33,g:113,b:181},middle:{r:255,g:255,b:255},end:{r:215,g:25,b:28}},RdLrBu:{start:{r:215,g:25,b:28},middle:{r:254,g:229,b:217},end:{r:44,g:123,b:182}},RdBkGr:{start:{r:215,g:25,b:28},middle:{r:0,g:0,b:0},end:{r:35,g:139,b:69}},RdLrGr:{start:{r:215,g:25,b:28},middle:{r:254,g:229,b:217},end:{r:35,g:139,b:69}}};this.objects_ref={tooltip_label:new Kinetic.Label({opacity:1,listening:false}),tooltip_tag:new Kinetic.Tag({fill:this.settings.label_color,pointerWidth:10,pointerHeight:10,lineJoin:"round",listening:false}),tooltip_text:new Kinetic.Text({fontFamily:this.settings.font,fontSize:12,padding:8,fill:"white",fontStyle:"bold",listening:false,align:"center",lineHeight:1.2}),node:new Kinetic.Line({stroke:"grey",strokeWidth:2,lineCap:"sqare",lineJoin:"round",listening:false}),node_rect:new Kinetic.Rect({fill:"white",opacity:0}),icon_overlay:new Kinetic.Rect({width:32,height:32,opacity:0}),heatmap_value:new Kinetic.Text({fontFamily:this.settings.font,fill:this.settings.heatmap_font_color,fontStyle:"bold",listening:false}),heatmap_line:new Kinetic.Line({lineCap:"butt",value:false}),column_header:new Kinetic.Text({fontFamily:this.settings.font,fontStyle:"bold",fill:"black"}),count:new Kinetic.Text({fontSize:20,fontFamily:this.settings.font,fontStyle:"bold",fill:"grey",listening:false}),cluster_overlay:new Kinetic.Rect({fill:"white",opacity:.5}),cluster_border:new Kinetic.Line({stroke:"black",strokeWidth:1,dash:[6,2]}),icon:new Kinetic.Path({fill:"grey",scale:1}),rect_gradient:new Kinetic.Rect({x:0,y:80,width:100,height:20,fillLinearGradientStartPoint:{x:0,y:80},fillLinearGradientEndPoint:{x:100,y:80},stroke:"#D2D2D2",strokeWidth:"1px"})}};InCHlib.prototype._update_user_settings=function(t){var n={},r;for(var i=0,s=Object.keys(t),o=s.length;i<o;i++){r=s[i];if(this.user_settings[r]!==undefined&&this.user_settings[r]!==t[r]&&this.user_settings[r]===true){n[r]=false}else if(this.user_settings[r]===undefined){n[r]=t[r]}}e.extend(this.settings,n)};InCHlib.prototype.read_data=function(e){this.json=e;this.data=this.json.data;var t={};if(this.json["metadata"]!==undefined){this.metadata=this.json.metadata;t.metadata=true}else{t.metadata=false}if(this.json["column_dendrogram"]!==undefined){this.column_dendrogram=this.json.column_dendrogram;t.column_dendrogram=true}else{t.column_dendrogram=false}if(this.json["column_metadata"]!==undefined){this.column_metadata=this.json.column_metadata;t.column_metadata=true}else{t.column_metadata=false}this._update_user_settings(t);this._add_prefix()};InCHlib.prototype.read_data_from_file=function(t){var n=this;e.ajax({type:"GET",url:t,dataType:"json",success:function(e){n.read_data(e)},async:false})};InCHlib.prototype._add_prefix=function(){var e,t;var n={};for(var e=0,r=Object.keys(this.data.nodes),i=r.length;e<i;e++){t=[this.settings.target,r[e]].join("#");n[t]=this.data.nodes[r[e]];if(n[t]["parent"]!==undefined){n[t].parent=[this.settings.target,n[t].parent].join("#")}if(n[t]["count"]!=1){n[t].left_child=[this.settings.target,n[t].left_child].join("#");n[t].right_child=[this.settings.target,n[t].right_child].join("#")}}this.data.nodes=n;if(this.settings.metadata){var s={};for(var e=0,r=Object.keys(this.metadata.nodes),i=r.length;e<i;e++){t=[this.settings.target,r[e]].join("#");s[t]=this.metadata.nodes[r[e]]}this.metadata.nodes=s}if(this.column_dendrogram){var o={};for(var e=0,r=Object.keys(this.column_dendrogram.nodes),i=r.length;e<i;e++){t=[this.settings.target,r[e]].join("#");o[t]=this.column_dendrogram.nodes[r[e]];if(o[t]["parent"]!==undefined){o[t].parent=[this.settings.target,o[t].parent].join("#")}if(o[t]["count"]!=1){o[t].left_child=[this.settings.target,o[t].left_child].join("#");o[t].right_child=[this.settings.target,o[t].right_child].join("#")}}this.column_dendrogram.nodes=o}return};InCHlib.prototype._get_root_id=function(e){var t;for(var n=0,r=Object.keys(e),i=r.length;n<i;n++){if(e[r[n]]["parent"]===undefined){t=r[n];break}}return t};InCHlib.prototype._get_dimensions=function(){var e={data:0,metadata:0,overall:0},t,n,r;for(r=0,n=Object.keys(this.data.nodes),len=n.length;r<len;r++){t=n[r];if(this.data.nodes[t].count==1){e["data"]=this.data.nodes[t].features.length;break}}if(this.settings.metadata){t=Object.keys(this.metadata.nodes)[0];e["metadata"]=this.metadata.nodes[t].length}e["overall"]=e["data"]+e["metadata"];return e};InCHlib.prototype._get_min_max_middle=function(e){var t,n;var r=[];var i=[];for(t=0,n=e.length;t<n;t++){i=i.concat(e[t].filter(function(e){return e!==null}))}var n=i.length;i.sort(function(e,t){return e-t});r.push(this.settings.min_percentile>0?i[this._hack_round(n*this.settings.min_percentile/100)]:Math.min.apply(null,i));r.push(this.settings.max_percentile<100?i[this._hack_round(n*this.settings.max_percentile/100)]:Math.max.apply(null,i));r.push(this.settings.middle_percentile!=50?i[this._hack_round(n*this.settings.middle_percentile/100)]:this._middle2fnc(i));return r};InCHlib.prototype._get_data_min_max_middle=function(e,t){if(t===undefined){t="column"}var n=this;var r,i,s,o,u;var a=e[0].length;if(t=="column"){u=[];for(r=0;r<a;r++){u.push([])}for(r=0;r<e.length;r++){for(i=0;i<a;i++){s=e[r][i];if(s!==null&&s!==undefined){u[i].push(s)}}}}else{u=e.slice(0)}var f={};var l=[],c,h,p;for(r=0;r<u.length;r++){if(this._is_number(u[r][0])){u[r]=u[r].map(parseFloat);u[r].sort(function(e,t){return e-t});o=u[r].length;h=this.settings.max_percentile<100?u[r][this._hack_round(o*this.settings.max_percentile/100)]:Math.max.apply(null,u[r]);c=this.settings.min_percentile>0?u[r][this._hack_round(o*this.settings.min_percentile/100)]:Math.min.apply(null,u[r]);p=this.settings.middle_percentile!=50?u[r][this._hack_round(o*this.settings.middle_percentile/100)]:this._middle2fnc(u[r]);f[r]={min:c,max:h,middle:p}}else{var d=this._get_hash_object(u[r]);c=0;h=this._hack_size(d)-1;p=h/2;f[r]={min:c,max:h,middle:p,str2num:d}}}return f};InCHlib.prototype._get_hash_object=function(e){var t,n=0,r={};for(t=0;t<e.length;t++){if(r[e[t]]===undefined){r[e[t]]=n;n++}}return r};InCHlib.prototype._get_max_length=function(e){var t=e.map(function(e){return(""+e).length});var n=Math.max.apply(Math,t);return n};InCHlib.prototype._get_max_value_length=function(){var e=this.data.nodes;var t=0;var n,r;for(var i=0,s=Object.keys(e),o=s.length;i<o;i++){r=s[i];if(e[r].count==1){n=e[r].features;for(var u=0,a=n.length;u<a;u++){if((""+n[u]).length>t){t=(""+n[u]).length}}}}if(this.settings.metadata){e=this.metadata.nodes;for(var i=0,s=Object.keys(e),o=s.length;i<o;i++){r=s[i];n=e[r];for(var u=0,a=n.length;u<a;u++){if((""+n[u]).length>t){t=(""+n[u]).length}}}}return t};InCHlib.prototype._preprocess_heatmap_data=function(){var e=[],t,n=0,r,i,s,o,u;for(t=0,r=Object.keys(this.data.nodes),s=r.length;t<s;t++){i=r[t];u=this.data.nodes[i];if(u.count==1){o=u.features;e.push([i]);e[n].push.apply(e[n],o);if(this.settings.metadata){e[n].push.apply(e[n],this.metadata.nodes[i])}n++}}return e};InCHlib.prototype._reorder_heatmap=function(e){this.leaves_y_coordinates={};e++;if(this.ordered_by_index==e){this.heatmap_array.reverse()}else{if(this._is_number(this.heatmap_array[0][e])){this.heatmap_array.sort(function(t,n){return t[e]==null?-1:n[e]==null?1:t[e]-n[e]})}else{this.heatmap_array.sort(function(t,n){return t[e]==null?-1:n[e]==null?1:t[e]>n[e]?1:t[e]<n[e]?-1:0})}}var t=this.pixels_for_leaf/2+this.header_height;for(var n=0,r=this.heatmap_array.length;n<r;n++){this.leaves_y_coordinates[this.heatmap_array[n][0]]=t;t+=this.pixels_for_leaf}this.ordered_by_index=e;return};InCHlib.prototype.draw=function(){this.zoomed_clusters={row:[],column:[]};this.current_object_ids=[];this.heatmap_array=this._preprocess_heatmap_data();if(this.settings.heatmap){this.last_column=null;this.on_features={data:[],metadata:[]};this.dimensions=this._get_dimensions();this.column_metadata_rows=this.settings.column_metadata?this.column_metadata.features.length:0;this.column_metadata_height=this.column_metadata_rows*this.settings.column_metadata_row_height;this._set_heatmap_settings();this._adjust_leaf_size(this.heatmap_array.length)}else{this._adjust_horizontal_sizes();this.dimensions={data:0,metadata:0,overall:0}}if(this.settings.column_dendrogram&&this.heatmap_header){this.footer_height=150}this.stage=new Kinetic.Stage({container:this.settings.target});this.settings.height=this.heatmap_array.length*this.pixels_for_leaf+this.header_height+this.footer_height;this.stage.setWidth(this.settings.width);this.stage.setHeight(this.settings.height);this._draw_stage_layer();if(this.settings.dendrogram){this._draw_dendrogram_layers();this.root_id=this._get_root_id(this.data.nodes);this.distance=this.settings.width-this.heatmap_width-this.right_margin;this._draw_row_dendrogram(this.root_id);this._draw_heatmap();this._draw_heatmap_header();if(this.settings.column_dendrogram&&this.settings.dendrogram){this.column_root_id=this._get_root_id(this.column_dendrogram.nodes);this.nodes2columns=false;this.columns_start_index=0;this._draw_column_dendrogram(this.column_root_id)}}else{this.settings.column_dendrogram=false;this._reorder_heatmap(0);this.ordered_by_index=0;this._draw_heatmap();this._draw_heatmap_header()}this._draw_navigation();this.highlight_rows(this.settings.highlighted_rows)};InCHlib.prototype._draw_dendrogram_layers=function(){this.cluster_layer=new Kinetic.Layer;this.dendrogram_hover_layer=new Kinetic.Layer;this.stage.add(this.cluster_layer,this.dendrogram_hover_layer)};InCHlib.prototype._draw_row_dendrogram=function(e){this.dendrogram_layer=new Kinetic.Layer;var t=this.data.nodes[e];var n=t.count;this.distance_step=this.distance/t.distance;this.last_highlighted_cluster=null;this.leaves_y_coordinates={};this.objects2leaves={};this._adjust_leaf_size(n);this.settings.height=n*this.pixels_for_leaf+this.header_height+this.footer_height+this.column_metadata_height;this.stage.setWidth(this.settings.width);this.stage.setHeight(this.settings.height);var r=0;var i=0;var s=this.header_height+this.column_metadata_height+this.pixels_for_leaf/2;if(t.count>1){r=this.data.nodes[t.left_child].count;i=this.data.nodes[t.right_child].count}this._draw_row_dendrogram_node(e,t,r,i,0,s);this.middle_item_count=(this.min_item_count+this.max_item_count)/2;this._draw_distance_scale(t.distance);this.dendrogram_overlay_layer=new Kinetic.Layer;this.stage.add(this.dendrogram_layer,this.dendrogram_overlay_layer);var o=this;this._bind_dendrogram_hover_events(this.dendrogram_layer);this._bind_dendrogram_hover_events(this.dendrogram_overlay_layer);this.dendrogram_layer.on("click",function(e){o._dendrogram_layers_click(this,e)});this.dendrogram_overlay_layer.on("click",function(e){o._dendrogram_layers_click(this,e)});this.timer=0;this.dendrogram_layer.on("mousedown",function(e){o._dendrogram_layers_mousedown(this,e)});this.dendrogram_layer.on("mouseup",function(e){o._dendrogram_layers_mouseup(this,e)});this.dendrogram_overlay_layer.on("mousedown",function(e){o._dendrogram_layers_mousedown(this,e)});this.dendrogram_overlay_layer.on("mouseup",function(e){o._dendrogram_layers_mouseup(this,e)})};InCHlib.prototype._draw_row_dendrogram_node=function(e,t,n,r,i,s){if(t.count!=1){var o=this._get_node_neighbourhood(t,this.data.nodes);var u=this.data.nodes[t.right_child];var a=this.data.nodes[t.left_child];var f=this._get_y1(o,n,r);var l=this._get_y2(o,n,r);var c=this._hack_round(this.distance-this.distance_step*t.distance);c=c==0?2:c;var h=c;var p=this.distance-this.distance_step*this.data.nodes[t.left_child].distance;var d=this.distance-this.distance_step*this.data.nodes[t.right_child].distance;if(u.count==1){l=l+this.pixels_for_leaf/2}this.dendrogram_layer.add(this._draw_horizontal_path(e,c,f,h,l,p,d));this._draw_row_dendrogram_node(t.left_child,a,n-o.left_node.right_count,r+o.left_node.right_count,p,f);this._draw_row_dendrogram_node(t.right_child,u,n+o.right_node.left_count,r-o.right_node.left_count,d,l)}else{var v=t.objects;this.leaves_y_coordinates[e]=s;for(var m=0,g=v.length;m<g;m++){this.objects2leaves[v[m]]=e}var y=t.objects.length;if(y<this.min_item_count){this.min_item_count=y}if(y>this.max_item_count){this.max_item_count=y}}};InCHlib.prototype._draw_stage_layer=function(){this.stage_layer=new Kinetic.Layer;var e=new Kinetic.Rect({x:0,y:0,width:this.settings.width,height:this.settings.height,opacity:0});this.stage_layer.add(e);e.moveToBottom();this.stage.add(this.stage_layer);var t=this;this.stage_layer.on("click",function(e){t.unhighlight_cluster();t.unhighlight_column_cluster();t.events.empty_space_onclick(e)})};InCHlib.prototype._draw_column_dendrogram=function(e){this.column_dendrogram_layer=new Kinetic.Layer;this.column_x_coordinates={};var t=this.column_dendrogram.nodes[e];this.current_column_count=t.count;this.current_column_ids=[];this.vertical_distance=this.header_height;this.vertical_distance_step=this.vertical_distance/t.distance;this.last_highlighted_column_cluster=null;var n=this.column_dendrogram.nodes[t.left_child].count;var r=this.column_dendrogram.nodes[t.right_child].count;this._draw_column_dendrogram_node(e,t,n,r,0,0);this.stage.add(this.column_dendrogram_layer);if(!this.nodes2columns){this.nodes2columns=this._get_nodes2columns()}this.column_dendrogram_overlay_layer=new Kinetic.Layer;this.stage.add(this.column_dendrogram_overlay_layer);this._bind_dendrogram_hover_events(this.column_dendrogram_layer);this._bind_dendrogram_hover_events(this.column_dendrogram_overlay_layer);var i=this;this.column_dendrogram_layer.on("click",function(e){i._column_dendrogram_layers_click(this,e)});this.column_dendrogram_overlay_layer.on("click",function(e){i._column_dendrogram_layers_click(this,e)});this.column_dendrogram_layer.on("mousedown",function(e){i._column_dendrogram_layers_mousedown(this,e)});this.column_dendrogram_layer.on("mouseup",function(e){i._dendrogram_layers_mouseup(this,e)});this.column_dendrogram_overlay_layer.on("mousedown",function(e){i._column_dendrogram_layers_mousedown(this,e)});this.column_dendrogram_overlay_layer.on("mouseup",function(e){i._dendrogram_layers_mouseup(this,e)})};InCHlib.prototype._get_nodes2columns=function(){var e=[];var t={};var n={};var r,i,s;for(s=0,keys=Object.keys(this.column_x_coordinates),len=keys.length;s<len;s++){r=keys[s];i=this.column_x_coordinates[r];t[i]=r;e.push(i)}e.sort(function(e,t){return e-t});for(s=0,len=e.length;s<len;s++){n[t[e[s]]]=s}return n};InCHlib.prototype._bind_dendrogram_hover_events=function(e){var t=this;e.on("mouseover",function(e){t._dendrogram_layers_mouseover(this,e)});e.on("mouseout",function(e){t._dendrogram_layers_mouseout(this,e)})};InCHlib.prototype._delete_layers=function(e,t){for(var n=0,r=e.length;n<r;n++){if(e[n]!==undefined){e[n].destroy()}}if(t!==undefined){for(var n=0,r=t.length;n<r;n++){t[n].removeChildren();t[n].draw()}}};InCHlib.prototype._delete_all_layers=function(){this.stage.destroyChildren()};InCHlib.prototype._adjust_leaf_size=function(e){this.pixels_for_leaf=(this.settings.max_height-this.header_height-this.footer_height-this.column_metadata_height-5)/e;if(this.pixels_for_leaf>2*this.pixels_for_dimension){this.pixels_for_leaf=2*this.pixels_for_dimension}if(this.pixels_for_leaf>this.settings.max_row_height){this.pixels_for_leaf=this.settings.max_row_height}if(this.settings.min_row_height>this.pixels_for_leaf){this.pixels_for_leaf=this.settings.min_row_height}return};InCHlib.prototype._adjust_horizontal_sizes=function(e){if(e===undefined){e=this._get_visible_count()}this.right_margin=100;if(this.settings.dendrogram){this.heatmap_width=(this.settings.width-this.right_margin-this.dendrogram_heatmap_distance)*this.settings.heatmap_part_width;this.distance=this.settings.width-this.heatmap_width-this.right_margin;this.heatmap_distance=this.distance+this.dendrogram_heatmap_distance}else{this.heatmap_width=this.settings.width-this.right_margin;this.distance=this.right_margin/2;this.heatmap_distance=this.distance}this.pixels_for_dimension=e?this.heatmap_width/e:0;if(this.settings.max_column_width&&this.settings.max_column_width<this.pixels_for_dimension){this.pixels_for_dimension=this.settings.max_column_width;this.heatmap_width=e*this.pixels_for_dimension;if(this.settings.dendrogram){this.distance=this.settings.width-this.heatmap_width-this.right_margin-this.dendrogram_heatmap_distance;this.heatmap_distance=this.distance+this.dendrogram_heatmap_distance}else{this.distance=this._hack_round((this.settings.width-this.heatmap_width)/2);this.right_margin=this.distance;this.heatmap_distance=this.distance}}return};InCHlib.prototype._set_color_settings=function(){var e=[];for(i=0,keys=Object.keys(this.data.nodes),len=keys.length;i<len;i++){node=this.data.nodes[keys[i]];if(node.count==1){e.push(node.features)}}this.data_descs={};if(this.settings.independent_columns){this.data_descs=this._get_data_min_max_middle(e)}else{var t=this._get_min_max_middle(e);for(i=0;i<this.dimensions["data"];i++){this.data_descs[i]={min:t[0],max:t[1],middle:t[2]}}}if(this.settings.metadata){var n=[];for(i=0,keys=Object.keys(this.metadata.nodes),len=keys.length;i<len;i++){n.push(this.metadata.nodes[keys[i]])}this.metadata_descs=this._get_data_min_max_middle(n)}};InCHlib.prototype._set_heatmap_settings=function(){var e,t,n,r,i;this.header=[];for(e=0;e<this.dimensions["overall"];e++){this.header.push("")}this.heatmap_header=false;this.metadata_header=false;this.current_label=null;this._set_color_settings();if(this.data.feature_names!==undefined){this.heatmap_header=this.data.feature_names;for(e=0;e<this.dimensions["data"];e++){this.header[e]=this.heatmap_header[e]}}if(this.settings.metadata){if(this.metadata.feature_names){this.metadata_header=this.metadata.feature_names;for(e=0;e<this.dimensions["metadata"];e++){this.header[this.dimensions["data"]+e]=this.metadata_header[e]}}}if(this.settings.column_metadata){if(this.column_metadata.feature_names!==undefined){this.column_metadata_header=this.column_metadata.feature_names}}if(this.settings.count_column){this.max_item_count=1;this.min_item_count=1;this.dimensions["overall"]++;this.header.push("Count")}this.features={};for(e=0;e<this.dimensions["overall"];e++){this.features[e]=1}this._set_on_features();this._adjust_horizontal_sizes();this.top_heatmap_distance=this.header_height+this.column_metadata_height+this.settings.column_metadata_row_height/2};InCHlib.prototype._set_on_features=function(e){var t;if(e===undefined){var e=[];for(var n=0,r=Object.keys(this.features),i=r.length;n<i;n++){t=r[n];if(this.features[t]===1){e.push(t)}}}this.on_features={data:[],metadata:[],count_column:[]};for(var n=0,i=e.length;n<i;n++){t=e[n];if(t<this.dimensions["data"]){this.on_features["data"].push(t)}else if(t<=this.dimensions["data"]+this.dimensions["metadata"]-1){this.on_features["metadata"].push(t-this.dimensions["data"])}else{this.on_features["count_column"].push(0)}}};InCHlib.prototype._draw_heatmap=function(){if(!this.settings.heatmap||this.dimensions["overall"]==0){return}var e,t,n,r,i,s;this.heatmap_layer=new Kinetic.Layer;this.heatmap_overlay=new Kinetic.Layer;this.current_draw_values=true;this.max_value_length=this._get_max_value_length();this.value_font_size=this._get_font_size(this.max_value_length,this.pixels_for_dimension,this.pixels_for_leaf,12);if(this.value_font_size<4){this.current_draw_values=false}this.heatmap_distance=this._hack_round(this.distance+this.dendrogram_heatmap_distance);var o=this.heatmap_distance;var u=[];var a=this;for(var f=0,l=Object.keys(this.leaves_y_coordinates),c=l.length;f<c;f++){key=l[f];s=this.leaves_y_coordinates[key];e=this._draw_heatmap_row(key,o,s);this.heatmap_layer.add(e);u.push([key,s]);this._bind_row_events(e)}if(this.settings.column_metadata){this.column_metadata_descs=this._get_data_min_max_middle(this.column_metadata.features,"row");y1=this.header_height+.5*this.settings.column_metadata_row_height;for(var f=0,c=this.column_metadata.features.length;f<c;f++){e=this._draw_column_metadata_row(this.column_metadata.features[f],f,o,y1);this.heatmap_layer.add(e);this._bind_row_events(e);y1=y1+this.settings.column_metadata_row_height}}if(this.settings.draw_row_ids){this._draw_row_ids(u)}this.highlighted_rows_layer=new Kinetic.Layer;this.stage.add(this.heatmap_layer,this.heatmap_overlay,this.highlighted_rows_layer);this.highlighted_rows_layer.moveToTop();this.row_overlay=this.objects_ref.heatmap_line.clone();this.column_overlay=this.objects_ref.heatmap_line.clone();var a=this;this.heatmap_layer.on("mouseleave",function(e){a.last_header=null;a.heatmap_overlay.destroyChildren();a.heatmap_overlay.draw();a.events.heatmap_onmouseout(e)})};InCHlib.prototype._draw_heatmap_row=function(e,t,n){var r=this.data.nodes[e];var i=new Kinetic.Group({id:e});var s,o,u,a,f,l,c,h;for(var p=0,d=this.on_features["data"].length;p<d;p++){h=this.on_features["data"][p];s=t+this.pixels_for_dimension;o=n;f=r.features[h];if(f!==null){u=this._get_color_for_value(f,this.data_descs[h]["min"],this.data_descs[h]["max"],this.data_descs[h]["middle"],this.settings.heatmap_colors);a=this.objects_ref.heatmap_line.clone({stroke:u,points:[t,n,s,o],value:f,column:["d",h].join("_"),strokeWidth:this.pixels_for_leaf});i.add(a);if(this.current_draw_values){l=this.objects_ref.heatmap_value.clone({x:this._hack_round((t+s)/2-(""+f).length*(this.value_font_size/4)),y:this._hack_round(n-this.value_font_size/2),fontSize:this.value_font_size,text:f});i.add(l)}}t=s}if(this.settings.metadata){var v=this.metadata.nodes[e];if(v!==undefined){for(var p=0,d=this.on_features["metadata"].length;p<d;p++){h=this.on_features["metadata"][p];f=v[h];s=t+this.pixels_for_dimension;o=n;if(f!==null&&f!==undefined){c=f;if(this.metadata_descs[h]["str2num"]!==undefined){f=this.metadata_descs[h]["str2num"][f]}u=this._get_color_for_value(f,this.metadata_descs[h]["min"],this.metadata_descs[h]["max"],this.metadata_descs[h]["middle"],this.settings.metadata_colors);a=this.objects_ref.heatmap_line.clone({stroke:u,points:[t,n,s,o],value:c,column:["m",h].join("_"),strokeWidth:this.pixels_for_leaf});i.add(a);if(this.current_draw_values){l=this.objects_ref.heatmap_value.clone({text:c,fontSize:this.value_font_size});width=l.getWidth();x=this._hack_round((t+s)/2-width/2);y=this._hack_round(n-this.value_font_size/2);l.position({x:x,y:y});i.add(l)}}t=s}}}if(this.settings.count_column&&this.features[this.dimensions["overall"]-1]==1){s=t+this.pixels_for_dimension;var m=r.objects.length;u=this._get_color_for_value(m,this.min_item_count,this.max_item_count,this.middle_item_count,this.settings.count_column_colors);a=this.objects_ref.heatmap_line.clone({stroke:u,points:[t,n,s,o],value:m,column:"Count",strokeWidth:this.pixels_for_leaf});i.add(a);if(this.current_draw_values){l=this.objects_ref.heatmap_value.clone({text:m});width=l.getWidth();x=this._hack_round((t+s)/2-width/2);y=this._hack_round(n-this.value_font_size/2);l.position({x:x,y:y});i.add(l)}}return i};InCHlib.prototype._draw_column_metadata_row=function(e,t,n,r){var i=new Kinetic.Group({"class":"column_metadata"});var s,o,u,a,f,l,c,h,p;var d=this.column_metadata_descs[t]["str2num"]===undefined?false:true;for(var v=0,m=this.on_features["data"].length;v<m;v++){p=this.on_features["data"][v];f=e[p];c=f;if(d){f=this.column_metadata_descs[t]["str2num"][f]}u=this._get_color_for_value(f,this.column_metadata_descs[t]["min"],this.column_metadata_descs[t]["max"],this.column_metadata_descs[t]["middle"],this.settings.column_metadata_colors);s=n+this.pixels_for_dimension;o=r;a=this.objects_ref.heatmap_line.clone({strokeWidth:this.settings.column_metadata_row_height,stroke:u,value:c,points:[n,r,s,o],column:["cm",t].join("_")});i.add(a);n=s}return i};InCHlib.prototype._bind_row_events=function(e){var t=this;e.on("mouseenter",function(e){t._row_mouseenter(e)});e.on("mouseleave",function(e){t._row_mouseleave(e)});e.on("mouseover",function(e){t._draw_col_label(e)});e.on("mouseout",function(e){t.heatmap_overlay.find("#col_label")[0].destroy()});e.on("click",function(e){var n=e.target.parent.attrs.id;if(e.target.parent.attrs.class!=="column_metadata"){var r=t.data.nodes[n].objects;var s=[];for(i=0;i<r.length;i++){s.push(r[i])}t.events.row_onclick(s,e)}})};InCHlib.prototype._draw_row_ids=function(e){if(this.pixels_for_leaf<6){return}var t,n,r=[],i,s=[],o;for(t=0;t<e.length;t++){i=e[t];n=this.data.nodes[i[0]].objects;if(n.length>1){return}s.push(n[0]);r.push([n[0],i[1]])}var u=this._get_max_length(s);var a=this._get_font_size(u,85,this.pixels_for_leaf,10);var f=this.distance+this._get_visible_count()*this.pixels_for_dimension+15;if(a>4){for(t=0;t<r.length;t++){o=this.objects_ref.heatmap_value.clone({x:f,y:this._hack_round(r[t][1]-a/2),fontSize:a,text:r[t][0],fontStyle:"italic",fill:"gray"});this.heatmap_layer.add(o)}}return};InCHlib.prototype._draw_heatmap_header=function(){if(this.settings.heatmap_header&&this.header.length>0){this.header_layer=new Kinetic.Layer;var e=this._hack_size(this.leaves_y_coordinates);var t=this.settings.column_dendrogram&&this.heatmap_header?this.header_height+this.pixels_for_leaf*e+10+this.column_metadata_height:this.header_height-20;var n=this.settings.column_dendrogram&&this.heatmap_header?45:-45;var r=0;var i,s,o,u;var a=[];for(s=0,len=this.on_features["data"].length;s<len;s++){a.push(this.header[this.on_features["data"][s]])}for(s=0,len=this.on_features["metadata"].length;s<len;s++){a.push(this.header[this.on_features["metadata"][s]+this.dimensions["data"]])}if(this.settings.count_column&&this.features[this.dimensions["overall"]-1]){a.push(this.header[this.dimensions["overall"]-1])}var f=this._get_max_length(a);var l=this._get_font_size(f,this.header_height,this.pixels_for_dimension,16);if(l<8){return}for(s=0,len=a.length;s<len;s++){i=this.heatmap_distance+r*this.pixels_for_dimension+this.pixels_for_dimension/2;o=this.objects_ref.column_header.clone({x:i,y:t,text:a[s],position_index:s,fontSize:l,rotationDeg:n});this.header_layer.add(o);r++}this.stage.add(this.header_layer);if(!this.settings.dendrogram){var c=this;this.header_layer.on("click",function(e){var t=e.target;var n=t.attrs.position_index;for(s=0;s<c.header_layer.getChildren().length;s++){c.header_layer.getChildren()[s].setFill("black")}e.target.setAttrs({fill:"red"});c._delete_layers([c.heatmap_layer,c.heatmap_overlay,c.highlighted_rows_layer]);c._reorder_heatmap(c._translate_column_to_feature_index(n));c._draw_heatmap();c.header_layer.draw()});this.header_layer.on("mouseover",function(e){var t=e.target;t.setOpacity(.7);this.draw()});this.header_layer.on("mouseout",function(e){var t=e.target;t.setOpacity(1);this.draw()})}}};InCHlib.prototype._translate_column_to_feature_index=function(e){var t;var n=-1;for(var r=0,i=Object.keys(this.features),s=i.length;r<s;r++){t=i[r];if(this.features[t]===1){n++;if(e===n){return t}}}};InCHlib.prototype._draw_distance_scale=function(e){var t=this.header_height+this.column_metadata_height+this.settings.column_metadata_row_height/2-10;var n=t;var r=0;var i=this.distance;var s=new Kinetic.Line({points:[r,t,i,n],stroke:"black",listening:false});var o=new Kinetic.Circle({x:i,y:n,radius:3,fill:"black",listening:false});var u=0;var a=3;var f=i;var l=this._hack_round(30/this.distance_step*10)/10;var e=Math.round(100*this.distance/this.distance_step)/100;var c=this._hack_round(this.distance_step*l);var h=0;var p=new Kinetic.Text({x:0,y:t-20,text:e,fontSize:12,fontFamily:this.settings.font,fontStyle:"bold",fill:"black",align:"right",listening:false});this.dendrogram_layer.add(s,o,p);if(c==0){c=.5}var s;if(l>.1){while(f>0){s=new Kinetic.Line({points:[f,t-a,f,n+a],stroke:"black",listening:false});this.dendrogram_layer.add(s);u=this._hack_round((u+l)*10)/10;if(u>10){u=this._hack_round(u)}f=f-c;h++}}};InCHlib.prototype._draw_navigation=function(){this.navigation_layer=new Kinetic.Layer;var e=this;var t=0;var n=10;this._draw_color_scale();if(!this.settings.column_dendrogram){var r=this.objects_ref.icon.clone({data:"M26.834,6.958c0-2.094-4.852-3.791-10.834-3.791c-5.983,0-10.833,1.697-10.833,3.791c0,0.429,0.213,0.84,0.588,1.224l8.662,15.002v4.899c0,0.414,0.709,0.75,1.583,0.75c0.875,0,1.584-0.336,1.584-0.75v-4.816l8.715-15.093h-0.045C26.625,7.792,26.834,7.384,26.834,6.958zM16,9.75c-6.363,0-9.833-1.845-9.833-2.792S9.637,4.167,16,4.167c6.363,0,9.834,1.844,9.834,2.791S22.363,9.75,16,9.75z",x:t,y:n,label:"Filter\ncolumns"});var i=e._draw_icon_overlay(t,n);e.navigation_layer.add(r,i);t=t+40;i.on("click",function(){e._filter_icon_click(this)});i.on("mouseover",function(){e._icon_mouseover(r,i,e.navigation_layer)});i.on("mouseout",function(){e._icon_mouseout(r,i,e.navigation_layer)})}if(e.zoomed_clusters["row"].length>0||e.zoomed_clusters["column"].length>0){var s=this.objects_ref.icon.clone({data:"M24.083,15.5c-0.009,4.739-3.844,8.574-8.583,8.583c-4.741-0.009-8.577-3.844-8.585-8.583c0.008-4.741,3.844-8.577,8.585-8.585c1.913,0,3.665,0.629,5.09,1.686l-1.782,1.783l8.429,2.256l-2.26-8.427l-1.89,1.89c-2.072-1.677-4.717-2.688-7.587-2.688C8.826,3.418,3.418,8.826,3.416,15.5C3.418,22.175,8.826,27.583,15.5,27.583S27.583,22.175,27.583,15.5H24.083z",x:t,y:n,id:"refresh_icon",label:"Refresh"});var o=e._draw_icon_overlay(t,n);e.navigation_layer.add(s,o);o.on("click",function(){e._refresh_icon_click();e.events.on_refresh()});o.on("mouseover",function(){e._icon_mouseover(s,o,e.navigation_layer)});o.on("mouseout",function(){e._icon_mouseout(s,o,e.navigation_layer)})}if(e.zoomed_clusters["row"].length>0){t=this.distance-40;n=this.header_height+this.column_metadata_height-40;var u=this.objects_ref.icon.clone({data:"M22.646,19.307c0.96-1.583,1.523-3.435,1.524-5.421C24.169,8.093,19.478,3.401,13.688,3.399C7.897,3.401,3.204,8.093,3.204,13.885c0,5.789,4.693,10.481,10.484,10.481c1.987,0,3.839-0.563,5.422-1.523l7.128,7.127l3.535-3.537L22.646,19.307zM13.688,20.369c-3.582-0.008-6.478-2.904-6.484-6.484c0.006-3.582,2.903-6.478,6.484-6.486c3.579,0.008,6.478,2.904,6.484,6.486C20.165,17.465,17.267,20.361,13.688,20.369zM8.854,11.884v4.001l9.665-0.001v-3.999L8.854,11.884z",x:t,y:n,scale:{x:.7,y:.7},label:"Unzoom\nrows"});var a=e._draw_icon_overlay(t,n);e.navigation_layer.add(u,a);a.on("click",function(){var t=e.zoomed_clusters["row"][e.zoomed_clusters["row"].length-1];e._unzoom_icon_click(this);e.events.on_unzoom(e._unprefix(t))});a.on("mouseover",function(){e._icon_mouseover(u,a,e.navigation_layer)});a.on("mouseout",function(){e._icon_mouseout(u,a,e.navigation_layer)})}if(e.zoomed_clusters["column"].length>0){t=e.settings.width-85;n=this.header_height-35;var f=this.objects_ref.icon.clone({data:"M22.646,19.307c0.96-1.583,1.523-3.435,1.524-5.421C24.169,8.093,19.478,3.401,13.688,3.399C7.897,3.401,3.204,8.093,3.204,13.885c0,5.789,4.693,10.481,10.484,10.481c1.987,0,3.839-0.563,5.422-1.523l7.128,7.127l3.535-3.537L22.646,19.307zM13.688,20.369c-3.582-0.008-6.478-2.904-6.484-6.484c0.006-3.582,2.903-6.478,6.484-6.486c3.579,0.008,6.478,2.904,6.484,6.486C20.165,17.465,17.267,20.361,13.688,20.369zM8.854,11.884v4.001l9.665-0.001v-3.999L8.854,11.884z",x:t,y:n,scale:{x:.7,y:.7},label:"Unzoom\ncolumns"});var l=e._draw_icon_overlay(t,n);e.navigation_layer.add(f,l);l.on("click",function(){e._column_unzoom_icon_click(this)});l.on("mouseover",function(){e._icon_mouseover(f,l,e.navigation_layer)});l.on("mouseout",function(){e._icon_mouseout(f,l,e.navigation_layer)})}if(e.settings.show_export_button){var c=this.objects_ref.icon.clone({data:"M24.25,10.25H20.5v-1.5h-9.375v1.5h-3.75c-1.104,0-2,0.896-2,2v10.375c0,1.104,0.896,2,2,2H24.25c1.104,0,2-0.896,2-2V12.25C26.25,11.146,25.354,10.25,24.25,10.25zM15.812,23.499c-3.342,0-6.06-2.719-6.06-6.061c0-3.342,2.718-6.062,6.06-6.062s6.062,2.72,6.062,6.062C21.874,20.78,19.153,23.499,15.812,23.499zM15.812,13.375c-2.244,0-4.062,1.819-4.062,4.062c0,2.244,1.819,4.062,4.062,4.062c2.244,0,4.062-1.818,4.062-4.062C19.875,15.194,18.057,13.375,15.812,13.375z",x:e.settings.width-62,y:10,scale:{x:.7,y:.7},id:"export_icon",label:"Export\nin png format"});var h=e._draw_icon_overlay(e.settings.width-62,10);e.navigation_layer.add(c,h);h.on("click",function(){e._export_icon_click(this)});h.on("mouseover",function(){e._icon_mouseover(c,h,e.navigation_layer)});h.on("mouseout",function(){e._icon_mouseout(c,h,e.navigation_layer)})}if(e.settings.show_settings_button){var p=this.objects_ref.icon.clone({data:"M26.834,14.693c1.816-2.088,2.181-4.938,1.193-7.334l-3.646,4.252l-3.594-0.699L19.596,7.45l3.637-4.242c-2.502-0.63-5.258,0.13-7.066,2.21c-1.907,2.193-2.219,5.229-1.039,7.693L5.624,24.04c-1.011,1.162-0.888,2.924,0.274,3.935c1.162,1.01,2.924,0.888,3.935-0.274l9.493-10.918C21.939,17.625,24.918,16.896,26.834,14.693z",x:e.settings.width-62,y:80,id:"settings_icon",label:"Settings"});var d=e._draw_icon_overlay(e.settings.width-62,80);e.navigation_layer.add(p,d);d.on("click",function(t){e._settings_icon_click(this,t)});d.on("mouseover",function(){e._icon_mouseover(p,d,e.navigation_layer)});d.on("mouseout",function(){e._icon_mouseout(p,d,e.navigation_layer)})}e.stage.add(e.navigation_layer)};InCHlib.prototype._draw_color_scale=function(){var e=this;var t=[this.settings.min_percentile/100,this._get_color_for_value(0,0,1,.5,this.settings.heatmap_colors),this.settings.middle_percentile/100,this._get_color_for_value(.5,0,1,.5,this.settings.heatmap_colors),this.settings.max_percentile/100,this._get_color_for_value(1,0,1,.5,this.settings.heatmap_colors)];var n=this.objects_ref.rect_gradient.clone({label:"Color settings",fillLinearGradientColorStops:t,id:"color_scale"});n.on("mouseover",function(){e._color_scale_mouseover(n,e.navigation_layer)});n.on("mouseout",function(){e._color_scale_mouseout(n,e.navigation_layer)});n.on("click",function(){e._color_scale_click(n,e.navigation_layer)});this.navigation_layer.add(n)};InCHlib.prototype._update_color_scale=function(){var e=this.navigation_layer.find("#color_scale");e.fillLinearGradientColorStops([this.settings.min_percentile/100,this._get_color_for_value(0,0,1,.5,this.settings.heatmap_colors),this.settings.middle_percentile/100,this._get_color_for_value(.5,0,1,.5,this.settings.heatmap_colors),this.settings.max_percentile/100,this._get_color_for_value(1,0,1,.5,this.settings.heatmap_colors)]);this.navigation_layer.draw()};InCHlib.prototype._draw_icon_overlay=function(e,t){var n=this.objects_ref.icon_overlay.clone({x:e,y:t});return n};InCHlib.prototype._highlight_path=function(e){var t=this.data.nodes[e];if(t.count!=1){var n=this.dendrogram_layer.get("#"+e)[0].clone({stroke:"#F5273C"});var r=this.dendrogram_layer.get("#"+e+"_rect")[0].clone({path:n,path_id:e});this.dendrogram_overlay_layer.add(n,r);this._highlight_path(t.left_child);this._highlight_path(t.right_child)}else{this.highlighted_rows_y.push(this.leaves_y_coordinates[e])}};InCHlib.prototype._highlight_column_path=function(e){var t=this.column_dendrogram.nodes[e];if(t.count!=1){var n=this.column_dendrogram_layer.get("#col"+e)[0].clone({stroke:"#F5273C"});var r=this.column_dendrogram_layer.get("#col_rect"+e)[0].clone({path:n,path_id:e});this.column_dendrogram_overlay_layer.add(n,r);this._highlight_column_path(t.left_child);this._highlight_column_path(t.right_child)}};InCHlib.prototype.unhighlight_rows=function(){this.highlight_rows([]);return};InCHlib.prototype.highlight_rows=function(e){var t,n,r;if(!this.settings.heatmap){return}this.settings.highlighted_rows=e;this.highlighted_rows_layer.destroyChildren();var i=this.settings.heatmap_colors;var s=this.settings.metadata_colors;this.settings.heatmap_colors=this.settings.highlight_colors;this.settings.metadata_colors=this.settings.highlight_colors;var o={};var u=[];for(t=0;t<e.length;t++){if(this.objects2leaves[e[t]]!==undefined){r=this.objects2leaves[e[t]];if(o[r]===undefined){u.push(r);o[r]=null}}}for(t=0;t<u.length;t++){n=this._draw_heatmap_row(u[t],this.heatmap_distance,this.leaves_y_coordinates[u[t]]);this.highlighted_rows_layer.add(n);n.setAttr("listening",false)}this.highlighted_rows_layer.draw();this.heatmap_overlay.moveToTop();this.settings.heatmap_colors=i;this.settings.metadata_colors=s;var a=this;this.highlighted_rows_layer.on("click",function(e){a.heatmap_layer.fire("click")})};InCHlib.prototype._highlight_cluster=function(e){this.current_object_ids=[];if(this.last_highlighted_cluster){if(this.settings.heatmap){this.row_cluster_group.destroy()}this.dendrogram_overlay_layer.destroyChildren()}this.highlighted_rows_y=[];this.last_highlighted_cluster=e;this._highlight_path(e);this.dendrogram_overlay_layer.draw();this._draw_cluster_layer(e);this._get_object_ids(e);this.events.dendrogram_node_highlight(this.current_object_ids,e);return};InCHlib.prototype._highlight_column_cluster=function(e){if(this.last_highlighted_column_cluster){this.column_cluster_group.destroy();this.column_dendrogram_overlay_layer.destroyChildren()}this.last_highlighted_column_cluster=e;this._highlight_column_path(e);this.column_dendrogram_overlay_layer.draw();this._get_column_ids(e);this._draw_column_cluster_layer(e);this.events.column_dendrogram_node_highlight(this.current_column_ids,this._unprefix(e));return};InCHlib.prototype.unhighlight_column_cluster=function(){if(this.last_highlighted_column_cluster){this.current_column_ids=[];this.column_cluster_group.destroy();this.cluster_layer.draw();this.column_dendrogram_overlay_layer.destroyChildren();this.column_dendrogram_overlay_layer.draw();this.events.column_dendrogram_node_unhighlight(this._unprefix(this.last_highlighted_column_cluster));this.last_highlighted_column_cluster=null}return[]};InCHlib.prototype.highlight_cluster=function(e){return this._highlight_cluster(this._prefix(e))};InCHlib.prototype.highlight_column_cluster=function(e){return this._highlight_column_cluster(this._prefix(e))};InCHlib.prototype.unhighlight_cluster=function(){if(this.last_highlighted_cluster){if(this.settings.heatmap){this.row_cluster_group.destroy();this.cluster_layer.draw()}this.dendrogram_overlay_layer.removeChildren();this.dendrogram_overlay_layer.draw();this.events.dendrogram_node_unhighlight(this.last_highlighted_cluster);this.last_highlighted_cluster=null}return[]};InCHlib.prototype._neutralize_path=function(e){var t=this.data.nodes[e];if(t.count!=1){var n=this.dendrogram_layer.get("#"+e)[0];if(n){n.setStroke("grey");this._neutralize_path(t.right_child);this._neutralize_path(t.left_child)}}};InCHlib.prototype._draw_cluster_layer=function(e){this.row_cluster_group=new Kinetic.Group;var t=this._get_visible_count();var n=this.data.nodes[e].count;var r=this.distance-40;var i=this.header_height+this.column_metadata_height-40;var s=this.objects_ref.count.clone({x:r+20,y:i-5,text:n,fontSize:12,fill:"#6d6b6a"});var o=this.objects_ref.icon.clone({data:"M22.646,19.307c0.96-1.583,1.523-3.435,1.524-5.421C24.169,8.093,19.478,3.401,13.688,3.399C7.897,3.401,3.204,8.093,3.204,13.885c0,5.789,4.693,10.481,10.484,10.481c1.987,0,3.839-0.563,5.422-1.523l7.128,7.127l3.535-3.537L22.646,19.307zM13.688,20.369c-3.582-0.008-6.478-2.904-6.484-6.484c0.006-3.582,2.903-6.478,6.484-6.486c3.579,0.008,6.478,2.904,6.484,6.486C20.165,17.465,17.267,20.361,13.688,20.369zM15.687,9.051h-4v2.833H8.854v4.001h2.833v2.833h4v-2.834h2.832v-3.999h-2.833V9.051z",x:r,y:i,scale:{x:.7,y:.7},label:"Zoom\nrows"});var u=this._draw_icon_overlay(r,i);r=0;var a=t*this.pixels_for_dimension+this.heatmap_distance;var f=this.highlighted_rows_y[0]-this.pixels_for_leaf/2;var l=this.highlighted_rows_y[this.highlighted_rows_y.length-1]+this.pixels_for_leaf/2;var c=this.objects_ref.cluster_overlay.clone({x:r,y:this.header_height+this.column_metadata_height,width:a,height:f-this.header_height-this.column_metadata_height});var h=this.objects_ref.cluster_border.clone({points:[r,f,r+a,f]});var p=this.objects_ref.cluster_overlay.clone({x:r,y:l,width:a,height:this.settings.height-l-this.footer_height+5});var d=this.objects_ref.cluster_border.clone({points:[r,l,r+a,l]});this.row_cluster_group.add(s,c,p,o,u,h,d);this.cluster_layer.add(this.row_cluster_group);this.stage.add(this.cluster_layer);s.moveToTop();this.cluster_layer.draw();var v=this;u.on("mouseover",function(){v._icon_mouseover(o,u,v.cluster_layer)});u.on("mouseout",function(){v._icon_mouseout(o,u,v.cluster_layer)});u.on("click",function(){var e=v.last_highlighted_cluster;v._zoom_cluster(e);v.events.on_zoom(v.current_object_ids,v._unprefix(e))});this.cluster_layer.on("click",function(e){v.unhighlight_cluster();v.unhighlight_column_cluster();v.events.empty_space_onclick(e)})};InCHlib.prototype._draw_column_cluster_layer=function(){this.column_cluster_group=new Kinetic.Group;var e=this.settings.width-85;var t=this.header_height-35;var n=this.objects_ref.count.clone({x:e+20,y:t,text:this.current_column_ids.length,fontSize:12,fill:"#6d6b6a"});var r=this.objects_ref.icon.clone({data:"M22.646,19.307c0.96-1.583,1.523-3.435,1.524-5.421C24.169,8.093,19.478,3.401,13.688,3.399C7.897,3.401,3.204,8.093,3.204,13.885c0,5.789,4.693,10.481,10.484,10.481c1.987,0,3.839-0.563,5.422-1.523l7.128,7.127l3.535-3.537L22.646,19.307zM13.688,20.369c-3.582-0.008-6.478-2.904-6.484-6.484c0.006-3.582,2.903-6.478,6.484-6.486c3.579,0.008,6.478,2.904,6.484,6.486C20.165,17.465,17.267,20.361,13.688,20.369zM15.687,9.051h-4v2.833H8.854v4.001h2.833v2.833h4v-2.834h2.832v-3.999h-2.833V9.051z",x:e,y:t,scale:{x:.7,y:.7},label:"Zoom\ncolumns"});var i=this._draw_icon_overlay(e,t);var s=this._hack_round((this.current_column_ids[0]-this.columns_start_index)*this.pixels_for_dimension);var o=this._hack_round((this.current_column_ids[0]+this.current_column_ids.length-this.columns_start_index)*this.pixels_for_dimension);var u=0;var a=this.settings.height-this.footer_height+5;var f=this.settings.height-this.footer_height-this.header_height+this.settings.column_metadata_row_height;var l=this.objects_ref.cluster_border.clone({points:[this.heatmap_distance+s,u,this.heatmap_distance+s,a]});var c=this.objects_ref.cluster_overlay.clone({x:this.heatmap_distance,y:this.header_height,width:s,height:f});var h=this.objects_ref.cluster_border.clone({points:[this.heatmap_distance+o,u,this.heatmap_distance+o,a]});var p=this.objects_ref.cluster_overlay.clone({x:o+this.heatmap_distance,y:this.header_height,width:this.heatmap_width-o-(this.on_features["metadata"].length+this.on_features["count_column"].length)*this.pixels_for_dimension,height:f});this.column_cluster_group.add(c,p,r,i,n,l,h);this.cluster_layer.add(this.column_cluster_group);this.stage.add(this.cluster_layer);this.cluster_layer.draw();var d=this;i.on("mouseover",function(){d._icon_mouseover(r,i,d.cluster_layer)});i.on("mouseout",function(){d._icon_mouseout(r,i,d.cluster_layer)});i.on("click",function(){d._zoom_column_cluster(d.last_highlighted_column_cluster)});this.cluster_layer.on("click",function(e){d.unhighlight_cluster();d.unhighlight_column_cluster();d.events.empty_space_onclick(e)})};InCHlib.prototype._zoom_column_cluster=function(e){if(e!=this.zoomed_clusters["column"][this.zoomed_clusters["column"].length-1]){if(e!==this.column_root_id){this.zoomed_clusters["column"].push(e)}this._get_column_ids(e);this.events.on_columns_zoom(this.current_column_ids,this._unprefix(e));this.columns_start_index=this.current_column_ids[0];this.on_features["data"]=this.current_column_ids;var t=this.distance;this._adjust_horizontal_sizes();this._delete_layers([this.column_dendrogram_layer,this.column_dendrogram_overlay_layer,this.heatmap_layer,this.heatmap_overlay,this.cluster_layer,this.navigation_layer,this.highlighted_rows_layer],[this.dendrogram_hover_layer]);if(this.settings.heatmap_header){this._delete_layers([this.header_layer])}this._draw_column_dendrogram(e);this._draw_heatmap();this._draw_heatmap_header();this._draw_navigation();this.highlight_rows(this.settings.highlighted_rows);var n=this.last_highlighted_cluster;if(t!==this.distance){this._delete_layers([this.dendrogram_layer,this.dendrogram_overlay_layer]);var r=this.zoomed_clusters["row"].length>0?this.zoomed_clusters["row"][this.zoomed_clusters["row"].length-1]:this.root_id;this._draw_row_dendrogram(r)}if(n!==null){this._highlight_cluster(n)}}};InCHlib.prototype._zoom_cluster=function(e,t){if(e!=this.zoomed_clusters["row"][this.zoomed_clusters["row"].length-1]){this.current_object_ids=[];this._get_object_ids(e);if(e!==this.root_id){this.zoomed_clusters["row"].push(e)}this._delete_layers([this.dendrogram_layer,this.dendrogram_overlay_layer,this.heatmap_layer,this.heatmap_overlay,this.cluster_layer,this.navigation_layer,this.header_layer,this.highlighted_rows_layer],[this.dendrogram_hover_layer]);this._draw_row_dendrogram(e);this._draw_heatmap();this._draw_heatmap_header();this._draw_navigation();if(this.settings.column_dendrogram&&this.last_highlighted_column_cluster!==null){this._draw_column_cluster_layer(this.last_highlighted_column_cluster)}this.highlight_rows(this.settings.highlighted_rows)}};InCHlib.prototype._get_node_neighbourhood=function(e,t){var n=this;var r={left_node:{left_node:{left_count:0,right_count:0},right_node:{left_count:0,right_count:0},left_count:.5,right_count:.5},right_node:{left_node:{left_count:0,right_count:0},right_node:{left_count:0,right_count:0},left_count:.5,right_count:.5},left_count:t[e.left_child].count,right_count:t[e.right_child].count};var i=t[e.left_child];var s=t[e.right_child];var o=t[i.left_child];var u=t[i.right_child];var a=t[s.left_child];var f=t[s.right_child];if(i.count!=1){r.left_node.left_count=t[i.left_child].count;r.left_node.right_count=t[i.right_child].count;if(o.count!=1){r.left_node.left_node.left_count=t[o.left_child].count;r.left_node.left_node.right_count=t[o.right_child].count}else{r.left_node.left_node.left_count=.5;r.left_node.left_node.right_count=.5}if(u.count!=1){r.left_node.right_node.left_count=t[u.left_child].count;r.left_node.right_node.right_count=t[u.right_child].count}else{r.left_node.right_node.left_count=.5;r.left_node.right_node.right_count=.5}}if(s.count!=1){r.right_node.left_count=t[s.left_child].count;r.right_node.right_count=t[s.right_child].count;if(a.count!=1){r.right_node.left_node.left_count=t[a.left_child].count;r.right_node.left_node.right_count=t[a.right_child].count}else{r.right_node.left_node.left_count=.5;r.right_node.left_node.right_count=.5}if(f.count!=1){r.right_node.right_node.left_count=t[f.left_child].count;r.right_node.right_node.right_count=t[f.right_child].count}else{r.right_node.right_node.left_count=.5;r.right_node.right_node.right_count=.5}}return r};InCHlib.prototype._draw_column_dendrogram_node=function(e,t,n,r,i,s){if(t.count>1){var o=this._get_node_neighbourhood(t,this.column_dendrogram.nodes);var u=this.column_dendrogram.nodes[t.right_child];var a=this.column_dendrogram.nodes[t.left_child];var f=this._get_x1(o,n,r);var l=this._get_x2(o,n,r);var c=this._hack_round(this.vertical_distance-this.vertical_distance_step*t.distance);c=c==0?2:c;var h=c;if(u.count==1){l=l-this.pixels_for_dimension/2}var p=this.vertical_distance-this.vertical_distance_step*this.column_dendrogram.nodes[t.left_child].distance;var d=this.vertical_distance-this.vertical_distance_step*this.column_dendrogram.nodes[t.right_child].distance;this.column_dendrogram_layer.add(this._draw_vertical_path(e,f,c,l,h,p,d));this._draw_column_dendrogram_node(t.left_child,a,n-o.left_node.right_count,r+o.left_node.right_count,p,c);this._draw_column_dendrogram_node(t.right_child,u,n+o.right_node.left_count,r-o.right_node.left_count,d,h)}else{this.column_x_coordinates[e]=r*this.pixels_for_dimension}};InCHlib.prototype._get_y1=function(e,t,n){t=t-e.left_node.right_count-e.left_node.left_node.right_count;var r=(t+(e.left_node.left_node.right_count+e.left_node.right_node.left_count)/2)*this.pixels_for_leaf;return r+this.top_heatmap_distance};InCHlib.prototype._get_y2=function(e,t,n){t=t+e.right_node.left_node.left_count;var r=(t+(e.right_node.left_node.right_count+e.right_node.right_node.left_count)/2)*this.pixels_for_leaf;return r+this.top_heatmap_distance};InCHlib.prototype._get_x1=function(e,t,n){t=t-e.left_node.right_count-e.left_node.left_node.right_count;var r=(t+(e.left_node.left_node.right_count+e.left_node.right_node.left_count)/2)*this.pixels_for_dimension;return this.heatmap_distance+this.on_features["data"].length*this.pixels_for_dimension-r};InCHlib.prototype._get_x2=function(e,t,n){t=t+e.right_node.left_node.left_count;var r=(t+(e.right_node.left_node.right_count+e.right_node.right_node.left_count)/2)*this.pixels_for_dimension;return this.heatmap_distance+this.on_features["data"].length*this.pixels_for_dimension-r};InCHlib.prototype._draw_vertical_path=function(e,t,n,r,i,s,o){var u=new Kinetic.Group({});var a=this.objects_ref.node.clone({points:[t,s,t,n,r,i,r,o],id:"col"+e});var f=this.objects_ref.node_rect.clone({x:r-1,y:n-1,width:t-r+2,height:this.header_height-n,id:"col_rect"+e,path:a,path_id:e});u.add(a,f);return u};InCHlib.prototype._draw_horizontal_path=function(e,t,n,r,i,s,o){var u=new Kinetic.Group({});var a=this.objects_ref.node.clone({points:[s,n,t,n,r,i,o,i],id:e});var f=this.objects_ref.node_rect.clone({x:t-1,y:n-1,width:this.distance-t,height:i-n,id:[e,"rect"].join("_"),path:a,path_id:e});u.add(a,f);return u};InCHlib.prototype._filter_icon_click=function(t){var n=this;var r=this.target_element.find(".filter_features");var i="✖";if(r.length){r.fadeIn("fast");var s=n._draw_target_overlay()}else{filter_list="";for(var o in n.header){if(n.features[o]==1){i="✔"}if(o<n.dimensions){var u=n.header[o];if(u==""){u=parseInt(o)+1+". column"}filter_list=filter_list+"<li class='feature_switch' data-num='"+o+"'><span class='symbol'>"+i+"</span>  "+u+"</li>"}}n.target_element.append("<div class='filter_features'><ul>"+filter_list+"</ul><hr /><div><span class='cancel_filter_list'>Cancel</span>&nbsp;&nbsp;&nbsp;<span class='update_filter_list'>Update</span></div></div>");r=n.target_element.find(".filter_features");r.css({display:"none",top:45,left:0,"border-radius":"5px","text-align":"center",position:"absolute","background-color":"#ffffff",border:"solid 2px #DEDEDE","padding-top":"5px","padding-left":"15px","padding-bottom":"10px","padding-right":"15px","font-weight":"bold","font-size":"14px","z-index":1e3,"font-family":n.settings.font});r.find("ul").css({"list-style-type":"none","margin-left":"0","padding-left":"0","text-align":"left"});r.find("li").css({color:"green","margin-top":"5px"});r.find("div").css({cursor:"pointer",opacity:"0.7"});var s=n._draw_target_overlay();r.fadeIn("fast");n.target_element.find(".feature_switch").click(function(){var t=parseInt(e(this).attr("data-num"));var r=e(this).find("span");n.features[t]=-n.features[t];if(n.features[t]==1){r.text("✔");e(this).css("color","green")}else{r.text("✖");e(this).css("color","red")}n._set_on_features()});e(function(){r.click(function(){return false});r.mousedown(function(){return false});e("#"+n.settings.target+" .filter_features ul li,"+"#"+n.settings.target+" .filter_features div span").hover(function(){e(this).css({cursor:"pointer",opacity:"0.7"})},function(){e(this).css({cursor:"default",opacity:"1"})})});n.target_element.find(".cancel_filter_list").click(function(){r.fadeOut("fast");s.fadeOut("fast")});s.click(function(){r.fadeOut("fast");s.fadeOut("fast")});n.target_element.find(".update_filter_list").click(function(){r.fadeOut("slow");s.fadeOut("slow");var e=n.zoomed_clusters["row"].length>0?n.zoomed_clusters["row"][n.zoomed_clusters["row"].length-1]:n.root_id;var t=n.last_highlighted_cluster;n.last_highlighted_cluster=null;n._adjust_horizontal_sizes();n._delete_all_layers();n._draw_stage_layer();if(n.settings.dendrogram){n._draw_row_dendrogram(e);if(n.settings.column_dendrogram&&n._visible_features_equal_column_dendrogram_count()){n._draw_column_dendrogram(n.column_root_id)}}n._draw_navigation();n._draw_heatmap();n._draw_heatmap_header();if(t!=null){n._highlight_cluster(t)}})}};InCHlib.prototype._draw_target_overlay=function(){var t=this.target_element.find(".target_overlay");if(t.length){t.fadeIn("fast")}else{t=e("<div class='target_overlay'></div>");t.css({"background-color":"white",position:"absolute",top:0,left:0,right:0,bottom:0,opacity:.5});this.target_element.append(t)}return t};InCHlib.prototype._refresh_icon_click=function(){this.redraw()};InCHlib.prototype._export_icon_click=function(){function s(t){e('<a download="inchlib" href="'+t+'"></a>')[0].click()}function o(e){window.open(e,"_blank")}var t=this;var n=this.target_element.find(".export_menu");var r=this._draw_target_overlay();if(n.length){n.fadeIn("fast")}else{n=e("<div class='export_menu'><div><button type='submit' data-action='open'>Show image</button></div><div><button type='submit' data-action='save'>Save image</button></div></div>");this.target_element.append(n);n.css({position:"absolute",top:45,left:t.settings.width-125,"font-size":"12px",border:"solid #D2D2D2 1px","border-radius":"5px",padding:"2px","background-color":"white"});var i=n.find("button");i.css({"padding-top":"7px","padding-bottom":"5px","padding-right":"8px","padding-left":"8px",color:"white",border:"solid #D2D2D2 1px",width:"100%","background-color":"#2171b5","font-weight":"bold"});i.hover(function(){e(this).css({cursor:"pointer",opacity:.7})},function(){e(this).css({opacity:1})});r.click(function(){n.fadeOut("fast");r.fadeOut("fast")});i.click(function(){var n=e(this).attr("data-action");var i=3;var u=t.stage.width();var a=t.stage.height();var f=e("<h3 style='margin-top: 100px; margin-left: 100px; width: "+u+"px; height: "+a+"px;'>Loading...</h3>");t.target_element.after(f);t.target_element.hide();t.stage.width(u*i);t.stage.height(a*i);t.stage.scale({x:i,y:i});t.stage.draw();t.navigation_layer.hide();t.stage.toDataURL({quality:1,callback:function(e){if(n==="open"){o(e)}else{s(e)}t.stage.width(u);t.stage.height(a);t.stage.scale({x:1,y:1});t.stage.draw();f.remove();t.target_element.show();t.navigation_layer.show();t.navigation_layer.draw();r.trigger("click")}})})}};InCHlib.prototype._color_scale_click=function(t,n){var r=this;var i,s,o,u;var a={heatmap_colors:"Heatmap data colors"};var f={max_percentile:"Max percentile value",min_percentile:"Min percentile value",middle_percentile:"Middle percentile value"};if(this.settings.metadata){a["metadata_colors"]="Metadata colors"}if(this.settings.column_metadata){a["column_metadata_colors"]="Column metadata colors"}var l="settings_form_"+this.settings.target;var c=e("#"+l);var h=this._draw_target_overlay();if(c.length){c.fadeIn("fast")}else{c=e("<form class='settings_form' id='"+l+"'></form>");var p="",d,v,m;for(i=0,keys=Object.keys(a),len=keys.length;i<len;i++){o=keys[i];d=this._get_color_for_value(0,0,1,.5,this.settings[o]);v=this._get_color_for_value(.5,0,1,.5,this.settings[o]);m=this._get_color_for_value(1,0,1,.5,this.settings[o]);s="<div><div class='form_label'>"+a[o]+"</div><input type='text' name='"+o+"' value='"+this.settings[o]+"'/> <div class='color_button' style='background: linear-gradient(to right, "+d+","+v+","+m+")'></div></div>";p+=s}for(i=0,keys=Object.keys(f),len=keys.length;i<len;i++){o=keys[i];s="<div><div class='form_label'>"+f[o]+"</div><input type='text' name='"+o+"' value='"+this.settings[o]+"'/></div>";p+=s}s="<div><div class='form_label'>Heatmap coloring</div>                <select name='independent_columns'>";if(this.settings.independent_columns){s+="<option value='true' selected>By columns</option>                  <option value='false'>Entire heatmap</option>"}else{s+="<option value='true'>By columns</option>                  <option value='false' selected>Entire heatmap</option>"}s+="</select></div>";p+=s;p=p+'<button type="submit">Redraw</button>';c.html(p);this.target_element.append(c);c.css({"z-index":1e3,position:"absolute",top:110,left:0,padding:"10px",border:"solid #D2D2D2 2px","border-radius":"5px","background-color":"white"});e("#"+l+" .color_button").css({border:"solid #D2D2D2 1px",height:"15px",width:"30px",display:"inline-block"});e("#"+l+" > div").css({"font-size":"12px","margin-bottom":"10px"});e("#"+l+" input").css({"border-radius":"5px",width:"100px"});e("#"+l+" .form_label").css({color:"gray","margin-bottom":"5px","font-style":"italic"});e("#"+l+" button").css({"padding-top":"7px","padding-bottom":"5px","padding-right":"5px","padding-left":"5px",color:"white",border:"solid #D2D2D2 1px","border-radius":"5px",width:"100%","background-color":"#2171b5","font-weight":"bold"});h.click(function(){c.fadeOut("fast");h.fadeOut("fast")});var g=e("#"+l+" .color_button");g.hover(function(){e(this).css({cursor:"pointer",opacity:.7})},function(){e(this).css({opacity:1})});g.click(function(e){r._draw_color_scales_select(this,e)});c.submit(function(t){var n={};var i=e(this).find("input, select");i.each(function(){s=e(this);o=s.attr("name");u=s.val();if(u!=""){if(u==="true"){u=true}else if(u==="false"){u=false}n[o]=u}});r.update_settings(n);r.redraw_heatmap();r._update_color_scale();h.trigger("click");t.preventDefault();t.stopPropagation()})}};InCHlib.prototype._draw_color_scales_select=function(t,n){var r=this.target_element.find(".color_scales");var i;var s=this;if(r.length){r.fadeIn("fast");i=r.find(".color_scale")}else{r=e("<div class='color_scales'></div>");var o,u,a,f,l;for(var c=0,h=Object.keys(this.colors),p=h.length;c<p;c++){l=h[c];u=this._get_color_for_value(0,0,1,.5,l);a=this._get_color_for_value(.5,0,1,.5,l);f=this._get_color_for_value(1,0,1,.5,l);o="<div class='color_scale' data-scale_acronym='"+l+"' style='background: linear-gradient(to right, "+u+","+a+","+f+")'></div>";r.append(o)}this.target_element.append(r);r.css({border:"solid #D2D2D2 2px","border-radius":"5px",padding:"5px",position:"absolute",top:110,left:170,"background-color":"white"});i=this.target_element.find(".color_scale");i.css({"margin-top":"3px",width:"80px",height:"20px",border:"solid #D2D2D2 1px"});i.hover(function(){e(this).css({cursor:"pointer",opacity:.7})},function(){e(this).css({opacity:1})});this.target_element.find(".target_overlay").click(function(){r.fadeOut("fast")})}i.on("click",function(){var n=e(this).attr("data-scale_acronym");var o=e(t).prev("input:first").val(n);e(t).css({background:"linear-gradient(to right, "+s._get_color_for_value(0,0,1,.5,n)+","+s._get_color_for_value(.5,0,1,.5,n)+","+s._get_color_for_value(1,0,1,.5,n)+")"});r.fadeOut("fast");i.off("click")})};InCHlib.prototype._color_scale_mouseover=function(e,t){var n=e.getAttr("label");var r=e.getAttr("x");var i=e.getAttr("y");this.icon_tooltip=this.objects_ref.tooltip_label.clone({x:r,y:i+25});this.icon_tooltip.add(this.objects_ref.tooltip_tag.clone());this.icon_tooltip.add(this.objects_ref.tooltip_text.clone({text:n}));t.add(this.icon_tooltip);this.icon_tooltip.moveToTop();e.setOpacity(.7);t.draw()};InCHlib.prototype._color_scale_mouseout=function(e,t){this.icon_tooltip.destroy();e.setOpacity(1);t.draw()};InCHlib.prototype._unzoom_icon_click=function(){var e=this.zoomed_clusters["row"].pop();var t=this.zoomed_clusters["row"].length===0?this.root_id:this.zoomed_clusters["row"].pop();this._zoom_cluster(t);this._highlight_cluster(e)};InCHlib.prototype._column_unzoom_icon_click=function(){var e=this.zoomed_clusters["column"].pop();this.events.on_columns_unzoom(this._unprefix(e));var t=this.zoomed_clusters["column"].length===0?this.column_root_id:this.zoomed_clusters["column"].pop();this._zoom_column_cluster(t);this._highlight_column_cluster(e)};InCHlib.prototype._icon_mouseover=function(e,t,n){var r=e.getAttr("label");var i=t.getAttr("x");var s=t.getAttr("y");var o=t.getWidth();var u=t.getHeight();if(e.getAttr("id")==="export_icon"){i=i-50}this.icon_tooltip=this.objects_ref.tooltip_label.clone({x:i,y:s+1.2*u});this.icon_tooltip.add(this.objects_ref.tooltip_tag.clone());this.icon_tooltip.add(this.objects_ref.tooltip_text.clone({text:r}));n.add(this.icon_tooltip);e.setFill("black");n.draw()};InCHlib.prototype._icon_mouseout=function(e,t,n){this.icon_tooltip.destroy();e.setFill("grey");n.draw()};InCHlib.prototype._dendrogram_layers_click=function(e,t){var n=t.target.attrs.path_id;e.fire("mouseout",e,t);if(n!=this.last_highlighted_cluster){this._highlight_cluster(n)}else{this.unhighlight_cluster()}e.draw();this.events.dendrogram_node_onclick(this.current_object_ids,this._unprefix(n),t)};InCHlib.prototype._column_dendrogram_layers_click=function(e,t){var n=[];var r=t.target.attrs.path_id;e.fire("mouseout",e,t);if(r!=this.last_highlighted_column_cluster){n=this._highlight_column_cluster(r)}else{this.unhighlight_column_cluster()}e.draw();this.events.column_dendrogram_node_onclick(this.current_column_ids,this._unprefix(r),t)};InCHlib.prototype._dendrogram_layers_mousedown=function(e,t){var n=this;var r=t.target.attrs.path_id;clearTimeout(this.timer);this.timer=setTimeout(function(){n.last_highlighted_cluster=r;n._zoom_cluster(r);n.events.on_zoom(n.current_object_ids,n._unprefix(r))},700)};InCHlib.prototype._column_dendrogram_layers_mousedown=function(e,t){var n=this;var r=t.target.attrs.path_id;clearTimeout(this.timer);this.timer=setTimeout(function(){n.last_highlighted_column_cluster=r;n._zoom_column_cluster(r)},700)};InCHlib.prototype._dendrogram_layers_mouseup=function(e,t){clearTimeout(this.timer)};InCHlib.prototype._dendrogram_layers_mouseout=function(e,t){this.path_overlay.destroy();this.dendrogram_hover_layer.draw()};InCHlib.prototype._dendrogram_layers_mouseover=function(e,t){this.path_overlay=t.target.attrs.path.clone({strokeWidth:4});this.dendrogram_hover_layer.add(this.path_overlay);this.dendrogram_hover_layer.draw()};InCHlib.prototype._visible_features_equal_column_dendrogram_count=function(){if(this.on_features["data"].length+this.on_features["metadata"].length==this.current_column_count){return true}return false};InCHlib.prototype._get_color_for_value=function(e,t,n,r,i){var s=this.colors[i];var o=s["start"];var u=s["end"];if(e>n){return"rgb("+u.r+","+u.g+","+u.b+")"}if(t==n||e<t){return"rgb("+o.r+","+o.g+","+o.b+")"}if(s["middle"]!==undefined){if(e>=r){t=r;o=s["middle"];u=s["end"]}else{n=r;o=s["start"];u=s["middle"]}}var a=(e-t)/(n-t);var f=this._hack_round(o.r+a*(u.r-o.r));var l=this._hack_round(o.g+a*(u.g-o.g));var c=this._hack_round(o.b+a*(u.b-o.b));return"rgb("+f+","+l+","+c+")"};InCHlib.prototype._get_font_size=function(e,t,n,r){var i=n-2;var s=i;if(s/2*e>t-10){s=s/(s/2*e/(t-10))}s=s>i?i:s;s=s>r?r:s;return s};InCHlib.prototype._get_object_ids=function(e){if(this.data.nodes[e]["left_child"]!==undefined){this._get_object_ids(this.data.nodes[e]["left_child"]);this._get_object_ids(this.data.nodes[e]["right_child"])}else{this.current_object_ids.push.apply(this.current_object_ids,this.data.nodes[e]["objects"])}};InCHlib.prototype._get_column_ids=function(e){this.current_column_ids=[];this._collect_column_ids(e);this.current_column_ids.sort(function(e,t){return e-t})};InCHlib.prototype._collect_column_ids=function(e){if(this.column_dendrogram.nodes[e]["left_child"]!==undefined){this._collect_column_ids(this.column_dendrogram.nodes[e]["left_child"]);this._collect_column_ids(this.column_dendrogram.nodes[e]["right_child"])}else{this.current_column_ids.push(this.nodes2columns[e])}};InCHlib.prototype._hack_size=function(e){return Object.keys(e).length};InCHlib.prototype._hack_round=function(e){return.5+e>>0};InCHlib.prototype._middle2fnc=function(e){var t=this;var n={zero:function(e){return 0},median:function(e){e.sort(function(e,t){return e-t});var n=t._hack_round((e.length-1)/2);return e[n]},mean:function(e){var t=e.reduce(function(e,t){return parseFloat(e)+t});return t/e.length}};return n["median"](e)};InCHlib.prototype._is_number=function(e){return!isNaN(parseFloat(e))&&isFinite(e)};InCHlib.prototype._row_mouseenter=function(e){var t=e.target.parent.getAttr("id");var n=this._get_visible_count();if(e.target.parent.attrs.class!=="column_metadata"){this.highlighted_row=t;var r=this.leaves_y_coordinates[t];var i=this.heatmap_distance;this.row_overlay=this.objects_ref.heatmap_line.clone({points:[i,r,i+this.heatmap_width,r],strokeWidth:this.pixels_for_leaf,stroke:"#FFFFFF",opacity:.3,listening:false});this.heatmap_overlay.add(this.row_overlay);this.heatmap_overlay.draw();this.events.row_onmouseover(this.data.nodes[t].objects,e)}};InCHlib.prototype._row_mouseleave=function(e){this.row_overlay.destroy();this.events.row_onmouseout(e)};InCHlib.prototype._draw_col_label=function(e){var t,n;var r=e.target.attrs;var i=r.points;var s=this._hack_round((i[0]+i[2])/2);var o=i[1]-.5*this.pixels_for_leaf;var u=r.column.split("_");var a={d:this.heatmap_header[u[1]],m:this.metadata_header[u[1]],Count:"Count"};if(this.column_metadata_header!==undefined){a["cm"]=this.column_metadata_header[u[1]]}var f=r.value;var l=a[u[0]];if(l!==this.last_column){this.column_overlay.destroy();this.last_column=r.column;this.column_overlay=this.objects_ref.heatmap_line.clone({points:[s,this.header_height,s,this.header_height+this.column_metadata_height+(this.heatmap_array.length+.5)*this.pixels_for_leaf],strokeWidth:this.pixels_for_dimension,stroke:"#FFFFFF",opacity:.3,listening:false});this.heatmap_overlay.add(this.column_overlay)}if(l!==undefined){f=[l,f].join("\n")}var c=this.objects_ref.tooltip_label.clone({x:s,y:o,id:"col_label"});c.add(this.objects_ref.tooltip_tag.clone({pointerDirection:"down"}),this.objects_ref.tooltip_text.clone({text:f}));this.heatmap_overlay.add(c);this.heatmap_overlay.moveToTop();this.heatmap_overlay.draw();return};InCHlib.prototype._unprefix=function(e){return e.split(this.settings.target+"#")[1]};InCHlib.prototype._prefix=function(e){return this.settings.target+"#"+e};InCHlib.prototype.get_features_for_object=function(e){if(this.objects2leaves[e]!==undefined){var t=this.objects2leaves[e];return this.data.nodes[t].features}return false};InCHlib.prototype.add_color_scale=function(e,t){this.colors[e]=t;this.target_element.find(".color_scales").remove()};InCHlib.prototype._get_visible_count=function(){var e=this.on_features["data"].length+this.on_features["metadata"].length+this.on_features["count_column"].length;return e};InCHlib.prototype.update_settings=function(t){e.extend(this.settings,t);return};InCHlib.prototype.redraw=function(){this._delete_all_layers();this.draw();return};InCHlib.prototype.redraw_heatmap=function(){this._delete_layers([this.heatmap_layer,this.heatmap_overlay,this.highlighted_rows_layer,this.header_layer]);this._set_color_settings();this._draw_heatmap();this._draw_heatmap_header();this.heatmap_layer.moveToBottom();this.heatmap_layer.moveUp();return};InCHlib.prototype._get_object_ids=function(e){if(this.data.nodes[e]["left_child"]!==undefined){this._get_object_ids(this.data.nodes[e]["left_child"]);this._get_object_ids(this.data.nodes[e]["right_child"])}else{this.current_object_ids.push.apply(this.current_object_ids,this.data.nodes[e]["objects"])}}})(jQuery)