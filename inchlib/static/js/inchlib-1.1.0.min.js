var InCHlib,_this;var _date=new Date;(function(e){InCHlib=function(t){_this=this;_this.user_settings=t;_this.target_element=e("#"+t.target);var n=_this.target_element.width();_this.target_element.css({position:"relative"});_this.settings={target:"YourOwnDivId",heatmap:true,heatmap_header:true,dendrogram:true,metadata:false,column_metadata:false,column_metadata_row_height:8,column_metadata_colors:"RdLrBu",max_height:800,width:n,heatmap_colors:"Greens",heatmap_font_color:"black",heatmap_part_width:.7,column_dendrogram:false,independent_columns:true,metadata_colors:"Reds",highlight_colors:"Oranges",highlighted_rows:[],label_color:"#9E9E9E",count_column:false,count_column_colors:"Reds",min_row_height:false,max_row_height:25,max_column_width:150,font:"Helvetica",draw_row_ids:false,show_export_button:true,max_percentile:100,min_percentile:0,middle_percentile:50};e.extend(_this.settings,t);_this.settings.width=t.max_width&&t.max_width<n?t.max_width:_this.settings.width;_this.settings.heatmap_part_width=_this.settings.heatmap_part_width>.9?.9:_this.settings.heatmap_part_width;_this.header_height=150;_this.footer_height=70;_this.dendrogram_heatmap_distance=5;_this.events={row_onclick:function(e,t){return},row_onmouseover:function(e,t){return},row_onmouseout:function(e){return},dendrogram_node_onclick:function(e,t,n){return},column_dendrogram_node_onclick:function(e,t,n){return},dendrogram_node_highlight:function(e,t){return},column_dendrogram_node_highlight:function(e,t){return},dendrogram_node_unhighlight:function(e){return},column_dendrogram_node_unhighlight:function(e){return},heatmap_onmouseout:function(e){return},on_zoom:function(e,t){return},on_unzoom:function(e){return},on_columns_zoom:function(e,t){return},on_columns_unzoom:function(e){return},on_refresh:function(){return},empty_space_onclick:function(e){return}};_this.colors={YlGn:{start:{r:255,g:255,b:204},end:{r:35,g:132,b:67}},GnBu:{start:{r:240,g:249,b:232},end:{r:43,g:140,b:190}},BuGn:{start:{r:237,g:248,b:251},end:{r:35,g:139,b:69}},PuBu:{start:{r:241,g:238,b:246},end:{r:5,g:112,b:176}},BuPu:{start:{r:237,g:248,b:251},end:{r:136,g:65,b:157}},RdPu:{start:{r:254,g:235,b:226},end:{r:174,g:1,b:126}},PuRd:{start:{r:241,g:238,b:246},end:{r:206,g:18,b:86}},OrRd:{start:{r:254,g:240,b:217},end:{r:215,g:48,b:31}},Purples2:{start:{r:242,g:240,b:247},end:{r:106,g:81,b:163}},Blues:{start:{r:239,g:243,b:255},end:{r:33,g:113,b:181}},Greens:{start:{r:237,g:248,b:233},end:{r:35,g:139,b:69}},Oranges:{start:{r:254,g:237,b:222},end:{r:217,g:71,b:1}},Reds:{start:{r:254,g:229,b:217},end:{r:203,g:24,b:29}},Greys:{start:{r:247,g:247,b:247},end:{r:82,g:82,b:82}},PuOr:{start:{r:230,g:97,b:1},end:{r:94,g:60,b:153}},BrBG:{start:{r:166,g:97,b:26},end:{r:1,g:133,b:113}},RdBu:{start:{r:202,g:0,b:32},end:{r:5,g:113,b:176}},RdGy:{start:{r:202,g:0,b:32},end:{r:64,g:64,b:64}},BuYl:{start:{r:5,g:113,b:176},end:{r:250,g:233,b:42}},YlOrR:{start:{r:255,g:255,b:178},end:{r:227,g:26,b:28},middle:{r:204,g:76,b:2}},YlOrB:{start:{r:255,g:255,b:212},end:{r:5,g:112,b:176},middle:{r:204,g:76,b:2}},PRGn2:{start:{r:123,g:50,b:148},end:{r:0,g:136,b:55},middle:{r:202,g:0,b:32}},PiYG2:{start:{r:208,g:28,b:139},end:{r:77,g:172,b:38},middle:{r:255,g:255,b:178}},YlGnBu:{start:{r:255,g:255,b:204},end:{r:34,g:94,b:168},middle:{r:35,g:132,b:67}},RdYlBu:{start:{r:215,g:25,b:28},end:{r:44,g:123,b:182},middle:{r:255,g:255,b:178}},RdYlGn:{start:{r:215,g:25,b:28},end:{r:26,g:150,b:65},middle:{r:255,g:255,b:178}},BuWhRd:{start:{r:33,g:113,b:181},middle:{r:255,g:255,b:255},end:{r:215,g:25,b:28}},RdLrBu:{start:{r:215,g:25,b:28},middle:{r:254,g:229,b:217},end:{r:44,g:123,b:182}},RdBkGr:{start:{r:215,g:25,b:28},middle:{r:0,g:0,b:0},end:{r:35,g:139,b:69}},RdLrGr:{start:{r:215,g:25,b:28},middle:{r:254,g:229,b:217},end:{r:35,g:139,b:69}}};_this.objects_ref={tooltip_label:new Kinetic.Label({opacity:1,listening:false}),tooltip_tag:new Kinetic.Tag({fill:_this.settings.label_color,pointerWidth:10,pointerHeight:10,lineJoin:"round",listening:false}),tooltip_text:new Kinetic.Text({fontFamily:_this.settings.font,fontSize:12,padding:8,fill:"white",fontStyle:"bold",listening:false,align:"center",lineHeight:1.2}),node:new Kinetic.Line({stroke:"grey",strokeWidth:2,lineCap:"sqare",lineJoin:"round",listening:false}),node_rect:new Kinetic.Rect({fill:"white",opacity:0}),icon_overlay:new Kinetic.Rect({width:32,height:32,opacity:0}),heatmap_value:new Kinetic.Text({fontFamily:_this.settings.font,fill:_this.settings.heatmap_font_color,fontStyle:"bold",listening:false}),heatmap_line:new Kinetic.Line({lineCap:"butt",value:false}),column_header:new Kinetic.Text({fontFamily:_this.settings.font,fontStyle:"bold",fill:"black"}),count:new Kinetic.Text({fontSize:10,fill:"#6d6b6a",fontFamily:_this.settings.font,fontStyle:"bold",listening:false}),cluster_overlay:new Kinetic.Rect({fill:"white",opacity:.5}),cluster_border:new Kinetic.Line({stroke:"black",strokeWidth:1,dash:[6,2]}),icon:new Kinetic.Path({fill:"grey"}),rect_gradient:new Kinetic.Rect({x:0,y:80,width:100,height:20,fillLinearGradientStartPoint:{x:0,y:80},fillLinearGradientEndPoint:{x:100,y:80},stroke:"#D2D2D2",strokeWidth:"1px"})};_this.paths_ref={zoom_icon:"M22.646,19.307c0.96-1.583,1.523-3.435,1.524-5.421C24.169,8.093,19.478,3.401,13.688,3.399C7.897,3.401,3.204,8.093,3.204,13.885c0,5.789,4.693,10.481,10.484,10.481c1.987,0,3.839-0.563,5.422-1.523l7.128,7.127l3.535-3.537L22.646,19.307zM13.688,20.369c-3.582-0.008-6.478-2.904-6.484-6.484c0.006-3.582,2.903-6.478,6.484-6.486c3.579,0.008,6.478,2.904,6.484,6.486C20.165,17.465,17.267,20.361,13.688,20.369zM15.687,9.051h-4v2.833H8.854v4.001h2.833v2.833h4v-2.834h2.832v-3.999h-2.833V9.051z",unzoom_icon:"M22.646,19.307c0.96-1.583,1.523-3.435,1.524-5.421C24.169,8.093,19.478,3.401,13.688,3.399C7.897,3.401,3.204,8.093,3.204,13.885c0,5.789,4.693,10.481,10.484,10.481c1.987,0,3.839-0.563,5.422-1.523l7.128,7.127l3.535-3.537L22.646,19.307zM13.688,20.369c-3.582-0.008-6.478-2.904-6.484-6.484c0.006-3.582,2.903-6.478,6.484-6.486c3.579,0.008,6.478,2.904,6.484,6.486C20.165,17.465,17.267,20.361,13.688,20.369zM8.854,11.884v4.001l9.665-0.001v-3.999L8.854,11.884z",lightbulb:"M15.5,2.833c-3.866,0-7,3.134-7,7c0,3.859,3.945,4.937,4.223,9.499h5.553c0.278-4.562,4.224-5.639,4.224-9.499C22.5,5.968,19.366,2.833,15.5,2.833zM15.5,28.166c1.894,0,2.483-1.027,2.667-1.666h-5.334C13.017,27.139,13.606,28.166,15.5,28.166zM12.75,25.498h5.5v-5.164h-5.5V25.498z"}};InCHlib.prototype._update_user_settings=function(t){var n={},r;for(var i=0,s=Object.keys(t),o=s.length;i<o;i++){r=s[i];if(_this.user_settings[r]!==undefined&&_this.user_settings[r]!==t[r]&&_this.user_settings[r]===true){n[r]=false}else if(_this.user_settings[r]===undefined){n[r]=t[r]}}e.extend(_this.settings,n)};InCHlib.prototype.read_data=function(e){_this.json=e;_this.data=_this.json.data;var t={};if(_this.json["metadata"]!==undefined){_this.metadata=_this.json.metadata;t.metadata=true}else{t.metadata=false}if(_this.json["column_dendrogram"]!==undefined){_this.column_dendrogram=_this.json.column_dendrogram;t.column_dendrogram=true}else{t.column_dendrogram=false}if(_this.json["column_metadata"]!==undefined){_this.column_metadata=_this.json.column_metadata;t.column_metadata=true}else{t.column_metadata=false}_this._update_user_settings(t);_this._add_prefix()};InCHlib.prototype.read_data_from_file=function(t){e.ajax({type:"GET",url:t,dataType:"json",success:function(e){_this.read_data(e)},async:false})};InCHlib.prototype._add_prefix=function(){_this.data.nodes=_this._add_prefix_to_data(_this.data.nodes);if(_this.settings.metadata){var e={};for(var t=0,n=Object.keys(_this.metadata.nodes),r=n.length;t<r;t++){id=[_this.settings.target,n[t]].join("#");e[id]=_this.metadata.nodes[n[t]]}_this.metadata.nodes=e}if(_this.column_dendrogram){_this.column_dendrogram.nodes=_this._add_prefix_to_data(_this.column_dendrogram.nodes)}};InCHlib.prototype._add_prefix_to_data=function(e){var t,n={};for(var r=0,i=Object.keys(e),s=i.length;r<s;r++){t=[_this.settings.target,i[r]].join("#");n[t]=e[i[r]];if(n[t]["parent"]!==undefined){n[t].parent=[_this.settings.target,n[t].parent].join("#")}if(n[t]["count"]!=1){n[t].left_child=[_this.settings.target,n[t].left_child].join("#");n[t].right_child=[_this.settings.target,n[t].right_child].join("#")}}return n};InCHlib.prototype._get_root_id=function(e){var t;for(var n=0,r=Object.keys(e),i=r.length;n<i;n++){if(e[r[n]]["parent"]===undefined){t=r[n];break}}return t};InCHlib.prototype._get_dimensions=function(){var e={data:0,metadata:0,overall:0},t,n,r;for(r=0,n=Object.keys(_this.data.nodes),len=n.length;r<len;r++){t=n[r];if(_this.data.nodes[t].count==1){e["data"]=_this.data.nodes[t].features.length;break}}if(_this.settings.metadata){t=Object.keys(_this.metadata.nodes)[0];e["metadata"]=_this.metadata.nodes[t].length}e["overall"]=e["data"]+e["metadata"];return e};InCHlib.prototype._get_min_max_middle=function(e){var t,n;var r=[];var i=[];for(t=0,n=e.length;t<n;t++){i=i.concat(e[t].filter(function(e){return e!==null}))}var n=i.length;i.sort(function(e,t){return e-t});r.push(_this.settings.min_percentile>0?i[_this._hack_round(n*_this.settings.min_percentile/100)]:Math.min.apply(null,i));r.push(_this.settings.max_percentile<100?i[_this._hack_round(n*_this.settings.max_percentile/100)]:Math.max.apply(null,i));r.push(_this.settings.middle_percentile!=50?i[_this._hack_round(n*_this.settings.middle_percentile/100)]:i[_this._hack_round((n-1)/2)]);return r};InCHlib.prototype._get_data_min_max_middle=function(e,t){if(t===undefined){t="column"}var n,r,i,s,o;var u=e[0].length;if(t=="column"){o=[];for(n=0;n<u;n++){o.push([])}for(n=0;n<e.length;n++){for(r=0;r<u;r++){i=e[n][r];if(i!==null&&i!==undefined){o[r].push(i)}}}}else{o=e.slice(0)}var a={};var f=[],l,c,h;for(n=0;n<o.length;n++){if(_this._is_number(o[n][0])){o[n]=o[n].map(parseFloat);o[n].sort(function(e,t){return e-t});s=o[n].length;c=_this.settings.max_percentile<100?o[n][_this._hack_round(s*_this.settings.max_percentile/100)]:Math.max.apply(null,o[n]);l=_this.settings.min_percentile>0?o[n][_this._hack_round(s*_this.settings.min_percentile/100)]:Math.min.apply(null,o[n]);h=_this.settings.middle_percentile!=50?o[n][_this._hack_round(s*_this.settings.middle_percentile/100)]:o[n][_this._hack_round((s-1)/2)];a[n]={min:l,max:c,middle:h}}else{var p=_this._get_hash_object(o[n]);l=0;c=_this._hack_size(p)-1;h=c/2;a[n]={min:l,max:c,middle:h,str2num:p}}}return a};InCHlib.prototype._get_hash_object=function(e){var t,n=0,r={};for(t=0;t<e.length;t++){if(r[e[t]]===undefined){r[e[t]]=n;n++}}return r};InCHlib.prototype._get_max_length=function(e){var t=e.map(function(e){return(""+e).length});var n=Math.max.apply(Math,t);return n};InCHlib.prototype._get_max_value_length=function(){var e=_this.data.nodes;var t=0;var n,r;for(var i=0,s=Object.keys(e),o=s.length;i<o;i++){r=s[i];if(e[r].count==1){n=e[r].features;for(var u=0,a=n.length;u<a;u++){if((""+n[u]).length>t){t=(""+n[u]).length}}}}if(_this.settings.metadata){e=_this.metadata.nodes;for(var i=0,s=Object.keys(e),o=s.length;i<o;i++){r=s[i];n=e[r];for(var u=0,a=n.length;u<a;u++){if((""+n[u]).length>t){t=(""+n[u]).length}}}}return t};InCHlib.prototype._preprocess_heatmap_data=function(){var e=[],t,n=0,r,i,s,o,u;for(t=0,r=Object.keys(_this.data.nodes),s=r.length;t<s;t++){i=r[t];u=_this.data.nodes[i];if(u.count==1){o=u.features;e.push([i]);e[n].push.apply(e[n],o);if(_this.settings.metadata){e[n].push.apply(e[n],_this.metadata.nodes[i])}n++}}return e};InCHlib.prototype._reorder_heatmap=function(e){_this.leaves_y_coordinates={};e++;if(_this.ordered_by_index==e){_this.heatmap_array.reverse()}else{if(_this._is_number(_this.heatmap_array[0][e])){_this.heatmap_array.sort(function(t,n){return t[e]==null?-1:n[e]==null?1:t[e]-n[e]})}else{_this.heatmap_array.sort(function(t,n){return t[e]==null?-1:n[e]==null?1:t[e]>n[e]?1:t[e]<n[e]?-1:0})}}var t=_this.pixels_for_leaf/2+_this.header_height;for(var n=0,r=_this.heatmap_array.length;n<r;n++){_this.leaves_y_coordinates[_this.heatmap_array[n][0]]=t;t+=_this.pixels_for_leaf}_this.ordered_by_index=e};InCHlib.prototype.draw=function(){_this.zoomed_clusters={row:[],column:[]};_this.last_highlighted_cluster=null;_this.current_object_ids=[];_this.current_column_ids=[];_this.heatmap_array=_this._preprocess_heatmap_data();if(_this.settings.heatmap){_this.last_column=null;_this.on_features={data:[],metadata:[]};_this.dimensions=_this._get_dimensions();_this.column_metadata_rows=_this.settings.column_metadata?_this.column_metadata.features.length:0;_this.column_metadata_height=_this.column_metadata_rows*_this.settings.column_metadata_row_height;_this._set_heatmap_settings();_this._adjust_leaf_size(_this.heatmap_array.length)}else{_this._adjust_horizontal_sizes();_this.dimensions={data:0,metadata:0,overall:0}}if(_this.settings.column_dendrogram&&_this.heatmap_header){_this.footer_height=150}_this.stage=new Kinetic.Stage({container:_this.settings.target});_this.settings.height=_this.heatmap_array.length*_this.pixels_for_leaf+_this.header_height+_this.footer_height;_this.stage.setWidth(_this.settings.width);_this.stage.setHeight(_this.settings.height);_this._draw_stage_layer();if(_this.settings.dendrogram){_this.timer=0;_this._draw_dendrogram_layers();_this.root_id=_this._get_root_id(_this.data.nodes);_this._draw_row_dendrogram(_this.root_id);if(_this.settings.column_dendrogram&&_this.settings.dendrogram){_this.column_root_id=_this._get_root_id(_this.column_dendrogram.nodes);_this.nodes2columns=false;_this.columns_start_index=0;_this._draw_column_dendrogram(_this.column_root_id)}}else{_this.settings.column_dendrogram=false;_this._reorder_heatmap(0);_this.ordered_by_index=0}_this._draw_heatmap();_this._draw_heatmap_header();_this._draw_navigation();_this.highlight_rows(_this.settings.highlighted_rows)};InCHlib.prototype._draw_dendrogram_layers=function(){_this.cluster_layer=new Kinetic.Layer;_this.dendrogram_hover_layer=new Kinetic.Layer;_this.stage.add(_this.cluster_layer,_this.dendrogram_hover_layer);_this.cluster_layer.on("click",function(e){_this.unhighlight_cluster();_this.unhighlight_column_cluster();_this.events.empty_space_onclick(e)})};InCHlib.prototype._draw_row_dendrogram=function(e){_this.dendrogram_layer=new Kinetic.Layer;var t=_this.data.nodes[e];var n=t.count;_this.distance_step=_this.distance/t.distance;_this.leaves_y_coordinates={};_this.objects2leaves={};_this._adjust_leaf_size(n);_this.settings.height=n*_this.pixels_for_leaf+_this.header_height+_this.footer_height+_this.column_metadata_height;_this.stage.setWidth(_this.settings.width);_this.stage.setHeight(_this.settings.height);var r=0;var i=0;var s=_this.header_height+_this.column_metadata_height+_this.pixels_for_leaf/2;if(t.count>1){r=_this.data.nodes[t.left_child].count;i=_this.data.nodes[t.right_child].count}_this._draw_row_dendrogram_node(e,t,r,i,0,s);_this.middle_item_count=(_this.min_item_count+_this.max_item_count)/2;_this._draw_distance_scale(t.distance);_this.stage.add(_this.dendrogram_layer);_this._bind_dendrogram_hover_events(_this.dendrogram_layer);_this.dendrogram_layer.on("click",function(e){_this._dendrogram_layers_click(this,e)});_this.dendrogram_layer.on("mousedown",function(e){_this._dendrogram_layers_mousedown(this,e)});_this.dendrogram_layer.on("mouseup",function(e){_this._dendrogram_layers_mouseup(this,e)})};InCHlib.prototype._draw_row_dendrogram_node=function(e,t,n,r,i,s){if(t.count!=1){var o=_this._get_node_neighbourhood(t,_this.data.nodes);var u=_this.data.nodes[t.right_child];var a=_this.data.nodes[t.left_child];var f=_this._get_y1(o,n,r);var l=_this._get_y2(o,n,r);var c=_this._hack_round(_this.distance-_this.distance_step*t.distance);c=c==0?2:c;var h=c;var p=_this.distance-_this.distance_step*_this.data.nodes[t.left_child].distance;var d=_this.distance-_this.distance_step*_this.data.nodes[t.right_child].distance;if(u.count==1){l=l+_this.pixels_for_leaf/2}_this.dendrogram_layer.add(_this._draw_horizontal_path(e,c,f,h,l,p,d));_this._draw_row_dendrogram_node(t.left_child,a,n-o.left_node.right_count,r+o.left_node.right_count,p,f);_this._draw_row_dendrogram_node(t.right_child,u,n+o.right_node.left_count,r-o.right_node.left_count,d,l)}else{var v=t.objects;_this.leaves_y_coordinates[e]=s;for(var m=0,g=v.length;m<g;m++){_this.objects2leaves[v[m]]=e}var y=t.objects.length;if(y<_this.min_item_count){_this.min_item_count=y}if(y>_this.max_item_count){_this.max_item_count=y}}};InCHlib.prototype._draw_stage_layer=function(){_this.stage_layer=new Kinetic.Layer;var e=new Kinetic.Rect({x:0,y:0,width:_this.settings.width,height:_this.settings.height,opacity:0});_this.stage_layer.add(e);e.moveToBottom();_this.stage.add(_this.stage_layer);_this.stage_layer.on("click",function(e){_this.unhighlight_cluster();_this.unhighlight_column_cluster();_this.events.empty_space_onclick(e)})};InCHlib.prototype._draw_column_dendrogram=function(e){_this.column_dendrogram_layer=new Kinetic.Layer;_this.column_x_coordinates={};var t=_this.column_dendrogram.nodes[e];_this.current_column_count=t.count;_this.vertical_distance=_this.header_height;_this.vertical_distance_step=_this.vertical_distance/t.distance;_this.last_highlighted_column_cluster=null;var n=_this.column_dendrogram.nodes[t.left_child].count;var r=_this.column_dendrogram.nodes[t.right_child].count;_this._draw_column_dendrogram_node(e,t,n,r,0,0);_this.stage.add(_this.column_dendrogram_layer);if(!_this.nodes2columns){_this.nodes2columns=_this._get_nodes2columns()}_this._bind_dendrogram_hover_events(_this.column_dendrogram_layer);_this.column_dendrogram_layer.on("click",function(e){_this._column_dendrogram_layers_click(this,e)});_this.column_dendrogram_layer.on("mousedown",function(e){_this._column_dendrogram_layers_mousedown(this,e)});_this.column_dendrogram_layer.on("mouseup",function(e){_this._dendrogram_layers_mouseup(this,e)})};InCHlib.prototype._get_nodes2columns=function(){var e=[];var t={};var n={};var r,i,s;for(s=0,keys=Object.keys(_this.column_x_coordinates),len=keys.length;s<len;s++){r=keys[s];i=_this.column_x_coordinates[r];t[i]=r;e.push(i)}e.sort(function(e,t){return e-t});for(s=0,len=e.length;s<len;s++){n[t[e[s]]]=s}return n};InCHlib.prototype._bind_dendrogram_hover_events=function(e){e.on("mouseover",function(e){_this._dendrogram_layers_mouseover(this,e)});e.on("mouseout",function(e){_this._dendrogram_layers_mouseout(this,e)})};InCHlib.prototype._delete_layers=function(e,t){for(var n=0,r=e.length;n<r;n++){if(e[n]!==undefined){e[n].destroy()}}if(t!==undefined){for(var n=0,r=t.length;n<r;n++){t[n].removeChildren();t[n].draw()}}};InCHlib.prototype._delete_all_layers=function(){_this.stage.destroyChildren()};InCHlib.prototype._adjust_leaf_size=function(e){_this.pixels_for_leaf=(_this.settings.max_height-_this.header_height-_this.footer_height-_this.column_metadata_height-5)/e;if(_this.pixels_for_leaf>2*_this.pixels_for_dimension){_this.pixels_for_leaf=2*_this.pixels_for_dimension}if(_this.pixels_for_leaf>_this.settings.max_row_height){_this.pixels_for_leaf=_this.settings.max_row_height}if(_this.settings.min_row_height>_this.pixels_for_leaf){_this.pixels_for_leaf=_this.settings.min_row_height}};InCHlib.prototype._adjust_horizontal_sizes=function(e){if(e===undefined){e=_this._get_visible_count()}_this.right_margin=100;if(_this.settings.dendrogram){_this.heatmap_width=(_this.settings.width-_this.right_margin-_this.dendrogram_heatmap_distance)*_this.settings.heatmap_part_width;_this.distance=_this.settings.width-_this.heatmap_width-_this.right_margin;_this.heatmap_distance=_this.distance+_this.dendrogram_heatmap_distance}else{_this.heatmap_width=_this.settings.width-_this.right_margin;_this.distance=_this.right_margin/2;_this.heatmap_distance=_this.distance}_this.pixels_for_dimension=e?_this.heatmap_width/e:0;if(_this.settings.max_column_width&&_this.settings.max_column_width<_this.pixels_for_dimension){_this.pixels_for_dimension=_this.settings.max_column_width;_this.heatmap_width=e*_this.pixels_for_dimension;if(_this.settings.dendrogram){_this.distance=_this.settings.width-_this.heatmap_width-_this.right_margin-_this.dendrogram_heatmap_distance;_this.heatmap_distance=_this.distance+_this.dendrogram_heatmap_distance}else{_this.distance=_this._hack_round((_this.settings.width-_this.heatmap_width)/2);_this.right_margin=_this.distance;_this.heatmap_distance=_this.distance}}};InCHlib.prototype._set_color_settings=function(){var e=[];for(i=0,keys=Object.keys(_this.data.nodes),len=keys.length;i<len;i++){node=_this.data.nodes[keys[i]];if(node.count==1){e.push(node.features)}}_this.data_descs={};if(_this.settings.independent_columns){_this.data_descs=_this._get_data_min_max_middle(e)}else{var t=_this._get_min_max_middle(e);for(i=0;i<_this.dimensions["data"];i++){_this.data_descs[i]={min:t[0],max:t[1],middle:t[2]}}}if(_this.settings.metadata){var n=[];for(i=0,keys=Object.keys(_this.metadata.nodes),len=keys.length;i<len;i++){n.push(_this.metadata.nodes[keys[i]])}_this.metadata_descs=_this._get_data_min_max_middle(n)}};InCHlib.prototype._set_heatmap_settings=function(){var e,t,n,r,i;_this.header=[];for(e=0;e<_this.dimensions["overall"];e++){_this.header.push("")}_this.heatmap_header=false;_this.metadata_header=false;_this.current_label=null;_this._set_color_settings();if(_this.data.feature_names!==undefined){_this.heatmap_header=_this.data.feature_names;for(e=0;e<_this.dimensions["data"];e++){_this.header[e]=_this.heatmap_header[e]}}if(_this.settings.metadata){if(_this.metadata.feature_names){_this.metadata_header=_this.metadata.feature_names;for(e=0;e<_this.dimensions["metadata"];e++){_this.header[_this.dimensions["data"]+e]=_this.metadata_header[e]}}}if(_this.settings.column_metadata){if(_this.column_metadata.feature_names!==undefined){_this.column_metadata_header=_this.column_metadata.feature_names}}if(_this.settings.count_column){_this.max_item_count=1;_this.min_item_count=1;_this.dimensions["overall"]++;_this.header.push("Count")}_this.features={};for(e=0;e<_this.dimensions["overall"];e++){_this.features[e]=true}_this._set_on_features();_this._adjust_horizontal_sizes();_this.top_heatmap_distance=_this.header_height+_this.column_metadata_height+_this.settings.column_metadata_row_height/2};InCHlib.prototype._set_on_features=function(e){var t;if(e===undefined){var e=[];for(var n=0,r=Object.keys(_this.features),i=r.length;n<i;n++){t=r[n];if(_this.features[t]){e.push(t)}}}_this.on_features={data:[],metadata:[],count_column:[]};for(var n=0,i=e.length;n<i;n++){t=e[n];if(t<_this.dimensions["data"]){_this.on_features["data"].push(t)}else if(t<=_this.dimensions["data"]+_this.dimensions["metadata"]-1){_this.on_features["metadata"].push(t-_this.dimensions["data"])}else{_this.on_features["count_column"].push(0)}}};InCHlib.prototype._draw_heatmap=function(){if(!_this.settings.heatmap||_this.dimensions["overall"]==0){return}var e,t,n,r,i,s;_this.heatmap_layer=new Kinetic.Layer;_this.heatmap_overlay=new Kinetic.Layer;_this.highlighted_rows_y=[];_this.current_draw_values=true;_this.max_value_length=_this._get_max_value_length();_this.value_font_size=_this._get_font_size(_this.max_value_length,_this.pixels_for_dimension,_this.pixels_for_leaf,12);if(_this.value_font_size<4){_this.current_draw_values=false}var o=_this.heatmap_distance;var u=[];for(var a=0,f=Object.keys(_this.leaves_y_coordinates),l=f.length;a<l;a++){key=f[a];s=_this.leaves_y_coordinates[key];e=_this._draw_heatmap_row(key,o,s);_this.heatmap_layer.add(e);u.push([key,s]);_this._bind_row_events(e)}if(_this.settings.column_metadata){_this.column_metadata_descs=_this._get_data_min_max_middle(_this.column_metadata.features,"row");y1=_this.header_height+.5*_this.settings.column_metadata_row_height;for(var a=0,l=_this.column_metadata.features.length;a<l;a++){e=_this._draw_column_metadata_row(_this.column_metadata.features[a],a,o,y1);_this.heatmap_layer.add(e);_this._bind_row_events(e);y1=y1+_this.settings.column_metadata_row_height}}if(_this.settings.draw_row_ids){_this._draw_row_ids(u)}_this.highlighted_rows_layer=new Kinetic.Layer;_this.stage.add(_this.heatmap_layer,_this.heatmap_overlay,_this.highlighted_rows_layer);_this.highlighted_rows_layer.moveToTop();_this.row_overlay=_this.objects_ref.heatmap_line.clone();_this.column_overlay=_this.objects_ref.heatmap_line.clone();_this.heatmap_layer.on("mouseleave",function(e){_this.last_header=null;_this.heatmap_overlay.destroyChildren();_this.heatmap_overlay.draw();_this.events.heatmap_onmouseout(e)})};InCHlib.prototype._draw_heatmap_row=function(e,t,n){var r=_this.data.nodes[e];var i=new Kinetic.Group({id:e});var s,o,u,a,f,l,c,h;for(var p=0,d=_this.on_features["data"].length;p<d;p++){h=_this.on_features["data"][p];s=t+_this.pixels_for_dimension;o=n;f=r.features[h];if(f!==null){u=_this._get_color_for_value(f,_this.data_descs[h]["min"],_this.data_descs[h]["max"],_this.data_descs[h]["middle"],_this.settings.heatmap_colors);a=_this.objects_ref.heatmap_line.clone({stroke:u,points:[t,n,s,o],value:f,column:["d",h].join("_"),strokeWidth:_this.pixels_for_leaf});i.add(a);if(_this.current_draw_values){l=_this.objects_ref.heatmap_value.clone({x:_this._hack_round((t+s)/2-(""+f).length*(_this.value_font_size/4)),y:_this._hack_round(n-_this.value_font_size/2),fontSize:_this.value_font_size,text:f});i.add(l)}}t=s}if(_this.settings.metadata){var v=_this.metadata.nodes[e];if(v!==undefined){for(var p=0,d=_this.on_features["metadata"].length;p<d;p++){h=_this.on_features["metadata"][p];f=v[h];s=t+_this.pixels_for_dimension;o=n;if(f!==null&&f!==undefined){c=f;if(_this.metadata_descs[h]["str2num"]!==undefined){f=_this.metadata_descs[h]["str2num"][f]}u=_this._get_color_for_value(f,_this.metadata_descs[h]["min"],_this.metadata_descs[h]["max"],_this.metadata_descs[h]["middle"],_this.settings.metadata_colors);a=_this.objects_ref.heatmap_line.clone({stroke:u,points:[t,n,s,o],value:c,column:["m",h].join("_"),strokeWidth:_this.pixels_for_leaf});i.add(a);if(_this.current_draw_values){l=_this.objects_ref.heatmap_value.clone({text:c,fontSize:_this.value_font_size});width=l.getWidth();x=_this._hack_round((t+s)/2-width/2);y=_this._hack_round(n-_this.value_font_size/2);l.position({x:x,y:y});i.add(l)}}t=s}}}if(_this.settings.count_column&&_this.features[_this.dimensions["overall"]-1]){s=t+_this.pixels_for_dimension;var m=r.objects.length;u=_this._get_color_for_value(m,_this.min_item_count,_this.max_item_count,_this.middle_item_count,_this.settings.count_column_colors);a=_this.objects_ref.heatmap_line.clone({stroke:u,points:[t,n,s,o],value:m,column:"Count",strokeWidth:_this.pixels_for_leaf});i.add(a);if(_this.current_draw_values){l=_this.objects_ref.heatmap_value.clone({text:m});width=l.getWidth();x=_this._hack_round((t+s)/2-width/2);y=_this._hack_round(n-_this.value_font_size/2);l.position({x:x,y:y});i.add(l)}}return i};InCHlib.prototype._draw_column_metadata_row=function(e,t,n,r){var i=new Kinetic.Group({"class":"column_metadata"});var s,o,u,a,f,l,c,h,p;var d=_this.column_metadata_descs[t]["str2num"]===undefined?false:true;for(var v=0,m=_this.on_features["data"].length;v<m;v++){p=_this.on_features["data"][v];f=e[p];c=f;if(d){f=_this.column_metadata_descs[t]["str2num"][f]}u=_this._get_color_for_value(f,_this.column_metadata_descs[t]["min"],_this.column_metadata_descs[t]["max"],_this.column_metadata_descs[t]["middle"],_this.settings.column_metadata_colors);s=n+_this.pixels_for_dimension;o=r;a=_this.objects_ref.heatmap_line.clone({strokeWidth:_this.settings.column_metadata_row_height,stroke:u,value:c,points:[n,r,s,o],column:["cm",t].join("_")});i.add(a);n=s}return i};InCHlib.prototype._bind_row_events=function(e){e.on("mouseenter",function(e){_this._row_mouseenter(e)});e.on("mouseleave",function(e){_this._row_mouseleave(e)});e.on("mouseover",function(e){_this._draw_col_label(e)});e.on("mouseout",function(e){_this.heatmap_overlay.find("#col_label")[0].destroy()});e.on("click",function(e){var t=e.target.parent.attrs.id;if(e.target.parent.attrs.class!=="column_metadata"){var n=_this.data.nodes[t].objects;var r=[];for(i=0;i<n.length;i++){r.push(n[i])}_this.events.row_onclick(r,e)}})};InCHlib.prototype._draw_row_ids=function(e){if(_this.pixels_for_leaf<6){return}var t,n,r=[],i,s=[],o;for(t=0;t<e.length;t++){i=e[t];n=_this.data.nodes[i[0]].objects;if(n.length>1){return}s.push(n[0]);r.push([n[0],i[1]])}var u=_this._get_max_length(s);var a=_this._get_font_size(u,85,_this.pixels_for_leaf,10);var f=_this.distance+_this._get_visible_count()*_this.pixels_for_dimension+15;if(a>4){for(t=0;t<r.length;t++){o=_this.objects_ref.heatmap_value.clone({x:f,y:_this._hack_round(r[t][1]-a/2),fontSize:a,text:r[t][0],fontStyle:"italic",fill:"gray"});_this.heatmap_layer.add(o)}}};InCHlib.prototype._draw_heatmap_header=function(){if(_this.settings.heatmap_header&&_this.header.length>0){_this.header_layer=new Kinetic.Layer;var e=_this._hack_size(_this.leaves_y_coordinates);var t=_this.settings.column_dendrogram&&_this.heatmap_header?_this.header_height+_this.pixels_for_leaf*e+10+_this.column_metadata_height:_this.header_height-20;var n=_this.settings.column_dendrogram&&_this.heatmap_header?45:-45;var r=0;var i,s,o,u;var a=[];for(s=0,len=_this.on_features["data"].length;s<len;s++){a.push(_this.header[_this.on_features["data"][s]])}for(s=0,len=_this.on_features["metadata"].length;s<len;s++){a.push(_this.header[_this.on_features["metadata"][s]+_this.dimensions["data"]])}if(_this.settings.count_column&&_this.features[_this.dimensions["overall"]-1]){console.log("ok");a.push(_this.header[_this.dimensions["overall"]-1])}var f=_this._get_max_length(a);var l=_this._get_font_size(f,_this.header_height,_this.pixels_for_dimension,16);if(l<8){return}for(s=0,len=a.length;s<len;s++){i=_this.heatmap_distance+r*_this.pixels_for_dimension+_this.pixels_for_dimension/2;o=_this.objects_ref.column_header.clone({x:i,y:t,text:a[s],position_index:s,fontSize:l,rotationDeg:n});_this.header_layer.add(o);r++}_this.stage.add(_this.header_layer);if(!_this.settings.dendrogram){_this.header_layer.on("click",function(e){var t=e.target;var n=t.attrs.position_index;for(s=0;s<_this.header_layer.getChildren().length;s++){_this.header_layer.getChildren()[s].setFill("black")}e.target.setAttrs({fill:"red"});_this._delete_layers([_this.heatmap_layer,_this.heatmap_overlay,_this.highlighted_rows_layer]);_this._reorder_heatmap(_this._translate_column_to_feature_index(n));_this._draw_heatmap();_this.header_layer.draw()});_this.header_layer.on("mouseover",function(e){var t=e.target;t.setOpacity(.7);this.draw()});_this.header_layer.on("mouseout",function(e){var t=e.target;t.setOpacity(1);this.draw()})}}};InCHlib.prototype._translate_column_to_feature_index=function(e){var t;var n=-1;for(var r=0,i=Object.keys(_this.features),s=i.length;r<s;r++){t=i[r];if(_this.features[t]){n++;if(e===n){return t}}}};InCHlib.prototype._draw_distance_scale=function(e){var t=_this.header_height+_this.column_metadata_height+_this.settings.column_metadata_row_height/2-10;var n=t;var r=0;var i=_this.distance;var s=new Kinetic.Line({points:[r,t,i,n],stroke:"black",listening:false});var o=new Kinetic.Circle({x:i,y:n,radius:3,fill:"black",listening:false});var u=0;var a=3;var f=i;var l=_this._hack_round(30/_this.distance_step*10)/10;var e=Math.round(100*_this.distance/_this.distance_step)/100;var c=_this._hack_round(_this.distance_step*l);var h=0;var p=new Kinetic.Text({x:0,y:t-20,text:e,fontSize:12,fontFamily:_this.settings.font,fontStyle:"bold",fill:"black",align:"right",listening:false});_this.dendrogram_layer.add(s,o,p);if(c==0){c=.5}var s;if(l>.1){while(f>0){s=new Kinetic.Line({points:[f,t-a,f,n+a],stroke:"black",listening:false});_this.dendrogram_layer.add(s);u=_this._hack_round((u+l)*10)/10;if(u>10){u=_this._hack_round(u)}f=f-c;h++}}};InCHlib.prototype._draw_navigation=function(){_this.navigation_layer=new Kinetic.Layer;var e=0;var t=10;_this._draw_color_scale();_this._draw_help();if(!_this.settings.column_dendrogram){var n=_this.objects_ref.icon.clone({data:"M26.834,6.958c0-2.094-4.852-3.791-10.834-3.791c-5.983,0-10.833,1.697-10.833,3.791c0,0.429,0.213,0.84,0.588,1.224l8.662,15.002v4.899c0,0.414,0.709,0.75,1.583,0.75c0.875,0,1.584-0.336,1.584-0.75v-4.816l8.715-15.093h-0.045C26.625,7.792,26.834,7.384,26.834,6.958zM16,9.75c-6.363,0-9.833-1.845-9.833-2.792S9.637,4.167,16,4.167c6.363,0,9.834,1.844,9.834,2.791S22.363,9.75,16,9.75z",x:e,y:t,label:"Filter\ncolumns"});var r=_this._draw_icon_overlay(e,t);_this.navigation_layer.add(n,r);e=e+40;r.on("click",function(){_this._filter_icon_click(this)});r.on("mouseover",function(){_this._icon_mouseover(n,r,_this.navigation_layer)});r.on("mouseout",function(){_this._icon_mouseout(n,r,_this.navigation_layer)})}if(_this.zoomed_clusters["row"].length>0||_this.zoomed_clusters["column"].length>0){var i=_this.objects_ref.icon.clone({data:"M24.083,15.5c-0.009,4.739-3.844,8.574-8.583,8.583c-4.741-0.009-8.577-3.844-8.585-8.583c0.008-4.741,3.844-8.577,8.585-8.585c1.913,0,3.665,0.629,5.09,1.686l-1.782,1.783l8.429,2.256l-2.26-8.427l-1.89,1.89c-2.072-1.677-4.717-2.688-7.587-2.688C8.826,3.418,3.418,8.826,3.416,15.5C3.418,22.175,8.826,27.583,15.5,27.583S27.583,22.175,27.583,15.5H24.083z",x:e,y:t,id:"refresh_icon",label:"Refresh"});var s=_this._draw_icon_overlay(e,t);_this.navigation_layer.add(i,s);s.on("click",function(){_this._refresh_icon_click();_this.events.on_refresh()});s.on("mouseover",function(){_this._icon_mouseover(i,s,_this.navigation_layer)});s.on("mouseout",function(){_this._icon_mouseout(i,s,_this.navigation_layer)})}if(_this.zoomed_clusters["row"].length>0){e=_this.distance-55;t=_this.header_height+_this.column_metadata_height-40;var o=_this.objects_ref.icon.clone({data:_this.paths_ref["unzoom_icon"],x:e,y:t,scale:{x:.7,y:.7},label:"Unzoom\nrows"});var u=_this._draw_icon_overlay(e,t);_this.navigation_layer.add(o,u);u.on("click",function(){_this._unzoom_icon_click()});u.on("mouseover",function(){_this._icon_mouseover(o,u,_this.navigation_layer)});u.on("mouseout",function(){_this._icon_mouseout(o,u,_this.navigation_layer)})}if(_this.zoomed_clusters["column"].length>0){e=_this.settings.width-85;t=_this.header_height-50;var a=_this.objects_ref.icon.clone({data:_this.paths_ref["unzoom_icon"],x:e,y:t-5,scale:{x:.7,y:.7},label:"Unzoom\ncolumns"});var f=_this._draw_icon_overlay(e,t);_this.navigation_layer.add(a,f);f.on("click",function(){_this._column_unzoom_icon_click(this)});f.on("mouseover",function(){_this._icon_mouseover(a,f,_this.navigation_layer)});f.on("mouseout",function(){_this._icon_mouseout(a,f,_this.navigation_layer)})}if(_this.settings.show_export_button){var l=_this.objects_ref.icon.clone({data:"M24.25,10.25H20.5v-1.5h-9.375v1.5h-3.75c-1.104,0-2,0.896-2,2v10.375c0,1.104,0.896,2,2,2H24.25c1.104,0,2-0.896,2-2V12.25C26.25,11.146,25.354,10.25,24.25,10.25zM15.812,23.499c-3.342,0-6.06-2.719-6.06-6.061c0-3.342,2.718-6.062,6.06-6.062s6.062,2.72,6.062,6.062C21.874,20.78,19.153,23.499,15.812,23.499zM15.812,13.375c-2.244,0-4.062,1.819-4.062,4.062c0,2.244,1.819,4.062,4.062,4.062c2.244,0,4.062-1.818,4.062-4.062C19.875,15.194,18.057,13.375,15.812,13.375z",x:_this.settings.width-62,y:10,scale:{x:.7,y:.7},id:"export_icon",label:"Export\nin png format"});var c=_this._draw_icon_overlay(_this.settings.width-62,10);_this.navigation_layer.add(l,c);c.on("click",function(){_this._export_icon_click(this)});c.on("mouseover",function(){_this._icon_mouseover(l,c,_this.navigation_layer)});c.on("mouseout",function(){_this._icon_mouseout(l,c,_this.navigation_layer)})}_this.stage.add(_this.navigation_layer)};InCHlib.prototype._draw_help=function(){var e=_this.objects_ref.icon.clone({data:_this.paths_ref["lightbulb"],x:_this.settings.width-63,y:40,scale:{x:.8,y:.8},id:"help_icon",label:"Tip"});var t=_this._draw_icon_overlay(_this.settings.width-63,40);_this.navigation_layer.add(e,t);t.on("mouseover",function(){_this._icon_mouseover(e,t,_this.navigation_layer);_this._help_mouseover()});t.on("mouseout",function(){_this._help_mouseout();_this._icon_mouseout(e,t,_this.navigation_layer)})};InCHlib.prototype._draw_color_scale=function(){var e=[_this.settings.min_percentile/100,_this._get_color_for_value(0,0,1,.5,_this.settings.heatmap_colors),_this.settings.middle_percentile/100,_this._get_color_for_value(.5,0,1,.5,_this.settings.heatmap_colors),_this.settings.max_percentile/100,_this._get_color_for_value(1,0,1,.5,_this.settings.heatmap_colors)];var t=_this.objects_ref.rect_gradient.clone({label:"Color settings",fillLinearGradientColorStops:e,id:"color_scale"});t.on("mouseover",function(){_this._color_scale_mouseover(t,_this.navigation_layer)});t.on("mouseout",function(){_this._color_scale_mouseout(t,_this.navigation_layer)});t.on("click",function(){_this._color_scale_click(t,_this.navigation_layer)});_this.navigation_layer.add(t)};InCHlib.prototype._update_color_scale=function(){var e=_this.navigation_layer.find("#color_scale");e.fillLinearGradientColorStops([_this.settings.min_percentile/100,_this._get_color_for_value(0,0,1,.5,_this.settings.heatmap_colors),_this.settings.middle_percentile/100,_this._get_color_for_value(.5,0,1,.5,_this.settings.heatmap_colors),_this.settings.max_percentile/100,_this._get_color_for_value(1,0,1,.5,_this.settings.heatmap_colors)]);_this.navigation_layer.draw()};InCHlib.prototype._draw_icon_overlay=function(e,t){return _this.objects_ref.icon_overlay.clone({x:e,y:t})};InCHlib.prototype._highlight_path=function(e,t){var n=_this.data.nodes[e];if(n.count!=1){_this.dendrogram_layer.get("#"+e)[0].stroke(t);_this._highlight_path(n.left_child,t);_this._highlight_path(n.right_child,t)}else{_this.highlighted_rows_y.push(_this.leaves_y_coordinates[e]);_this.current_object_ids.push.apply(_this.current_object_ids,n["objects"])}};InCHlib.prototype._highlight_column_path=function(e,t){var n=_this.column_dendrogram.nodes[e];if(n.count!=1){_this.column_dendrogram_layer.get("#col"+e)[0].stroke(t);_this._highlight_column_path(n.left_child,t);_this._highlight_column_path(n.right_child,t)}else{_this.current_column_ids.push(_this.nodes2columns[e])}};InCHlib.prototype.unhighlight_rows=function(){_this.highlight_rows([])};InCHlib.prototype.highlight_rows=function(e){var t,n,r;if(!_this.settings.heatmap){return}_this.settings.highlighted_rows=e;_this.highlighted_rows_layer.destroyChildren();var i=_this.settings.heatmap_colors;var s=_this.settings.metadata_colors;_this.settings.heatmap_colors=_this.settings.highlight_colors;_this.settings.metadata_colors=_this.settings.highlight_colors;var o={};var u=[];for(t=0;t<e.length;t++){if(_this.objects2leaves[e[t]]!==undefined){r=_this.objects2leaves[e[t]];if(o[r]===undefined){u.push(r);o[r]=null}}}for(t=0;t<u.length;t++){n=_this._draw_heatmap_row(u[t],_this.heatmap_distance,_this.leaves_y_coordinates[u[t]]);_this.highlighted_rows_layer.add(n);n.setAttr("listening",false)}_this.highlighted_rows_layer.draw();_this.heatmap_overlay.moveToTop();_this.settings.heatmap_colors=i;_this.settings.metadata_colors=s;_this.highlighted_rows_layer.on("click",function(e){_this.heatmap_layer.fire("click")})};InCHlib.prototype._highlight_cluster=function(e){var t=_this.last_highlighted_cluster;if(t){_this.unhighlight_cluster()}if(t!==e){_this.last_highlighted_cluster=e;_this._highlight_path(e,"#F5273C");_this._draw_cluster_layer(e);_this.events.dendrogram_node_highlight(_this.current_object_ids,_this._unprefix(e))}_this.dendrogram_layer.draw()};InCHlib.prototype._highlight_column_cluster=function(e){var t=_this.last_highlighted_column_cluster;if(t){_this.unhighlight_column_cluster()}if(t!==e){_this.last_highlighted_column_cluster=e;_this._highlight_column_path(e,"#F5273C");_this.current_column_ids.sort(function(e,t){return e-t});_this._draw_column_cluster_layer(e);_this.events.column_dendrogram_node_highlight(_this.current_column_ids,_this._unprefix(e))}_this.column_dendrogram_layer.draw()};InCHlib.prototype.unhighlight_column_cluster=function(){if(_this.last_highlighted_column_cluster){_this._highlight_column_path(_this.last_highlighted_column_cluster,"grey");_this.column_dendrogram_layer.draw();_this.column_cluster_group.destroy();_this.cluster_layer.draw();_this.events.column_dendrogram_node_unhighlight(_this._unprefix(_this.last_highlighted_column_cluster));_this.current_column_ids=[];_this.last_highlighted_column_cluster=null}};InCHlib.prototype.highlight_cluster=function(e){return _this._highlight_cluster(_this._prefix(e))};InCHlib.prototype.highlight_column_cluster=function(e){return _this._highlight_column_cluster(_this._prefix(e))};InCHlib.prototype.unhighlight_cluster=function(){if(_this.last_highlighted_cluster){_this._highlight_path(_this.last_highlighted_cluster,"grey");_this.dendrogram_layer.draw();_this.row_cluster_group.destroy();_this.cluster_layer.draw();_this.events.dendrogram_node_unhighlight(_this._unprefix(_this.last_highlighted_cluster));_this.highlighted_rows_y=[];_this.current_object_ids=[];_this.last_highlighted_cluster=null}};InCHlib.prototype._neutralize_path=function(e){var t=_this.data.nodes[e];if(t.count!=1){var n=_this.dendrogram_layer.get("#"+e)[0];if(n){n.setStroke("grey");_this._neutralize_path(t.right_child);_this._neutralize_path(t.left_child)}}};InCHlib.prototype._draw_cluster_layer=function(e){_this.row_cluster_group=new Kinetic.Group;var t=_this._get_visible_count();var n=_this.data.nodes[e].count;var r=_this.distance-30;var i=_this.header_height+_this.column_metadata_height-40;var s=_this.objects_ref.count.clone({x:r+10,y:i-10,text:n});var o=_this.objects_ref.icon.clone({data:_this.paths_ref["zoom_icon"],x:r,y:i,scale:{x:.7,y:.7},label:"Zoom\nrows"});var u=_this._draw_icon_overlay(r,i);r=_this.distance+_this.dendrogram_heatmap_distance;var a=t*_this.pixels_for_dimension+_this.heatmap_distance;var f=_this.highlighted_rows_y[0]-_this.pixels_for_leaf/2;var l=_this.highlighted_rows_y[_this.highlighted_rows_y.length-1]+_this.pixels_for_leaf/2;var c=_this.objects_ref.cluster_overlay.clone({x:r,y:_this.header_height+_this.column_metadata_height+5,width:a,height:_this._hack_round(f-_this.header_height-_this.column_metadata_height-5)});var h=_this.objects_ref.cluster_border.clone({points:[0,f,a,f]});var p=_this.objects_ref.cluster_overlay.clone({x:r,y:l,width:a,height:_this.settings.height-l-_this.footer_height+5});var d=_this.objects_ref.cluster_border.clone({points:[0,l,a,l]});_this.row_cluster_group.add(s,c,p,o,u,h,d);_this.cluster_layer.add(_this.row_cluster_group);_this.stage.add(_this.cluster_layer);s.moveToTop();_this.cluster_layer.draw();_this.navigation_layer.moveToTop();u.on("mouseover",function(){_this._icon_mouseover(o,u,_this.cluster_layer)});u.on("mouseout",function(){_this._icon_mouseout(o,u,_this.cluster_layer)});u.on("click",function(){_this._zoom_cluster(_this.last_highlighted_cluster)})};InCHlib.prototype._draw_column_cluster_layer=function(e){_this.column_cluster_group=new Kinetic.Group;var t=_this.column_dendrogram.nodes[e].count;var n=_this.settings.width-85;var r=_this.header_height-25;var i=_this.objects_ref.count.clone({x:n+15,y:r-5,text:t});var s=_this.objects_ref.icon.clone({data:_this.paths_ref["zoom_icon"],x:n,y:r,scale:{x:.7,y:.7},label:"Zoom\ncolumns"});var o=_this._draw_icon_overlay(n,r);var u=_this._hack_round((_this.current_column_ids[0]-_this.columns_start_index)*_this.pixels_for_dimension);var a=_this._hack_round((_this.current_column_ids[0]+_this.current_column_ids.length-_this.columns_start_index)*_this.pixels_for_dimension);var f=0;var l=_this.settings.height-_this.footer_height+5;var c=_this.settings.height-_this.footer_height-_this.header_height+_this.settings.column_metadata_row_height;var h=_this.objects_ref.cluster_border.clone({points:[_this.heatmap_distance+u,f,_this.heatmap_distance+u,l]});var p=_this.objects_ref.cluster_overlay.clone({x:_this.heatmap_distance,y:_this.header_height,width:u,height:c});var d=_this.objects_ref.cluster_border.clone({points:[_this.heatmap_distance+a,f,_this.heatmap_distance+a,l]});var v=_this.objects_ref.cluster_overlay.clone({x:a+_this.heatmap_distance,y:_this.header_height,width:_this.heatmap_width-a-(_this.on_features["metadata"].length+_this.on_features["count_column"].length)*_this.pixels_for_dimension,height:c});_this.column_cluster_group.add(p,v,s,o,i,h,d);_this.cluster_layer.add(_this.column_cluster_group);_this.stage.add(_this.cluster_layer);_this.cluster_layer.draw();_this.navigation_layer.moveToTop();o.on("mouseover",function(){_this._icon_mouseover(s,o,_this.cluster_layer)});o.on("mouseout",function(){_this._icon_mouseout(s,o,_this.cluster_layer)});o.on("click",function(){_this._zoom_column_cluster(_this.last_highlighted_column_cluster)})};InCHlib.prototype._draw_column_cluster=function(e){_this.columns_start_index=_this.current_column_ids[0];_this.on_features["data"]=_this.current_column_ids;var t=_this.distance;_this._adjust_horizontal_sizes();_this._delete_layers([_this.column_dendrogram_layer,_this.heatmap_layer,_this.heatmap_overlay,_this.column_cluster_group,_this.navigation_layer,_this.highlighted_rows_layer],[_this.dendrogram_hover_layer]);if(_this.settings.heatmap_header){_this._delete_layers([_this.header_layer])}_this._draw_column_dendrogram(e);_this._draw_heatmap();_this._draw_heatmap_header();_this._draw_navigation();if(t!==_this.distance){_this._delete_layers([_this.dendrogram_layer,_this.cluster_layer]);var n=_this.zoomed_clusters["row"].length>0?_this.zoomed_clusters["row"][_this.zoomed_clusters["row"].length-1]:_this.root_id;_this._draw_row_dendrogram(n);if(_this.last_highlighted_cluster!==null){_this._highlight_path(_this.last_highlighted_cluster,"#F5273C");_this.dendrogram_layer.draw();_this._draw_cluster_layer(_this.last_highlighted_cluster)}}else{_this.cluster_layer.moveToTop();_this.cluster_layer.draw()}};InCHlib.prototype._zoom_column_cluster=function(e){if(e!=_this.column_root_id){_this.zoomed_clusters["column"].push(e);_this._draw_column_cluster(e);_this.highlight_rows(_this.settings.highlighted_rows);_this.events.on_columns_zoom(_this.current_column_ids,_this._unprefix(e));_this.current_column_ids=[];_this.last_highlighted_column_cluster=null}};InCHlib.prototype._unzoom_column_cluster=function(){var e=_this.zoomed_clusters["column"].pop();var t=_this.zoomed_clusters["column"].length;var n=t>0?_this.zoomed_clusters["column"][t-1]:_this.column_root_id;_this._get_column_ids(n);_this._draw_column_cluster(n);_this.events.on_columns_unzoom(_this._unprefix(e));_this.current_column_ids=[];_this._highlight_column_cluster(e)};InCHlib.prototype._draw_cluster=function(e){_this._delete_layers([_this.dendrogram_layer,_this.heatmap_layer,_this.heatmap_overlay,_this.cluster_layer,_this.navigation_layer,_this.header_layer,_this.highlighted_rows_layer],[_this.dendrogram_hover_layer]);_this._draw_row_dendrogram(e);_this._draw_heatmap();_this._draw_heatmap_header();_this._draw_navigation();if(_this.settings.column_dendrogram&&_this.last_highlighted_column_cluster!==null){_this._draw_column_cluster_layer(_this.last_highlighted_column_cluster)}};InCHlib.prototype._zoom_cluster=function(e){if(e!==_this.root_id){_this.zoomed_clusters["row"].push(e);_this._draw_cluster(e);_this.highlight_rows(_this.settings.highlighted_rows);_this.events.on_zoom(_this.current_object_ids,_this._unprefix(e));_this.current_object_ids=[];_this.last_highlighted_cluster=null}};InCHlib.prototype._unzoom_cluster=function(){var e=_this.zoomed_clusters["row"].pop();var t=_this.zoomed_clusters["row"].length;var n=t>0?_this.zoomed_clusters["row"][t-1]:_this.root_id;_this._draw_cluster(n);_this.events.on_unzoom(_this._unprefix(e));_this._highlight_cluster(e)};InCHlib.prototype._get_node_neighbourhood=function(e,t){var n={left_node:{left_node:{left_count:0,right_count:0},right_node:{left_count:0,right_count:0},left_count:.5,right_count:.5},right_node:{left_node:{left_count:0,right_count:0},right_node:{left_count:0,right_count:0},left_count:.5,right_count:.5},left_count:t[e.left_child].count,right_count:t[e.right_child].count};var r=t[e.left_child];var i=t[e.right_child];var s=t[r.left_child];var o=t[r.right_child];var u=t[i.left_child];var a=t[i.right_child];if(r.count!=1){n.left_node.left_count=t[r.left_child].count;n.left_node.right_count=t[r.right_child].count;if(s.count!=1){n.left_node.left_node.left_count=t[s.left_child].count;n.left_node.left_node.right_count=t[s.right_child].count}else{n.left_node.left_node.left_count=.5;n.left_node.left_node.right_count=.5}if(o.count!=1){n.left_node.right_node.left_count=t[o.left_child].count;n.left_node.right_node.right_count=t[o.right_child].count}else{n.left_node.right_node.left_count=.5;n.left_node.right_node.right_count=.5}}if(i.count!=1){n.right_node.left_count=t[i.left_child].count;n.right_node.right_count=t[i.right_child].count;if(u.count!=1){n.right_node.left_node.left_count=t[u.left_child].count;n.right_node.left_node.right_count=t[u.right_child].count}else{n.right_node.left_node.left_count=.5;n.right_node.left_node.right_count=.5}if(a.count!=1){n.right_node.right_node.left_count=t[a.left_child].count;n.right_node.right_node.right_count=t[a.right_child].count}else{n.right_node.right_node.left_count=.5;n.right_node.right_node.right_count=.5}}return n};InCHlib.prototype._draw_column_dendrogram_node=function(e,t,n,r,i,s){if(t.count>1){var o=_this._get_node_neighbourhood(t,_this.column_dendrogram.nodes);var u=_this.column_dendrogram.nodes[t.right_child];var a=_this.column_dendrogram.nodes[t.left_child];var f=_this._get_x1(o,n,r);var l=_this._get_x2(o,n,r);var c=_this._hack_round(_this.vertical_distance-_this.vertical_distance_step*t.distance);c=c==0?2:c;var h=c;if(u.count==1){l=l-_this.pixels_for_dimension/2}var p=_this.vertical_distance-_this.vertical_distance_step*_this.column_dendrogram.nodes[t.left_child].distance;var d=_this.vertical_distance-_this.vertical_distance_step*_this.column_dendrogram.nodes[t.right_child].distance;_this.column_dendrogram_layer.add(_this._draw_vertical_path(e,f,c,l,h,p,d));_this._draw_column_dendrogram_node(t.left_child,a,n-o.left_node.right_count,r+o.left_node.right_count,p,c);_this._draw_column_dendrogram_node(t.right_child,u,n+o.right_node.left_count,r-o.right_node.left_count,d,h)}else{_this.column_x_coordinates[e]=r*_this.pixels_for_dimension}};InCHlib.prototype._get_y1=function(e,t,n){t=t-e.left_node.right_count-e.left_node.left_node.right_count;var r=(t+(e.left_node.left_node.right_count+e.left_node.right_node.left_count)/2)*_this.pixels_for_leaf;return r+_this.top_heatmap_distance};InCHlib.prototype._get_y2=function(e,t,n){t=t+e.right_node.left_node.left_count;var r=(t+(e.right_node.left_node.right_count+e.right_node.right_node.left_count)/2)*_this.pixels_for_leaf;return r+_this.top_heatmap_distance};InCHlib.prototype._get_x1=function(e,t,n){t=t-e.left_node.right_count-e.left_node.left_node.right_count;var r=(t+(e.left_node.left_node.right_count+e.left_node.right_node.left_count)/2)*_this.pixels_for_dimension;return _this.heatmap_distance+_this.on_features["data"].length*_this.pixels_for_dimension-r};InCHlib.prototype._get_x2=function(e,t,n){t=t+e.right_node.left_node.left_count;var r=(t+(e.right_node.left_node.right_count+e.right_node.right_node.left_count)/2)*_this.pixels_for_dimension;return _this.heatmap_distance+_this.on_features["data"].length*_this.pixels_for_dimension-r};InCHlib.prototype._draw_vertical_path=function(e,t,n,r,i,s,o){var u=new Kinetic.Group({});var a=_this.objects_ref.node.clone({points:[t,s,t,n,r,i,r,o],id:"col"+e});var f=_this.objects_ref.node_rect.clone({x:r-1,y:n-1,width:t-r+2,height:_this.header_height-n,id:"col_rect"+e,path:a,path_id:e});u.add(a,f);return u};InCHlib.prototype._draw_horizontal_path=function(e,t,n,r,i,s,o){var u=new Kinetic.Group({});var a=_this.objects_ref.node.clone({points:[s,n,t,n,r,i,o,i],id:e});var f=_this.objects_ref.node_rect.clone({x:t-1,y:n-1,width:_this.distance-t,height:i-n,id:[e,"rect"].join("_"),path:a,path_id:e});u.add(a,f);return u};InCHlib.prototype._filter_icon_click=function(t){var n=_this.target_element.find(".filter_features");var r="✖";if(n.length){n.fadeIn("fast");var i=_this._draw_target_overlay()}else{filter_list="";for(var s in _this.header){if(_this.features[s]){r="✔"}if(s<_this.dimensions){var o=_this.header[s];if(o==""){o=parseInt(s)+1+". column"}filter_list=filter_list+"<li class='feature_switch' data-num='"+s+"'><span class='symbol'>"+r+"</span>  "+o+"</li>"}}_this.target_element.append("<div class='filter_features'><ul>"+filter_list+"</ul><hr /><div><span class='cancel_filter_list'>Cancel</span>&nbsp;&nbsp;&nbsp;<span class='update_filter_list'>Update</span></div></div>");n=_this.target_element.find(".filter_features");n.css({display:"none",top:45,left:0,"border-radius":"5px","text-align":"center",position:"absolute","background-color":"#ffffff",border:"solid 2px #DEDEDE","padding-top":"5px","padding-left":"15px","padding-bottom":"10px","padding-right":"15px","font-weight":"bold","font-size":"14px","z-index":1e3,"font-family":_this.settings.font});n.find("ul").css({"list-style-type":"none","margin-left":"0","padding-left":"0","text-align":"left"});n.find("li").css({color:"green","margin-top":"5px"});n.find("div").css({cursor:"pointer",opacity:"0.7"});var i=_this._draw_target_overlay();n.fadeIn("fast");_this.target_element.find(".feature_switch").click(function(){var t=parseInt(e(this).attr("data-num"));var n=e(this).find("span");_this.features[t]=!_this.features[t];if(_this.features[t]){n.text("✔");e(this).css("color","green")}else{n.text("✖");e(this).css("color","red")}_this._set_on_features()});e(function(){n.click(function(){return false});n.mousedown(function(){return false});e("#"+_this.settings.target+" .filter_features ul li,"+"#"+_this.settings.target+" .filter_features div span").hover(function(){e(this).css({cursor:"pointer",opacity:"0.7"})},function(){e(this).css({cursor:"default",opacity:"1"})})});_this.target_element.find(".cancel_filter_list").click(function(){n.fadeOut("fast");i.fadeOut("fast")});i.click(function(){n.fadeOut("fast");i.fadeOut("fast")});_this.target_element.find(".update_filter_list").click(function(){n.fadeOut("slow");i.fadeOut("slow");var e=_this.zoomed_clusters["row"].length>0?_this.zoomed_clusters["row"][_this.zoomed_clusters["row"].length-1]:_this.root_id;var t=_this.last_highlighted_cluster;_this.last_highlighted_cluster=null;_this._adjust_horizontal_sizes();_this._delete_all_layers();_this._draw_stage_layer();if(_this.settings.dendrogram){_this._draw_row_dendrogram(e);if(_this.settings.column_dendrogram&&_this._visible_features_equal_column_dendrogram_count()){_this._draw_column_dendrogram(_this.column_root_id)}}_this._draw_navigation();_this._draw_heatmap();_this._draw_heatmap_header();if(t!=null){_this._highlight_cluster(t)}})}};InCHlib.prototype._draw_target_overlay=function(){var t=_this.target_element.find(".target_overlay");if(t.length){t.fadeIn("fast")}else{t=e("<div class='target_overlay'></div>");t.css({"background-color":"white",position:"absolute",top:0,left:0,right:0,bottom:0,opacity:.5});_this.target_element.append(t)}return t};InCHlib.prototype._refresh_icon_click=function(){_this.redraw()};InCHlib.prototype._export_icon_click=function(){function i(t){e('<a download="inchlib" href="'+t+'"></a>')[0].click()}function s(e){window.open(e,"_blank")}var t=_this.target_element.find(".export_menu");var n=_this._draw_target_overlay();if(t.length){t.fadeIn("fast")}else{t=e("<div class='export_menu'><div><button type='submit' data-action='open'>Show image</button></div><div><button type='submit' data-action='save'>Save image</button></div></div>");_this.target_element.append(t);t.css({position:"absolute",top:45,left:_this.settings.width-125,"font-size":"12px",border:"solid #D2D2D2 1px","border-radius":"5px",padding:"2px","background-color":"white"});var r=t.find("button");r.css({"padding-top":"7px","padding-bottom":"5px","padding-right":"8px","padding-left":"8px",color:"white",border:"solid #D2D2D2 1px",width:"100%","background-color":"#2171b5","font-weight":"bold"});r.hover(function(){e(this).css({cursor:"pointer",opacity:.7})},function(){e(this).css({opacity:1})});n.click(function(){t.fadeOut("fast");n.fadeOut("fast")});r.click(function(){var t=e(this).attr("data-action");var r=3;var o=_this.stage.width();var u=_this.stage.height();var a=e("<h3 style='margin-top: 100px; margin-left: 100px; width: "+o+"px; height: "+u+"px;'>Loading...</h3>");_this.target_element.after(a);_this.target_element.hide();_this.stage.width(o*r);_this.stage.height(u*r);_this.stage.scale({x:r,y:r});_this.stage.draw();_this.navigation_layer.hide();_this.stage.toDataURL({quality:1,callback:function(e){if(t==="open"){s(e)}else{i(e)}_this.stage.width(o);_this.stage.height(u);_this.stage.scale({x:1,y:1});_this.stage.draw();a.remove();_this.target_element.show();_this.navigation_layer.show();_this.navigation_layer.draw();n.trigger("click")}})})}};InCHlib.prototype._color_scale_click=function(t,n){var r,i,s,o;var u={heatmap_colors:"Heatmap data colors"};var a={max_percentile:"Max percentile value",middle_percentile:"Middle percentile value",min_percentile:"Min percentile value"};if(_this.settings.metadata){u["metadata_colors"]="Metadata colors"}if(_this.settings.column_metadata){u["column_metadata_colors"]="Column metadata colors"}var f="settings_form_"+_this.settings.target;var l=e("#"+f);var c=_this._draw_target_overlay();if(l.length){l.fadeIn("fast")}else{l=e("<form class='settings_form' id='"+f+"'></form>");var h="",p,d,v;for(r=0,keys=Object.keys(u),len=keys.length;r<len;r++){s=keys[r];p=_this._get_color_for_value(0,0,1,.5,_this.settings[s]);d=_this._get_color_for_value(.5,0,1,.5,_this.settings[s]);v=_this._get_color_for_value(1,0,1,.5,_this.settings[s]);i="<div><div class='form_label'>"+u[s]+"</div><input type='text' name='"+s+"' value='"+_this.settings[s]+"'/> <div class='color_button' style='background: linear-gradient(to right, "+p+","+d+","+v+")'></div></div>";h+=i}for(r=0,keys=Object.keys(a),len=keys.length;r<len;r++){s=keys[r];i="<div><div class='form_label'>"+a[s]+"</div><input type='text' name='"+s+"' value='"+_this.settings[s]+"'/></div>";h+=i}i="<div><div class='form_label'>Heatmap coloring</div>                <select name='independent_columns'>";if(_this.settings.independent_columns){i+="<option value='true' selected>By columns</option>                  <option value='false'>Entire heatmap</option>"}else{i+="<option value='true'>By columns</option>                  <option value='false' selected>Entire heatmap</option>"}i+="</select></div>";h+=i;h=h+'<button type="submit">Redraw</button>';l.html(h);_this.target_element.append(l);l.css({"z-index":1e3,position:"absolute",top:110,left:0,padding:"10px",border:"solid #D2D2D2 2px","border-radius":"5px","background-color":"white"});e("#"+f+" .color_button").css({border:"solid #D2D2D2 1px",height:"15px",width:"30px",display:"inline-block"});e("#"+f+" > div").css({"font-size":"12px","margin-bottom":"10px"});e("#"+f+" input").css({"border-radius":"5px",width:"100px"});e("#"+f+" .form_label").css({color:"gray","margin-bottom":"5px","font-style":"italic"});e("#"+f+" button").css({"padding-top":"7px","padding-bottom":"5px","padding-right":"5px","padding-left":"5px",color:"white",border:"solid #D2D2D2 1px","border-radius":"5px",width:"100%","background-color":"#2171b5","font-weight":"bold"});c.click(function(){l.fadeOut("fast");c.fadeOut("fast")});var m=e("#"+f+" .color_button");m.hover(function(){e(this).css({cursor:"pointer",opacity:.7})},function(){e(this).css({opacity:1})});m.click(function(e){_this._draw_color_scales_select(this,e)});l.submit(function(t){var n={};var r=e(this).find("input, select");r.each(function(){i=e(this);s=i.attr("name");o=i.val();if(o!=""){if(o==="true"){o=true}else if(o==="false"){o=false}n[s]=o}});_this.update_settings(n);_this.redraw_heatmap();_this._update_color_scale();c.trigger("click");t.preventDefault();t.stopPropagation()})}};InCHlib.prototype._draw_color_scales_select=function(t,n){var r=_this.target_element.find(".color_scales");var i;if(r.length){r.fadeIn("fast");i=r.find(".color_scale")}else{r=e("<div class='color_scales'></div>");var s,o,u,a,f;for(var l=0,c=Object.keys(_this.colors),h=c.length;l<h;l++){f=c[l];o=_this._get_color_for_value(0,0,1,.5,f);u=_this._get_color_for_value(.5,0,1,.5,f);a=_this._get_color_for_value(1,0,1,.5,f);s="<div class='color_scale' data-scale_acronym='"+f+"' style='background: linear-gradient(to right, "+o+","+u+","+a+")'></div>";r.append(s)}_this.target_element.append(r);r.css({border:"solid #D2D2D2 2px","border-radius":"5px",padding:"5px",position:"absolute",top:110,left:170,"background-color":"white"});i=_this.target_element.find(".color_scale");i.css({"margin-top":"3px",width:"80px",height:"20px",border:"solid #D2D2D2 1px"});i.hover(function(){e(this).css({cursor:"pointer",opacity:.7})},function(){e(this).css({opacity:1})});_this.target_element.find(".target_overlay").click(function(){r.fadeOut("fast")})}i.on("click",function(){var n=e(this).attr("data-scale_acronym");var s=e(t).prev("input:first").val(n);e(t).css({background:"linear-gradient(to right, "+_this._get_color_for_value(0,0,1,.5,n)+","+_this._get_color_for_value(.5,0,1,.5,n)+","+_this._get_color_for_value(1,0,1,.5,n)+")"});r.fadeOut("fast");i.off("click")})};InCHlib.prototype._color_scale_mouseover=function(e,t){var n=e.getAttr("label");var r=e.getAttr("x");var i=e.getAttr("y");_this.icon_tooltip=_this.objects_ref.tooltip_label.clone({x:r,y:i+25});_this.icon_tooltip.add(_this.objects_ref.tooltip_tag.clone());_this.icon_tooltip.add(_this.objects_ref.tooltip_text.clone({text:n}));t.add(_this.icon_tooltip);_this.icon_tooltip.moveToTop();e.setOpacity(.7);t.draw()};InCHlib.prototype._color_scale_mouseout=function(e,t){_this.icon_tooltip.destroy();e.setOpacity(1);t.draw()};InCHlib.prototype._unzoom_icon_click=function(){_this._unzoom_cluster()};InCHlib.prototype._column_unzoom_icon_click=function(){_this._unzoom_column_cluster()};InCHlib.prototype._icon_mouseover=function(e,t,n){if(e.getAttr("id")!=="help_icon"){var r=e.getAttr("label");var i=t.getAttr("x");var s=t.getAttr("y");var o=t.getWidth();var u=t.getHeight();if(e.getAttr("id")==="export_icon"){i=i-100;s=s-50}_this.icon_tooltip=_this.objects_ref.tooltip_label.clone({x:i,y:s+1.2*u});_this.icon_tooltip.add(_this.objects_ref.tooltip_tag.clone());_this.icon_tooltip.add(_this.objects_ref.tooltip_text.clone({text:r}));n.add(_this.icon_tooltip)}e.setFill("black");n.draw()};InCHlib.prototype._icon_mouseout=function(e,t,n){if(e.getAttr("id")!=="help_icon"){_this.icon_tooltip.destroy()}e.setFill("grey");n.draw()};InCHlib.prototype._help_mouseover=function(){var t=_this.target_element.find(".inchlib_help");if(t.length){t.show()}else{t=e("<div class='inchlib_help'><ul><li>Zoom clusters by a long click (500 ms) on a dendrogram node.</li></ul></div>");t.css({position:"absolute",top:70,left:_this.settings.width-100,"font-size":12,width:200,"background-color":"white","border-radius":5,border:"solid #DEDEDE 2px","z-index":1e3});_this.target_element.append(t)}};InCHlib.prototype._help_mouseout=function(){_this.target_element.find(".inchlib_help").hide()};InCHlib.prototype._dendrogram_layers_click=function(e,t){var n=t.target.attrs.path_id;e.fire("mouseout",e,t);_this._highlight_cluster(n);_this.events.dendrogram_node_onclick(_this.current_object_ids,_this._unprefix(n),t)};InCHlib.prototype._column_dendrogram_layers_click=function(e,t){var n=t.target.attrs.path_id;e.fire("mouseout",e,t);_this._highlight_column_cluster(n);_this.events.column_dendrogram_node_onclick(_this.current_column_ids,_this._unprefix(n),t)};InCHlib.prototype._dendrogram_layers_mousedown=function(e,t){var n=t.target.attrs.path_id;clearTimeout(_this.timer);_this.timer=setTimeout(function(){_this._get_object_ids(n);_this._zoom_cluster(n)},500)};InCHlib.prototype._column_dendrogram_layers_mousedown=function(e,t){var n=t.target.attrs.path_id;clearTimeout(_this.timer);_this.timer=setTimeout(function(){_this._get_column_ids(n);_this._zoom_column_cluster(n)},500)};InCHlib.prototype._dendrogram_layers_mouseup=function(e,t){clearTimeout(_this.timer)};InCHlib.prototype._dendrogram_layers_mouseout=function(e,t){_this.path_overlay.destroy();_this.dendrogram_hover_layer.draw()};InCHlib.prototype._dendrogram_layers_mouseover=function(e,t){_this.path_overlay=t.target.attrs.path.clone({strokeWidth:4});_this.dendrogram_hover_layer.add(_this.path_overlay);_this.dendrogram_hover_layer.draw()};InCHlib.prototype._visible_features_equal_column_dendrogram_count=function(){if(_this.on_features["data"].length+_this.on_features["metadata"].length==_this.current_column_count){return true}return false};InCHlib.prototype._get_color_for_value=function(e,t,n,r,i){var s=_this.colors[i];var o=s["start"];var u=s["end"];if(e>n){return"rgb("+u.r+","+u.g+","+u.b+")"}if(t==n||e<t){return"rgb("+o.r+","+o.g+","+o.b+")"}if(s["middle"]!==undefined){if(e>=r){t=r;o=s["middle"];u=s["end"]}else{n=r;o=s["start"];u=s["middle"]}}var a=(e-t)/(n-t);var f=_this._hack_round(o.r+a*(u.r-o.r));var l=_this._hack_round(o.g+a*(u.g-o.g));var c=_this._hack_round(o.b+a*(u.b-o.b));return"rgb("+f+","+l+","+c+")"};InCHlib.prototype._get_font_size=function(e,t,n,r){var i=n-2;var s=i;if(s/2*e>t-10){s=s/(s/2*e/(t-10))}s=s>i?i:s;s=s>r?r:s;return s};InCHlib.prototype._get_object_ids=function(e){_this.current_object_ids=[];_this._collect_object_ids(e)};InCHlib.prototype._collect_object_ids=function(e){if(_this.data.nodes[e]["left_child"]!==undefined){_this._collect_object_ids(_this.data.nodes[e]["left_child"]);_this._collect_object_ids(_this.data.nodes[e]["right_child"])}else{_this.current_object_ids.push.apply(_this.current_object_ids,_this.data.nodes[e]["objects"])}};InCHlib.prototype._get_column_ids=function(e){_this.current_column_ids=[];_this._collect_column_ids(e);_this.current_column_ids.sort(function(e,t){return e-t})};InCHlib.prototype._collect_column_ids=function(e){if(_this.column_dendrogram.nodes[e]["left_child"]!==undefined){_this._collect_column_ids(_this.column_dendrogram.nodes[e]["left_child"]);_this._collect_column_ids(_this.column_dendrogram.nodes[e]["right_child"])}else{_this.current_column_ids.push(_this.nodes2columns[e])}};InCHlib.prototype._hack_size=function(e){return Object.keys(e).length};InCHlib.prototype._hack_round=function(e){return.5+e>>0};InCHlib.prototype._is_number=function(e){return!isNaN(parseFloat(e))&&isFinite(e)};InCHlib.prototype._row_mouseenter=function(e){var t=e.target.parent.getAttr("id");var n=_this._get_visible_count();if(e.target.parent.attrs.class!=="column_metadata"){_this.highlighted_row=t;var r=_this.leaves_y_coordinates[t];var i=_this.heatmap_distance;_this.row_overlay=_this.objects_ref.heatmap_line.clone({points:[i,r,i+_this.heatmap_width,r],strokeWidth:_this.pixels_for_leaf,stroke:"#FFFFFF",opacity:.3,listening:false});_this.heatmap_overlay.add(_this.row_overlay);_this.heatmap_overlay.draw();_this.events.row_onmouseover(_this.data.nodes[t].objects,e)}};InCHlib.prototype._row_mouseleave=function(e){_this.row_overlay.destroy();_this.events.row_onmouseout(e)};InCHlib.prototype._draw_col_label=function(e){var t,n;var r=e.target.attrs;var i=r.points;var s=_this._hack_round((i[0]+i[2])/2);var o=i[1]-.5*_this.pixels_for_leaf;var u=r.column.split("_");var a={d:_this.heatmap_header[u[1]],m:_this.metadata_header[u[1]],Count:"Count"};if(_this.column_metadata_header!==undefined){a["cm"]=_this.column_metadata_header[u[1]]}var f=r.value;var l=a[u[0]];if(l!==_this.last_column){_this.column_overlay.destroy();_this.last_column=r.column;_this.column_overlay=_this.objects_ref.heatmap_line.clone({points:[s,_this.header_height,s,_this.header_height+_this.column_metadata_height+(_this.heatmap_array.length+.5)*_this.pixels_for_leaf],strokeWidth:_this.pixels_for_dimension,stroke:"#FFFFFF",opacity:.3,listening:false});_this.heatmap_overlay.add(_this.column_overlay)}if(l!==undefined){f=[l,f].join("\n")}var c=_this.objects_ref.tooltip_label.clone({x:s,y:o,id:"col_label"});c.add(_this.objects_ref.tooltip_tag.clone({pointerDirection:"down"}),_this.objects_ref.tooltip_text.clone({text:f}));_this.heatmap_overlay.add(c);_this.heatmap_overlay.moveToTop();_this.heatmap_overlay.draw()};InCHlib.prototype._unprefix=function(e){return e.split(_this.settings.target+"#")[1]};InCHlib.prototype._prefix=function(e){return _this.settings.target+"#"+e};InCHlib.prototype.get_features_for_object=function(e){if(_this.objects2leaves[e]!==undefined){var t=_this.objects2leaves[e];return _this.data.nodes[t].features}return false};InCHlib.prototype.add_color_scale=function(e,t){_this.colors[e]=t;_this.target_element.find(".color_scales").remove()};InCHlib.prototype._get_visible_count=function(){return _this.on_features["data"].length+_this.on_features["metadata"].length+_this.on_features["count_column"].length};InCHlib.prototype.update_settings=function(t){e.extend(_this.settings,t)};InCHlib.prototype.redraw=function(){_this._delete_all_layers();_this.draw()};InCHlib.prototype.redraw_heatmap=function(){_this._delete_layers([_this.heatmap_layer,_this.heatmap_overlay,_this.highlighted_rows_layer,_this.header_layer]);_this._set_color_settings();_this._draw_heatmap();_this._draw_heatmap_header();_this.heatmap_layer.moveToBottom();_this.heatmap_layer.moveUp()}})(jQuery)